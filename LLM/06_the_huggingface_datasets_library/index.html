<!doctype html><html lang=ja class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hugging Face Datasetsライブラリを使用したデータセットの読み込み、前処理、保存、そしてFAISSを使った意味検索システムの構築まで、実践的な使い方を詳しく解説します。"><meta name=author content=vinsmoke-three><link href=https://vinsmoke-three.com/LLM/06_the_huggingface_datasets_library/ rel=canonical><link href=../05_Let%27s_build_GPT_from_scratch/ rel=prev><link href=../ClassicalNLP/71_token_classification/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.20"><title>Hugging Face Datasetsライブラリの完全ガイド：ローカルデータから大規模データセットまで - vinsmoke-three - 機械学習・深層学習ドキュメント</title><link rel=stylesheet href=../../assets/stylesheets/main.e53b48f4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-BXKYE0NT9N"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-BXKYE0NT9N",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-BXKYE0NT9N",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#hugging-face-datasets class=md-skip> コンテンツにスキップ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=ヘッダー> <a href=../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-header__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> vinsmoke-three - 機械学習・深層学習ドキュメント </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Hugging Face Datasetsライブラリの完全ガイド：ローカルデータから大規模データセットまで </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=検索 placeholder=検索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=検索> <a href=javascript:void(0) class="md-search__icon md-icon" title=共有 aria-label=共有 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=クリア aria-label=クリア tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 検索を初期化 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=タブ data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../PyTorch/00_setup/ class=md-tabs__link> PyTorch </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../00_illustrated_transformer/ class=md-tabs__link> LLM </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=ナビゲーション data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-nav__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> vinsmoke-three - 機械学習・深層学習ドキュメント </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> PyTorch </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> PyTorch </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../PyTorch/00_setup/ class=md-nav__link> <span class=md-ellipsis> 0. setup </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/01_pytorch_fundamentals/ class=md-nav__link> <span class=md-ellipsis> 1. PyTorch fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/02_pytorch_workflow/ class=md-nav__link> <span class=md-ellipsis> 2. PyTorch workflow </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/03_pytorch_classification/ class=md-nav__link> <span class=md-ellipsis> 3. PyTorch classification </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/04_pytorch_computer_vision/ class=md-nav__link> <span class=md-ellipsis> 4. PyTorch computer vision </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/05_pytorch_custom_datasets/ class=md-nav__link> <span class=md-ellipsis> 5. PyTorch custom datasets </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/06_pytorch_modular/ class=md-nav__link> <span class=md-ellipsis> 6. PyTorch modular </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/07_pytorch_transfer_learning/ class=md-nav__link> <span class=md-ellipsis> 7. PyTorch transfer learning </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/08_pytorch_experiment_tracking/ class=md-nav__link> <span class=md-ellipsis> 8. PyTorch experiment tracking </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/09_pytorch_paper_replicating/ class=md-nav__link> <span class=md-ellipsis> 9. PyTorch paper replicating </span> </a> </li> <li class=md-nav__item> <a href=../../PyTorch/10_pytorch_model_deployment/ class=md-nav__link> <span class=md-ellipsis> 10. PyTorch model deployment </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> LLM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LLM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../00_illustrated_transformer/ class=md-nav__link> <span class=md-ellipsis> 0. The illustrated transformer </span> </a> </li> <li class=md-nav__item> <a href=../01_transformer_models/ class=md-nav__link> <span class=md-ellipsis> 1. Transformer models </span> </a> </li> <li class=md-nav__item> <a href=../02_using_transformers/ class=md-nav__link> <span class=md-ellipsis> 2. Using transformers </span> </a> </li> <li class=md-nav__item> <a href=../03_fine_tuning_a_pretrained_model/ class=md-nav__link> <span class=md-ellipsis> 3. Fine-tuning a pretrained model </span> </a> </li> <li class=md-nav__item> <a href=../04_the_huggingface_tokenizers_library/ class=md-nav__link> <span class=md-ellipsis> 4. Tokenizers library </span> </a> </li> <li class=md-nav__item> <a href=../05_Let%27s_build_GPT_from_scratch/ class=md-nav__link> <span class=md-ellipsis> 5. Let't build GPT from scratch </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 6. Datasets library </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 6. Datasets library </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#hub class=md-nav__link> <span class=md-ellipsis> データセットがHubにない場合の対処法 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> データのスライスと処理 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 独自データセットの作成 </span> </a> </li> <li class=md-nav__item> <a href=#faiss class=md-nav__link> <span class=md-ellipsis> FAISSを使った意味検索 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 次のステップ </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex=0> <span class=md-ellipsis> 7. Classical NLP Tasks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> 7. Classical NLP Tasks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ClassicalNLP/71_token_classification/ class=md-nav__link> <span class=md-ellipsis> Token Classification </span> </a> </li> <li class=md-nav__item> <a href=../ClassicalNLP/72_masked_language_modeling/ class=md-nav__link> <span class=md-ellipsis> Masked Language Modeling </span> </a> </li> <li class=md-nav__item> <a href=../ClassicalNLP/73_translation/ class=md-nav__link> <span class=md-ellipsis> Translation </span> </a> </li> <li class=md-nav__item> <a href=../ClassicalNLP/74_summarization/ class=md-nav__link> <span class=md-ellipsis> Summarization </span> </a> </li> <li class=md-nav__item> <a href=../ClassicalNLP/75_question_answering/ class=md-nav__link> <span class=md-ellipsis> Question Answering </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#hub class=md-nav__link> <span class=md-ellipsis> データセットがHubにない場合の対処法 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> データのスライスと処理 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 独自データセットの作成 </span> </a> </li> <li class=md-nav__item> <a href=#faiss class=md-nav__link> <span class=md-ellipsis> FAISSを使った意味検索 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 次のステップ </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=hugging-face-datasets>Hugging Face Datasetsライブラリの完全ガイド<a class=headerlink href=#hugging-face-datasets title="Permanent link">&para;</a></h1> <h2 id=_1>概要<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>この記事では、Hugging Face Datasetsライブラリを深く掘り下げ、以下の重要な質問に答えていきます：</p> <ul> <li>データセットがHubにない場合はどうすればよいか？</li> <li>データセットをどのようにスライスや操作するか？（Pandasを使う必要がある場合は？）</li> <li>独自のデータセットを作成するにはどうすればよいか？</li> </ul> <div class="admonition info"> <p class=admonition-title>参考資料</p> <p>本ドキュメントは <a href=https://huggingface.co/learn/llm-course/chapter5/1>Hugging Face LLM Course</a> を参考に、日本語で学習内容をまとめた個人的な学習ノートです。詳細な内容や最新情報については、原文も併せてご参照ください。</p> </div> <h2 id=_2>前提知識<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>この記事を理解するには、以下の知識が必要です：</p> <ul> <li>Pythonプログラミングの基本</li> <li>pandasライブラリの基本的な使い方</li> <li>機械学習の基本概念</li> <li>Hugging Face Transformersライブラリの基本的な使い方</li> </ul> <h2 id=hub>データセットがHubにない場合の対処法<a class=headerlink href=#hub title="Permanent link">&para;</a></h2> <p><a href=https://huggingface.co/datasets>Hugging Face Hub</a>からデータセットをダウンロードする方法は既に学習済みです。しかし、実際にはラップトップやリモートサーバーに保存されたデータを扱うことが多いでしょう。</p> <p>このセクションでは、Hugging Face Hubで利用できないデータセットをHugging Face Datasetsで読み込む方法を説明します。</p> <h3 id=_3>ローカルおよびリモートデータセットの操作<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th style="text-align: center;">データ形式</th> <th style="text-align: center;">ローディングスクリプト</th> <th style="text-align: center;">例</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">CSV &amp; TSV</td> <td style="text-align: center;"><code>csv</code></td> <td style="text-align: center;"><code>load_dataset("csv", data_files="my_file.csv")</code></td> </tr> <tr> <td style="text-align: center;">テキストファイル</td> <td style="text-align: center;"><code>text</code></td> <td style="text-align: center;"><code>load_dataset("text", data_files="my_file.txt")</code></td> </tr> <tr> <td style="text-align: center;">JSON &amp; JSON Lines</td> <td style="text-align: center;"><code>json</code></td> <td style="text-align: center;"><code>load_dataset("json", data_files="my_file.jsonl")</code></td> </tr> <tr> <td style="text-align: center;">Pickle形式のDataFrames</td> <td style="text-align: center;"><code>pandas</code></td> <td style="text-align: center;"><code>load_dataset("pandas", data_files="my_dataframe.pkl")</code></td> </tr> </tbody> </table> <p>上の表に示すように、各データ形式に対応する方法は非常にシンプルです。<code>load_dataset()</code>関数でローディングスクリプトの種類を指定し、<code>data_files</code>引数で1つまたは複数のファイルパスを指定するだけで読み込めます。まずはローカルファイルからデータセットを読み込み、その後リモートファイルで同じことを行う方法を見てみましょう。</p> <h3 id=_4>ローカルデータセットの読み込み<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>この例では、イタリア語での質問応答の大規模データセットである<a href=https://github.com/crux82/squad-it/ >SQuAD-itデータセット</a>を使用します。</p> <p>トレーニングとテストの分割がGitHubでホストされているので、シンプルな<code>wget</code>コマンドでダウンロードできます：</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># GitHubからSQuAD-itデータセットのファイルをダウンロード</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>wget<span class=w> </span>https://github.com/crux82/squad-it/raw/master/SQuAD_it-train.json.gz
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>wget<span class=w> </span>https://github.com/crux82/squad-it/raw/master/SQuAD_it-test.json.gz
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>SQuAD_it-train.json 100%[===================&gt;]   7.37M  6.87MB/s 時間 1.1s       
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>2025-09-05 20:03:03 (6.87 MB/s) - `SQuAD_it-train.json.gz&#39; へ保存完了 [7725286/7725286]
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>SQuAD_it-test.json. 100%[===================&gt;]   1.00M  3.13MB/s 時間 0.3s       
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>2025-09-05 20:03:04 (3.13 MB/s) - `SQuAD_it-test.json.gz&#39; へ保存完了 [1051245/1051245]
</span></code></pre></div></p> <p>これにより、<em>SQuAD_it-train.json.gz</em>と<em>SQuAD_it-test.json.gz</em>という2つの圧縮ファイルがダウンロードされます。これらはLinuxの<code>gzip</code>コマンドで解凍できます：</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># 圧縮ファイルを解凍（-d: 解凍、-k: 元ファイル保持、-v: 詳細表示）</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>gzip<span class=w> </span>-dkv<span class=w> </span>SQuAD_it-*.json.gz
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>SQuAD_it-test.json.gz:     87.4% -- replaced with SQuAD_it-test.json
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>SQuAD_it-train.json.gz:    82.2% -- replaced with SQuAD_it-train.json
</span></code></pre></div></p> <p>圧縮ファイルが_SQuAD_it-train.json_と_SQuAD_it-test.json_に置き換えられ、データがJSON形式で保存されていることがわかります。</p> <p><code>load_dataset()</code>関数でJSONファイルを読み込むには、通常のJSON（ネストした辞書のような）かJSON Lines（行区切りJSON）のどちらを扱っているかを知る必要があります。多くの質問応答データセットと同様に、SQuAD-itはネスト構造を採用しており、すべてのテキストが<code>data</code>フィールドに保存されています。つまり、以下のように<code>field</code>引数を指定してデータセットを読み込むことができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># DatasetsライブラリからJSONデータセットを読み込み</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_dataset</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=c1># JSONファイルを読み込み、dataフィールドを指定</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=n>squad_it_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;json&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=s2>&quot;SQuAD_it-train.json&quot;</span><span class=p>,</span> <span class=n>field</span><span class=o>=</span><span class=s2>&quot;data&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>デフォルトでは、ローカルファイルの読み込みは<code>train</code>分割を持つ<code>DatasetDict</code>オブジェクトを作成します。<code>squad_it_dataset</code>オブジェクトを調べることでこれを確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># データセットの構造を確認</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=n>squad_it_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>DatasetDict({
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    train: Dataset({
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>        features: [&#39;title&#39;, &#39;paragraphs&#39;],
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>        num_rows: 442
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>    })
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>})
</span></code></pre></div></p> <p>これにより、行数とトレーニングセットに関連する列名が表示されます。以下のようにして<code>train</code>分割にインデックスを付けることで、例の1つを表示できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># トレーニングセットの最初の例を表示</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=n>squad_it_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=p>{</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=s2>&quot;title&quot;</span><span class=p>:</span> <span class=s2>&quot;Terremoto del Sichuan del 2008&quot;</span><span class=p>,</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=s2>&quot;paragraphs&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=p>{</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>            <span class=s2>&quot;context&quot;</span><span class=p>:</span> <span class=s2>&quot;Il terremoto del Sichuan del 2008 o il terremoto...&quot;</span><span class=p>,</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>            <span class=s2>&quot;qas&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>                <span class=p>{</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>                    <span class=s2>&quot;answers&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;answer_start&quot;</span><span class=p>:</span> <span class=mi>29</span><span class=p>,</span> <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=s2>&quot;2008&quot;</span><span class=p>}],</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>                    <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;56cdca7862d2951400fa6826&quot;</span><span class=p>,</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>                    <span class=s2>&quot;question&quot;</span><span class=p>:</span> <span class=s2>&quot;In quale anno si è verificato il terremoto nel Sichuan?&quot;</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>                <span class=p>},</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>                <span class=o>...</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>            <span class=p>],</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>        <span class=p>},</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>        <span class=o>...</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>    <span class=p>],</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=p>}</span>
</span></code></pre></div></p> <p>素晴らしい！最初のローカルデータセットを読み込みました！しかし、これはトレーニングセットでは機能しましたが、実際に欲しいのは、<code>Dataset.map()</code>関数を両方の分割に一度に適用できるように、<code>train</code>と<code>test</code>の両方の分割を単一の<code>DatasetDict</code>オブジェクトに含めることです。これを行うには、各分割名をその分割に関連するファイルにマップする辞書を<code>data_files</code>引数に提供できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># トレーニングとテストデータを含む辞書を作成</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=n>data_files</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=s2>&quot;SQuAD_it-train.json&quot;</span><span class=p>,</span> <span class=s2>&quot;test&quot;</span><span class=p>:</span> <span class=s2>&quot;SQuAD_it-test.json&quot;</span><span class=p>}</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=n>squad_it_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;json&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=n>data_files</span><span class=p>,</span> <span class=n>field</span><span class=o>=</span><span class=s2>&quot;data&quot;</span><span class=p>)</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=n>squad_it_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>DatasetDict({
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>    train: Dataset({
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>        features: [&#39;title&#39;, &#39;paragraphs&#39;],
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>        num_rows: 442
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>    })
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>    test: Dataset({
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>        features: [&#39;title&#39;, &#39;paragraphs&#39;],
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>        num_rows: 48
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>    })
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>})
</span></code></pre></div></p> <p>Hugging Face Datasetsのローディングスクリプトは、実際には入力ファイルの自動解凍をサポートしているため、圧縮ファイルに直接<code>data_files</code>引数を指定することで、<code>gzip</code>の使用をスキップできました：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># 圧縮ファイルを直接指定（自動解凍される）</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>data_files</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=s2>&quot;SQuAD_it-train.json.gz&quot;</span><span class=p>,</span> <span class=s2>&quot;test&quot;</span><span class=p>:</span> <span class=s2>&quot;SQuAD_it-test.json.gz&quot;</span><span class=p>}</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=n>squad_it_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;json&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=n>data_files</span><span class=p>,</span> <span class=n>field</span><span class=o>=</span><span class=s2>&quot;data&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>これは、多くのGZIPファイルを手動で解凍したくない場合に便利です。自動解凍は、ZIPやTARなどの他の一般的な形式にも適用されるため、圧縮ファイルに<code>data_files</code>を指定するだけで準備完了です！</p> <h3 id=_5>リモートデータセットの読み込み<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>会社でデータサイエンティストやプログラマーとして働いている場合、分析したいデータセットはリモートサーバーに保存されていることが多いでしょう。幸いにも、リモートファイルの読み込みはローカルファイルの読み込みと同等に簡単です！ローカルファイルのパスの代わりに、<code>load_dataset()</code>の<code>data_files</code>引数でリモートファイルが保存されている1つまたは複数のURLを指定します。例えば、GitHubでホストされているSQuAD-itデータセットの場合、以下のように<code>data_files</code>を_SQuAD_it-*.json.gz_ URLに指定できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># リモートURLから直接データセットを読み込み</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=n>url</span> <span class=o>=</span> <span class=s2>&quot;https://github.com/crux82/squad-it/raw/master/&quot;</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=n>data_files</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>    <span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=n>url</span> <span class=o>+</span> <span class=s2>&quot;SQuAD_it-train.json.gz&quot;</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=s2>&quot;test&quot;</span><span class=p>:</span> <span class=n>url</span> <span class=o>+</span> <span class=s2>&quot;SQuAD_it-test.json.gz&quot;</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=p>}</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=n>squad_it_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;json&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=n>data_files</span><span class=p>,</span> <span class=n>field</span><span class=o>=</span><span class=s2>&quot;data&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>これは上記で取得したのと同じ<code>DatasetDict</code>オブジェクトを返しますが、_SQuAD_it-*.json.gz_ファイルを手動でダウンロードして解凍するステップを省略できます。これで、Hugging Face Hubでホストされていないデータセットを読み込むさまざまな方法の探索を終えます。作業に使うデータセットができたので、さまざまなデータ処理テクニックを実際に試してみましょう！</p> <h2 id=_6>データのスライスと処理<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <p>ほとんどの場合、作業するデータはモデルの訓練に完璧に準備されていません。このセクションでは、Hugging Face Datasetsがデータセットをクリーンアップするために提供するさまざまな機能を探索します。</p> <h3 id=_7>データのスライスと処理<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>Pandasと同様に、Hugging Face Datasetsは<code>Dataset</code>と<code>DatasetDict</code>オブジェクトの内容を操作するためのいくつかの関数を提供します。このセクションでは、利用可能なその他の関数について探索します。</p> <p>この例では、<a href=https://archive.ics.uci.edu/ml/index.php>UC Irvine機械学習リポジトリ</a>でホストされている<a href=https://archive.ics.uci.edu/ml/datasets/Drug+Review+Dataset+%28Drugs.com%29>Drug Review Dataset</a>を使用します。これには、治療対象の症状と患者の満足度の10段階評価とともに、さまざまな薬物に関する患者レビューが含まれています。</p> <p>まず、データをダウンロードして抽出する必要があります。これは<code>wget</code>と<code>unzip</code>コマンドで実行できます：</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># Drug ReviewデータセットのダウンロードとZIPファイルの解凍</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>wget<span class=w> </span><span class=s2>&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/00462/drugsCom_raw.zip&quot;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>unzip<span class=w> </span>drugsCom_raw.zip
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>drugsCom_raw.zip        [        &lt;=&gt;         ]  41.00M  2.88MB/s 時間 16s        
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>2025-09-05 20:18:09 (2.63 MB/s) - `drugsCom_raw.zip&#39; へ保存終了 [42989872]
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>Archive:  drugsCom_raw.zip
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>  inflating: drugsComTest_raw.tsv    
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>  inflating: drugsComTrain_raw.tsv   
</span></code></pre></div></p> <p>TSVはコンマではなくタブ文字を区切り文字として使用するCSVの変種であるため、以下のように<code>load_dataset()</code>関数で<code>csv</code>ローディングスクリプトを使用し、<code>delimiter</code>引数を指定してこれらのファイルを読み込むことができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># DatasetsライブラリでTSVファイルを読み込み</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_dataset</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=c1># \tはPythonでのタブ文字</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=n>data_files</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=s2>&quot;drugsComTrain_raw.tsv&quot;</span><span class=p>,</span> <span class=s2>&quot;test&quot;</span><span class=p>:</span> <span class=s2>&quot;drugsComTest_raw.tsv&quot;</span><span class=p>}</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;csv&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=n>data_files</span><span class=p>,</span> <span class=n>delimiter</span><span class=o>=</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>データ分析を行う際の良い慣行は、扱うデータの特性を迅速に理解するために小さなランダムサンプルを取得することです。Hugging Face Datasetsでは、<code>Dataset.shuffle()</code>と<code>Dataset.select()</code>関数を連鎖させることでランダムサンプルを作成できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># ランダムサンプルを作成してデータの最初の数例を確認</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=n>drug_sample</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=c1># 最初の数例を覗いてみる</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=n>drug_sample</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>{&#39;Unnamed: 0&#39;: [87571, 178045, 80482],
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a> &#39;drugName&#39;: [&#39;Naproxen&#39;, &#39;Duloxetine&#39;, &#39;Mobic&#39;],
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a> &#39;condition&#39;: [&#39;Gout, Acute&#39;, &#39;ibromyalgia&#39;, &#39;Inflammatory Conditions&#39;],
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a> &#39;review&#39;: [&#39;&quot;like the previous person mention, I&amp;#039;m a strong believer of aleve, it works faster for my gout than the prescription meds I take. No more going to the doctor for refills.....Aleve works!&quot;&#39;,
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>  &#39;&quot;I have taken Cymbalta for about a year and a half for fibromyalgia pain. It is great\r\nas a pain reducer and an anti-depressant, however, the side effects outweighed \r\nany benefit I got from it. I had trouble with restlessness, being tired constantly,\r\ndizziness, dry mouth, numbness and tingling in my feet, and horrible sweating. I am\r\nbeing weaned off of it now. Went from 60 mg to 30mg and now to 15 mg. I will be\r\noff completely in about a week. The fibro pain is coming back, but I would rather deal with it than the side effects.&quot;&#39;,
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>  &#39;&quot;I have been taking Mobic for over a year with no side effects other than an elevated blood pressure.  I had severe knee and ankle pain which completely went away after taking Mobic.  I attempted to stop the medication however pain returned after a few days.&quot;&#39;],
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a> &#39;rating&#39;: [9.0, 3.0, 10.0],
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a> &#39;date&#39;: [&#39;September 2, 2015&#39;, &#39;November 7, 2011&#39;, &#39;June 5, 2013&#39;],
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a> &#39;usefulCount&#39;: [36, 13, 128]}
</span></code></pre></div></p> <p>再現性のために<code>Dataset.shuffle()</code>でシードを固定していることに注意してください。<code>Dataset.select()</code>は反復可能なインデックスを期待するため、シャッフルされたデータセットから最初の1,000例を取得するために<code>range(1000)</code>を渡しました。このサンプルから、データセットにはすでにいくつかの特性があることがわかります：</p> <ul> <li><code>Unnamed: 0</code>列は各患者の匿名化IDのように見えます。</li> <li><code>condition</code>列には大文字と小文字が混在したラベルが含まれています。</li> <li>レビューの長さはさまざまで、Pythonの改行区切り文字（<code>\r\n</code>）やHTML文字コード（<code>&amp;#039;</code>など）が混在しています。</li> </ul> <p>Hugging Face Datasetsを使用してこれらの問題のそれぞれに対処する方法を見てみましょう。<code>Unnamed: 0</code>列の患者ID仮説をテストするために、<code>Dataset.unique()</code>関数を使用して、IDの数が各分割の行数と一致することを確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># 各分割でユニークIDの数が総行数と一致することを確認</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>for</span> <span class=n>split</span> <span class=ow>in</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>drug_dataset</span><span class=p>[</span><span class=n>split</span><span class=p>])</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>drug_dataset</span><span class=p>[</span><span class=n>split</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=s2>&quot;Unnamed: 0&quot;</span><span class=p>))</span>
</span></code></pre></div> <p>これで仮説が確認されたようです。<code>DatasetDict.rename_column()</code>関数を使用して、列をより解釈しやすいものに名前変更し、データセットを少しクリーンアップしましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1># 列名をより意味のあるものに変更</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>rename_column</span><span class=p>(</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>    <span class=n>original_column_name</span><span class=o>=</span><span class=s2>&quot;Unnamed: 0&quot;</span><span class=p>,</span> <span class=n>new_column_name</span><span class=o>=</span><span class=s2>&quot;patient_id&quot;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=p>)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=n>drug_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>DatasetDict({
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>    train: Dataset({
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;],
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>        num_rows: 161297
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>    })
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>    test: Dataset({
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;],
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>        num_rows: 53766
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>    })
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>})
</span></code></pre></div></p> <p>次に、<code>Dataset.map()</code>を使用してすべての<code>condition</code>ラベルを正規化しましょう。<code>drug_dataset</code>内の各分割のすべての行に適用できる簡単な関数を定義できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1># 症状名を小文字に変換する関数</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>def</span><span class=w> </span><span class=nf>lowercase_condition</span><span class=p>(</span><span class=n>example</span><span class=p>):</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;condition&quot;</span><span class=p>:</span> <span class=n>example</span><span class=p>[</span><span class=s2>&quot;condition&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()}</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>lowercase_condition</span><span class=p>)</span> <span class=c1># AttributeError: &#39;NoneType&#39; object has no attribute &#39;lower&#39;</span>
</span></code></pre></div> <p>おっと、map関数で問題が発生しました！エラーから、<code>condition</code>列の一部のエントリが<code>None</code>であり、文字列ではないため小文字に変換できないことが推測できます。<code>Dataset.filter()</code>を使用してこれらの行を削除しましょう。これは<code>Dataset.map()</code>と同様に動作し、データセットの単一の例を受け取る関数を期待します。以下のような明示的な関数を書く代わりに：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># None値をフィルタリングする関数（明示的バージョン）</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=k>def</span><span class=w> </span><span class=nf>filter_nones</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>    <span class=k>return</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;condition&quot;</span><span class=p>]</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></code></pre></div> <p>そして<code>drug_dataset.filter(filter_nones)</code>を実行する代わりに、_ラムダ関数_を使用して1行でこれを実行できます。Pythonでは、ラムダ関数は明示的に名前を付けることなく定義できる小さな関数です。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=c1># None値を含む行をフィルタリング</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;condition&quot;</span><span class=p>]</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>Filter: 100%|██████████| 160398/160398 [00:01&lt;00:00, 130404.65 examples/s]
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>Filter: 100%|██████████| 53471/53471 [00:00&lt;00:00, 135494.43 examples/s]
</span></code></pre></div></p> <p><code>None</code>エントリが削除されたので、<code>condition</code>列を正規化できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># 症状名を小文字に正規化</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>lowercase_condition</span><span class=p>)</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=c1># 小文字化が機能したことを確認</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=s2>&quot;condition&quot;</span><span class=p>][:</span><span class=mi>3</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>Map: 100%|██████████| 160398/160398 [00:05&lt;00:00, 31554.40 examples/s]
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>Map: 100%|██████████| 53471/53471 [00:01&lt;00:00, 31674.86 examples/s]
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>[&#39;left ventricular dysfunction&#39;, &#39;adhd&#39;, &#39;birth control&#39;]
</span></code></pre></div></p> <p>動作しました！ラベルをクリーンアップしたので、次はレビュー自体をクリーンアップしてみましょう。</p> <h3 id=_8>新しい列の作成<a class=headerlink href=#_8 title="Permanent link">&para;</a></h3> <p>顧客レビューを扱う場合、各レビューの単語数を確認することは良い慣行です。レビューは「Great!」のような単一の単語かもしれませんし、数千単語の本格的なエッセイかもしれません。ユースケースに応じて、これらの極端なケースを異なって処理する必要があります。各レビューの単語数を計算するために、各テキストを空白で分割することに基づく大まかなヒューリスティックを使用します。</p> <p>各レビューの単語数をカウントする簡単な関数を定義しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1># レビューの単語数を計算する関数</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=k>def</span><span class=w> </span><span class=nf>compute_review_length</span><span class=p>(</span><span class=n>example</span><span class=p>):</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;review_length&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>example</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>())}</span>
</span></code></pre></div> <p><code>lowercase_condition()</code>関数とは異なり、<code>compute_review_length()</code>はデータセットの列名の1つに対応しないキーを持つ辞書を返します。この場合、<code>compute_review_length()</code>が<code>Dataset.map()</code>に渡されると、データセットのすべての行に適用され、新しい<code>review_length</code>列が作成されます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># レビューの長さ情報を含む新しい列を追加</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>compute_review_length</span><span class=p>)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=c1># 最初のトレーニング例を調査</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>Map: 100%|██████████| 160398/160398 [00:04&lt;00:00, 36199.78 examples/s]
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>Map: 100%|██████████| 53471/53471 [00:01&lt;00:00, 36566.94 examples/s]
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>{&#39;patient_id&#39;: 206461,
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a> &#39;drugName&#39;: &#39;Valsartan&#39;,
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a> &#39;condition&#39;: &#39;left ventricular dysfunction&#39;,
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a> &#39;review&#39;: &#39;&quot;It has no side effect, I take it in combination of Bystolic 5 Mg and Fish Oil&quot;&#39;,
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a> &#39;rating&#39;: 9.0,
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a> &#39;date&#39;: &#39;May 20, 2012&#39;,
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a> &#39;usefulCount&#39;: 27,
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a> &#39;review_length&#39;: 17}
</span></code></pre></div></p> <p>期待通り、<code>review_length</code>列がトレーニングセットに追加されたことがわかります。<code>Dataset.sort()</code>でこの新しい列をソートして、極値がどのようなものかを確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1># レビューの長さでソートして短いレビューを確認</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=s2>&quot;review_length&quot;</span><span class=p>)[:</span><span class=mi>3</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>{&#39;patient_id&#39;: [111469, 13653, 53602],
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a> &#39;drugName&#39;: [&#39;Ledipasvir / sofosbuvir&#39;,
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>  &#39;Amphetamine / dextroamphetamine&#39;,
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>  &#39;Alesse&#39;],
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a> &#39;condition&#39;: [&#39;hepatitis c&#39;, &#39;adhd&#39;, &#39;birth control&#39;],
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a> &#39;review&#39;: [&#39;&quot;Headache&quot;&#39;, &#39;&quot;Great&quot;&#39;, &#39;&quot;Awesome&quot;&#39;],
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a> &#39;rating&#39;: [10.0, 10.0, 10.0],
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a> &#39;date&#39;: [&#39;February 3, 2015&#39;, &#39;October 20, 2009&#39;, &#39;November 23, 2015&#39;],
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a> &#39;usefulCount&#39;: [41, 3, 0],
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a> &#39;review_length&#39;: [1, 1, 1]}
</span></code></pre></div></p> <p>予想通り、一部のレビューには単語が1つしか含まれていません。これは感情分析には問題ないかもしれませんが、症状を予測したい場合は情報になりません。</p> <p><code>Dataset.filter()</code>関数を使用して、30語未満のレビューを削除しましょう。<code>condition</code>列で行ったのと同様に、レビューがこのしきい値を超える長さを要求することで、非常に短いレビューをフィルタリングできます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1># 30語未満の短いレビューをフィルタリング</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;review_length&quot;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>30</span><span class=p>)</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=nb>print</span><span class=p>(</span><span class=n>drug_dataset</span><span class=o>.</span><span class=n>num_rows</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>Filter: 100%|██████████| 160398/160398 [00:00&lt;00:00, 357531.63 examples/s]
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>Filter: 100%|██████████| 53471/53471 [00:00&lt;00:00, 374090.52 examples/s]
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>{&#39;train&#39;: 138514, &#39;test&#39;: 46108}
</span></code></pre></div></p> <p>ご覧のとおり、これにより元のトレーニングセットとテストセットから約15%のレビューが削除されました。</p> <p>最後に対処する必要があるのは、レビューにHTML文字コードが存在することです。Pythonの<code>html</code>モジュールを使用して、以下のようにこれらの文字をアンエスケープできます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1># HTML文字コードをアンエスケープ</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=kn>import</span><span class=w> </span><span class=nn>html</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=n>text</span> <span class=o>=</span> <span class=s2>&quot;I&amp;#039;m a transformer called BERT&quot;</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>&quot;I&#39;m a transformer called BERT&quot;
</span></code></pre></div></p> <p><code>Dataset.map()</code>を使用して、コーパス内のすべてのHTML文字をアンエスケープします：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1># すべてのレビューのHTML文字をアンエスケープ</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=n>drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;review&quot;</span><span class=p>:</span> <span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>])})</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>Map: 100%|██████████| 138514/138514 [00:05&lt;00:00, 27595.76 examples/s]
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>Map: 100%|██████████| 46108/46108 [00:01&lt;00:00, 27529.15 examples/s]
</span></code></pre></div></p> <p>ご覧のとおり、<code>Dataset.map()</code>メソッドはデータ処理に非常に役立ちます。しかし、できることのすべてには触れていません！</p> <h3 id=map><code>map()</code>メソッドの超能力<a class=headerlink href=#map title="Permanent link">&para;</a></h3> <p><code>Dataset.map()</code>メソッドは<code>batched</code>引数を取り、<code>True</code>に設定すると、一度に例のバッチをmap関数に送信します（バッチサイズは設定可能ですが、デフォルトは1,000です）。例えば、すべてのHTMLをアンエスケープした前のmap関数は実行に少し時間がかかりました（進行状況バーから所要時間を読み取ることができます）。リスト内包表記を使用して同時に複数の要素を処理することで、これを高速化できます。</p> <p><code>batched=True</code>を指定すると、関数はデータセットのフィールドを持つ辞書を受け取りますが、各値は単一の値ではなく、_値のリスト_になります。<code>Dataset.map()</code>の戻り値も同じである必要があります：更新または追加したいフィールドを持つ辞書と値のリストです。例えば、<code>batched=True</code>を使用してすべてのHTML文字をアンエスケープする別の方法は次のとおりです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1># バッチ処理でHTML文字をアンエスケープ（高速化）</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=n>new_drug_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;review&quot;</span><span class=p>:</span> <span class=p>[</span><span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>o</span><span class=p>)</span> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>]]},</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>Map: 100%|██████████| 138514/138514 [00:00&lt;00:00, 979367.85 examples/s]
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>Map: 100%|██████████| 46108/46108 [00:00&lt;00:00, 1043782.45 examples/s]
</span></code></pre></div></p> <p>ノートブックでこのコードを実行している場合、このコマンドが前のものよりもはるかに高速に実行されることがわかります。これは、レビューが既にHTMLアンエスケープされているからではありません（<code>batched=True</code>なしで前のセクションの命令を再実行すると、以前と同じ時間がかかります）。これは、リスト内包表記が通常<code>for</code>ループで同じコードを実行するよりも高速であり、一度に1つずつではなく、同時に多くの要素にアクセスすることでパフォーマンスが向上するためです。</p> <p><code>batched=True</code>での<code>Dataset.map()</code>の使用は、「高速」トークナイザーの速度を解放するために不可欠です。これらは大きなテキストリストを素早くトークン化できます。例えば、高速トークナイザーですべての薬物レビューをトークン化するには、このような関数を使用できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1># トークナイザーを使用してテキストをトークン化</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>AutoTokenizer</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&quot;bert-base-cased&quot;</span><span class=p>)</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=k>def</span><span class=w> </span><span class=nf>tokenize_function</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a>    <span class=k>return</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>examples</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>],</span> <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <p>1つまたは複数の例をトークナイザーに渡すことができるため、<code>batched=True</code>の有無にかかわらずこの関数を使用できます。この機会を利用して、さまざまなオプションのパフォーマンスを比較してみましょう。ノートブックでは、測定したいコード行の前に<code>%time</code>を追加することで、1行の命令の時間を測定できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=c1># バッチ処理でのトークン化のパフォーマンス測定</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=o>%</span><span class=n>time</span> <span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenize_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>Map: 100%|██████████| 138514/138514 [00:09&lt;00:00, 14578.72 examples/s]
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>Map: 100%|██████████| 46108/46108 [00:03&lt;00:00, 14226.14 examples/s]
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>CPU times: user 1min 59s, sys: 1.65 s, total: 2min
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>Wall time: 12.7 s
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=c1># 単一処理でのトークン化のパフォーマンス測定</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=o>%</span><span class=n>time</span> <span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenize_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>Map: 100%|██████████| 138514/138514 [00:28&lt;00:00, 4897.70 examples/s]
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>Map: 100%|██████████| 46108/46108 [00:09&lt;00:00, 4887.94 examples/s]
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>CPU times: user 37.4 s, sys: 356 ms, total: 37.8 s
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>Wall time: 37.7 s
</span></code></pre></div></p> <p><code>Dataset.map()</code>には独自の並列化機能もあります。Rustでバックアップされていないため、遅いトークナイザーが高速なトークナイザーに追いつくことはありませんが、それでも役立ちます（特に高速バージョンがないトークナイザーを使用している場合）。マルチプロセッシングを有効にするには、<code>Dataset.map()</code>の呼び出しで<code>num_proc</code>引数を使用して、使用するプロセス数を指定します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1># 遅いトークナイザーでマルチプロセッシングを使用</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=n>slow_tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&quot;bert-base-cased&quot;</span><span class=p>,</span> <span class=n>use_fast</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=k>def</span><span class=w> </span><span class=nf>slow_tokenize_function</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>    <span class=k>return</span> <span class=n>slow_tokenizer</span><span class=p>(</span><span class=n>examples</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>],</span> <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>slow_tokenize_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>num_proc</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>Map (num_proc=8): 100%|██████████| 138514/138514 [00:09&lt;00:00, 14687.58 examples/s]
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>Map (num_proc=8): 100%|██████████| 46108/46108 [00:03&lt;00:00, 14247.44 examples/s]
</span></code></pre></div></p> <p>使用する最適なプロセス数を決定するために少し実験してみることができます。私たちの場合、8が最高の速度向上を生み出すようでした。マルチプロセッシングあり/なしでの数値は次のとおりです：</p> <table> <thead> <tr> <th style="text-align: center;">オプション</th> <th style="text-align: center;">高速トークナイザー</th> <th style="text-align: center;">遅いトークナイザー</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;"><code>batched=True</code></td> <td style="text-align: center;">10.8s</td> <td style="text-align: center;">4min41s</td> </tr> <tr> <td style="text-align: center;"><code>batched=False</code></td> <td style="text-align: center;">59.2s</td> <td style="text-align: center;">5min3s</td> </tr> <tr> <td style="text-align: center;"><code>batched=True</code>, <code>num_proc=8</code></td> <td style="text-align: center;">6.52s</td> <td style="text-align: center;">41.3s</td> </tr> <tr> <td style="text-align: center;"><code>batched=False</code>, <code>num_proc=8</code></td> <td style="text-align: center;">9.49s</td> <td style="text-align: center;">45.2s</td> </tr> </tbody> </table> <p>これらは遅いトークナイザーにとってはるかに合理的な結果ですが、高速トークナイザーのパフォーマンスも大幅に改善されました。ただし、これが常にそうとは限らないことに注意してください。8以外の<code>num_proc</code>値に対して、テストでは<code>batched=True</code>をそのオプションなしで使用する方が高速であることが示されました。一般的に、<code>batched=True</code>で高速トークナイザーにPythonマルチプロセッシングを使用することはお勧めしません。</p> <p>動作を見てみましょう！ここでは例をトークン化し、最大長128に切り詰めますが、最初の1つだけでなく、テキストの<em>すべての</em>チャンクを返すようにトークナイザーに要求します。これは<code>return_overflowing_tokens=True</code>で実行できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1># テキストを切り詰めてオーバーフローするトークンも返す関数</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=k>def</span><span class=w> </span><span class=nf>tokenize_and_split</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>    <span class=k>return</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>        <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>],</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a>        <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a>        <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a>    <span class=p>)</span>
</span></code></pre></div> <p>データセット全体で<code>Dataset.map()</code>を使用する前に、1つの例でこれをテストしてみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=c1># 1つの例でトークン化をテスト</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=n>result</span> <span class=o>=</span> <span class=n>tokenize_and_split</span><span class=p>(</span><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>inp</span><span class=p>)</span> <span class=k>for</span> <span class=n>inp</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>]]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>[128, 49]
</span></code></pre></div></p> <p>トレーニングセットの最初の例は、指定した最大トークン数を超えてトークン化されたため、2つの特徴量になりました：長さ128の最初のものと長さ49の2番目のものです。では、データセット全体でこれを実行してみましょう！</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=c1># データセット全体でトークン化と分割を実行</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenize_and_split</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=c1># ArrowInvalid: Column 1 named condition expected length 1463 but got length 1000</span>
</span></code></pre></div> <p>うまくいきませんでした！なぜでしょうか？エラーメッセージを見ると手がかりが得られます：列の1つで長さの不一致があり、1つが1,463の長さで、もう1つが1,000の長さです。<code>Dataset.map()</code>の<a href=https://huggingface.co/docs/datasets/package_reference/main_classes#datasets.Dataset.map>ドキュメント</a>を見たことがある場合、マッピングしている関数に渡されるサンプル数であることを思い出すかもしれません。ここでは、これらの1,000例が1,463の新しい特徴量を与え、形状エラーが発生しました。</p> <p>問題は、異なるサイズの2つの異なるデータセットを混合しようとしていることです：<code>drug_dataset</code>列には一定数の例があります（エラーでの1,000）が、構築している<code>tokenized_dataset</code>にはより多くあります（エラーメッセージの1,463；<code>return_overflowing_tokens=True</code>を使用して長いレビューを複数の例にトークン化しているため、1,000より多くなります）。これは<code>Dataset</code>では機能しないため、古いデータセットから列を削除するか、新しいデータセットと同じサイズにする必要があります。<code>remove_columns</code>引数で前者を実行できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1># 古い列を削除してトークン化を実行</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a>    <span class=n>tokenize_and_split</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>remove_columns</span><span class=o>=</span><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>column_names</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>Map: 100%|██████████| 138514/138514 [00:25&lt;00:00, 5401.52 examples/s]
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>Map: 100%|██████████| 46108/46108 [00:08&lt;00:00, 5380.35 examples/s]
</span></code></pre></div></p> <p>これでエラーなく動作します。新しいデータセットが元のデータセットよりもはるかに多くの要素を持っていることを長さを比較することで確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=c1># 新旧データセットのサイズ比較</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=nb>len</span><span class=p>(</span><span class=n>tokenized_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]),</span> <span class=nb>len</span><span class=p>(</span><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>(206772, 138514)
</span></code></pre></div></p> <p>古い列を新しいものと同じサイズにすることで、不一致の長さ問題に対処することもできると述べました。これを行うには、<code>return_overflowing_tokens=True</code>を設定したときにトークナイザーが返す<code>overflow_to_sample_mapping</code>フィールドが必要です。これにより、新しい特徴量インデックスから、それが発生したサンプルのインデックスへのマッピングが提供されます。これを使用して、新しい特徴量を生成するたびに各例の値を繰り返すことで、元のデータセットに存在する各キーを適切なサイズの値のリストに関連付けることができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=c1># オーバーフローマッピングを使用して元の列も保持</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=k>def</span><span class=w> </span><span class=nf>tokenize_and_split</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>        <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;review&quot;</span><span class=p>],</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a>        <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a>        <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a>    <span class=p>)</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a>    <span class=c1># 新旧インデックス間のマッピングを抽出</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a>    <span class=n>sample_map</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>)</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>examples</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>        <span class=n>result</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>sample_map</span><span class=p>]</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a>    <span class=k>return</span> <span class=n>result</span>
</span></code></pre></div> <p>古い列を削除する必要なく、<code>Dataset.map()</code>で動作することがわかります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=c1># 元の列を保持したままトークン化</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>tokenize_and_split</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=n>tokenized_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>Map: 100%|██████████| 138514/138514 [00:26&lt;00:00, 5299.52 examples/s]
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a>Map: 100%|██████████| 46108/46108 [00:08&lt;00:00, 5344.97 examples/s]
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a>DatasetDict({
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a>    train: Dataset({
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;, &#39;input_ids&#39;, &#39;token_type_ids&#39;, &#39;attention_mask&#39;],
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a>        num_rows: 206772
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a>    })
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a>    test: Dataset({
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;, &#39;input_ids&#39;, &#39;token_type_ids&#39;, &#39;attention_mask&#39;],
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a>        num_rows: 68876
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a>    })
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a>})
</span></code></pre></div></p> <p>以前と同じ数のトレーニング特徴量が得られますが、ここではすべての古いフィールドを保持しました。モデルを適用した後に何らかの後処理でそれらが必要な場合は、このアプローチを使用したいかもしれません。</p> <p>Hugging Face Datasetsをさまざまな方法でデータセットを前処理するために使用する方法を見てきました。Hugging Face Datasetsの処理関数はモデルトレーニングのニーズのほとんどをカバーしますが、<code>DataFrame.groupby()</code>や可視化用の高レベルAPIなど、より強力な機能にアクセスするためにPandasに切り替える必要がある場合があります。幸い、Hugging Face DatasetsはPandas、NumPy、PyTorch、TensorFlow、JAXなどのライブラリと相互運用できるように設計されています。これがどのように機能するかを見てみましょう。</p> <h3 id=datasetdataframe><code>Dataset</code>から<code>DataFrame</code>への変換とその逆<a class=headerlink href=#datasetdataframe title="Permanent link">&para;</a></h3> <p>さまざまなサードパーティライブラリ間の変換を可能にするために、Hugging Face Datasetsは<code>Dataset.set_format()</code>関数を提供します。この関数はデータセットの_出力形式_のみを変更するため、基盤となる_データ形式_（Apache Arrow）に影響を与えることなく、別の形式に簡単に切り替えることができます。フォーマットはインプレースで実行されます。デモンストレーションとして、データセットをPandasに変換してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=c1># データセットの出力形式をPandasに設定</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=n>drug_dataset</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;pandas&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>これで、データセットの要素にアクセスすると、辞書の代わりに<code>pandas.DataFrame</code>が得られます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=c1># Pandas形式でデータを表示</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][:</span><span class=mi>3</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong></p> <table> <thead> <tr> <th>インデックス</th> <th>patient_id</th> <th>drugName</th> <th>condition</th> <th>review</th> <th>rating</th> <th>date</th> <th>usefulCount</th> <th>review_length</th> </tr> </thead> <tbody> <tr> <td>0</td> <td>95260</td> <td>Guanfacine</td> <td>adhd</td> <td>"My son is halfway through his fourth week of ..."</td> <td>8.0</td> <td>April 27, 2010</td> <td>192</td> <td>141</td> </tr> <tr> <td>1</td> <td>92703</td> <td>Lybrel</td> <td>birth control</td> <td>"I used to take another oral contraceptive, wh..."</td> <td>5.0</td> <td>December 14, 2009</td> <td>17</td> <td>134</td> </tr> <tr> <td>2</td> <td>138000</td> <td>Ortho Evra</td> <td>birth control</td> <td>"This is my first time using any form of birth..."</td> <td>8.0</td> <td>November 3, 2015</td> <td>10</td> <td>89</td> </tr> </tbody> </table> <p>トレーニングセット全体の<code>pandas.DataFrame</code>を作成するには、<code>drug_dataset["train"]</code>のすべての要素を選択します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=c1># トレーニングセット全体をDataFrameとして取得</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=n>train_df</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][:]</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>内部的には、<code>Dataset.set_format()</code>はデータセットの<code>__getitem__()</code>ダンダーメソッドの戻り形式を変更します。これは、<code>"pandas"</code>形式の<code>Dataset</code>から<code>train_df</code>のような新しいオブジェクトを作成したい場合、<code>pandas.DataFrame</code>を取得するためにデータセット全体をスライスする必要があることを意味します。出力形式に関係なく、<code>drug_dataset["train"]</code>の型が<code>Dataset</code>であることを自分で確認できます。</p> </div> <p>ここから、欲しいすべてのPandas機能を使用できます。例えば、<code>condition</code>エントリ間のクラス分布を計算するためにファンシーなチェーンを実行できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1># Pandasを使用してクラス分布を計算</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=n>frequencies</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>    <span class=n>train_df</span><span class=p>[</span><span class=s2>&quot;condition&quot;</span><span class=p>]</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a>    <span class=o>.</span><span class=n>value_counts</span><span class=p>()</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>    <span class=o>.</span><span class=n>to_frame</span><span class=p>()</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a>    <span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a>    <span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;index&quot;</span><span class=p>:</span> <span class=s2>&quot;condition&quot;</span><span class=p>,</span> <span class=s2>&quot;count&quot;</span><span class=p>:</span> <span class=s2>&quot;frequency&quot;</span><span class=p>})</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=p>)</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=n>frequencies</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong></p> <table> <thead> <tr> <th>インデックス</th> <th>condition</th> <th>frequency</th> </tr> </thead> <tbody> <tr> <td>0</td> <td>birth control</td> <td>27655</td> </tr> <tr> <td>1</td> <td>depression</td> <td>8023</td> </tr> <tr> <td>2</td> <td>acne</td> <td>5209</td> </tr> <tr> <td>3</td> <td>anxiety</td> <td>4991</td> </tr> <tr> <td>4</td> <td>pain</td> <td>4744</td> </tr> </tbody> </table> <p>Pandas分析が完了したら、以下のように<code>Dataset.from_pandas()</code>関数を使用して、いつでも新しい<code>Dataset</code>オブジェクトを作成できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1># PandasのDataFrameから新しいDatasetを作成</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>Dataset</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=n>freq_dataset</span> <span class=o>=</span> <span class=n>Dataset</span><span class=o>.</span><span class=n>from_pandas</span><span class=p>(</span><span class=n>frequencies</span><span class=p>)</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=n>freq_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>Dataset({
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>    features: [&#39;condition&#39;, &#39;frequency&#39;],
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>    num_rows: 819
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a>})
</span></code></pre></div></p> <p>これで、Hugging Face Datasetsで利用可能なさまざまな前処理テクニックのツアーを終了します。セクションを締めくくるために、データセットを分類器のトレーニング用に準備するための検証セットを作成しましょう。その前に、<code>drug_dataset</code>の出力形式を<code>"pandas"</code>から<code>"arrow"</code>にリセットします：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=c1># データセットの形式をリセット</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=n>drug_dataset</span><span class=o>.</span><span class=n>reset_format</span><span class=p>()</span>
</span></code></pre></div> <h3 id=_9>検証セットの作成<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>評価に使用できるテストセットはありますが、開発中にテストセットには手をつけず、別の検証セットを作成することは良い慣行です。検証セットでモデルのパフォーマンスに満足したら、テストセットで最終的な健全性チェックを実行できます。このプロセスは、テストセットに過適合し、実世界のデータで失敗するモデルをデプロイするリスクを軽減するのに役立ちます。</p> <p>Hugging Face Datasetsは、<code>scikit-learn</code>の有名な機能に基づく<code>Dataset.train_test_split()</code>関数を提供します。これを使用してトレーニングセットを<code>train</code>と<code>validation</code>分割に分割してみましょう（再現性のために<code>seed</code>引数を設定します）：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1># トレーニングセットを訓練用と検証用に分割</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=n>drug_dataset_clean</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>train_test_split</span><span class=p>(</span><span class=n>train_size</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=c1># デフォルトの&quot;test&quot;分割を&quot;validation&quot;に名前変更</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=n>drug_dataset_clean</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>drug_dataset_clean</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;test&quot;</span><span class=p>)</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=c1># &quot;test&quot;セットを`DatasetDict`に追加</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=n>drug_dataset_clean</span><span class=p>[</span><span class=s2>&quot;test&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>drug_dataset</span><span class=p>[</span><span class=s2>&quot;test&quot;</span><span class=p>]</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=n>drug_dataset_clean</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>DatasetDict({
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a>    train: Dataset({
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a>        num_rows: 110811
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a>    })
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a>    validation: Dataset({
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>        num_rows: 27703
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a>    })
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a>    test: Dataset({
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-66-12><a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a>        num_rows: 46108
</span><span id=__span-66-13><a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a>    })
</span><span id=__span-66-14><a id=__codelineno-66-14 name=__codelineno-66-14 href=#__codelineno-66-14></a>})
</span></code></pre></div></p> <h3 id=_10>データセットの保存<a class=headerlink href=#_10 title="Permanent link">&para;</a></h3> <p>Hugging Face Datasetsはダウンロードされたすべてのデータセットとそれに実行された操作をキャッシュしますが、データセットをディスクに保存したい場合があります（例：キャッシュが削除された場合）。以下の表に示すように、Hugging Face Datasetsはデータセットを異なる形式で保存するための3つの主要な関数を提供します：</p> <table> <thead> <tr> <th style="text-align: center;">データ形式</th> <th style="text-align: center;">関数</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">Arrow</td> <td style="text-align: center;"><code>Dataset.save_to_disk()</code></td> </tr> <tr> <td style="text-align: center;">CSV</td> <td style="text-align: center;"><code>Dataset.to_csv()</code></td> </tr> <tr> <td style="text-align: center;">JSON</td> <td style="text-align: center;"><code>Dataset.to_json()</code></td> </tr> </tbody> </table> <p>例えば、クリーンアップしたデータセットをArrow形式で保存してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=c1># データセットをArrow形式でディスクに保存</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=n>drug_dataset_clean</span><span class=o>.</span><span class=n>save_to_disk</span><span class=p>(</span><span class=s2>&quot;drug-reviews&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>Saving the dataset (1/1 shards): 100%|██████████| 110811/110811 [00:00&lt;00:00, 249039.27 examples/s]
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>Saving the dataset (1/1 shards): 100%|██████████| 27703/27703 [00:00&lt;00:00, 255657.51 examples/s]
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>Saving the dataset (1/1 shards): 100%|██████████| 46108/46108 [00:00&lt;00:00, 2614416.04 examples/s]
</span></code></pre></div></p> <p>これにより、以下の構造のディレクトリが作成されます：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>drug-reviews/
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>├── dataset_dict.json
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>├── test
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a>│   ├── dataset.arrow
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>│   ├── dataset_info.json
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a>│   └── state.json
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a>├── train
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a>│   ├── dataset.arrow
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a>│   ├── dataset_info.json
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a>│   ├── indices.arrow
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a>│   └── state.json
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a>└── validation
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a>    ├── dataset.arrow
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a>    ├── dataset_info.json
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a>    ├── indices.arrow
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a>    └── state.json
</span></code></pre></div> <p>各分割が独自の<em>dataset.arrow</em>テーブルに関連付けられ、<em>dataset_info.json</em>と<em>state.json</em>にメタデータがあることがわかります。Arrow形式は、大きなデータセットを処理および転送する高性能アプリケーションの構築に最適化された、列と行の素晴らしいテーブルと考えることができます。</p> <p>データセットが保存されたら、以下のように<code>load_from_disk()</code>関数を使用してロードできます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=c1># 保存されたデータセットをディスクからロード</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_from_disk</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=n>drug_dataset_reloaded</span> <span class=o>=</span> <span class=n>load_from_disk</span><span class=p>(</span><span class=s2>&quot;drug-reviews&quot;</span><span class=p>)</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=n>drug_dataset_reloaded</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>DatasetDict({
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>    train: Dataset({
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>        num_rows: 110811
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>    })
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a>    validation: Dataset({
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a>        num_rows: 27703
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a>    })
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a>    test: Dataset({
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a>        features: [&#39;patient_id&#39;, &#39;drugName&#39;, &#39;condition&#39;, &#39;review&#39;, &#39;rating&#39;, &#39;date&#39;, &#39;usefulCount&#39;, &#39;review_length&#39;],
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a>        num_rows: 46108
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a>    })
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a>})
</span></code></pre></div></p> <p>CSVとJSON形式の場合、各分割を別々のファイルとして保存する必要があります。これを行う1つの方法は、<code>DatasetDict</code>オブジェクトのキーと値を反復処理することです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=c1># 各分割をJSONLファイルとして保存</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=k>for</span> <span class=n>split</span><span class=p>,</span> <span class=n>dataset</span> <span class=ow>in</span> <span class=n>drug_dataset_clean</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a>    <span class=n>dataset</span><span class=o>.</span><span class=n>to_json</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;drug-reviews-</span><span class=si>{</span><span class=n>split</span><span class=si>}</span><span class=s2>.jsonl&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>Creating json from Arrow format: 100%|██████████| 111/111 [00:00&lt;00:00, 175.11ba/s]
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a>Creating json from Arrow format: 100%|██████████| 28/28 [00:00&lt;00:00, 180.40ba/s]
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>Creating json from Arrow format: 100%|██████████| 47/47 [00:00&lt;00:00, 382.06ba/s]
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=c1># 保存されたJSONLファイルからデータセットを再読み込み</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=n>data_files</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a>    <span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=s2>&quot;drug-reviews-train.jsonl&quot;</span><span class=p>,</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a>    <span class=s2>&quot;validation&quot;</span><span class=p>:</span> <span class=s2>&quot;drug-reviews-validation.jsonl&quot;</span><span class=p>,</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a>    <span class=s2>&quot;test&quot;</span><span class=p>:</span> <span class=s2>&quot;drug-reviews-test.jsonl&quot;</span><span class=p>,</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=p>}</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=n>drug_dataset_reloaded</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;json&quot;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=n>data_files</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>Generating train split: 110811 examples [00:00, 1512530.86 examples/s]
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a>Generating validation split: 27703 examples [00:00, 1649252.75 examples/s]
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>Generating test split: 46108 examples [00:00, 1849870.09 examples/s]
</span></code></pre></div></p> <h2 id=_11>独自データセットの作成<a class=headerlink href=#_11 title="Permanent link">&para;</a></h2> <p>NLPアプリケーションを構築するために必要なデータセットが存在しない場合があり、自分で作成する必要があります。このセクションでは、GitHubリポジトリのバグや機能を追跡するために一般的に使用される<a href=https://github.com/features/issues/ >GitHubイシュー</a>のコーパスを作成する方法を示します。このコーパスは、以下を含むさまざまな目的に使用できます：</p> <ul> <li>オープンイシューやプルリクエストを閉じるのにかかる時間の探索</li> <li>イシューの説明に基づいてイシューをメタデータでタグ付けできる_マルチラベル分類器_のトレーニング（例：「バグ」、「拡張」、「質問」）</li> <li>ユーザーのクエリに一致するイシューを見つけるセマンティック検索エンジンの作成</li> </ul> <p>ここではコーパスの作成に焦点を当て、次のセクションでセマンティック検索アプリケーションに取り組みます。メタになるために、人気のオープンソースプロジェクトに関連するGitHubイシューを使用します：Hugging Face Datasets！これらのイシューでデータを取得し、含まれる情報を探索する方法を見てみましょう。</p> <h3 id=_12>データの取得<a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <p>Hugging Face Datasetsのすべてのイシューは、リポジトリの<a href=https://github.com/huggingface/datasets/issues>Issuesタブ</a>に移動することで見つけることができます。</p> <p><img alt=datasets-issues.png src=../06_the_hugginggace_datasets_library_files/datasets-issues.png></p> <p>これらのイシューの1つをクリックすると、タイトル、説明、およびイシューを特徴付けるラベルのセットが含まれていることがわかります。</p> <p>リポジトリのすべてのイシューをダウンロードするには、<a href=https://docs.github.com/en/rest>GitHub REST API</a>を使用して<a href=https://docs.github.com/en/rest/reference/issues#list-repository-issues><code>Issues</code>エンドポイント</a>をポーリングします。このエンドポイントはJSONオブジェクトのリストを返し、各オブジェクトにはタイトルと説明、およびイシューのステータスなどに関するメタデータを含む多数のフィールドが含まれています。</p> <p>イシューをダウンロードする便利な方法は、PythonでHTTPリクエストを行う標準的な方法である<code>requests</code>ライブラリを使用することです。<code>requests.get()</code>関数を呼び出すことで、<code>Issues</code>エンドポイントにGETリクエストを送信できます。例えば、以下のコマンドを実行して、最初のページの最初のイシューを取得できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=c1># GitHub APIからイシューを取得</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=kn>import</span><span class=w> </span><span class=nn>requests</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=n>url</span> <span class=o>=</span> <span class=s2>&quot;https://api.github.com/repos/huggingface/datasets/issues?page=1&amp;per_page=1&quot;</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></code></pre></div> <p><code>response</code>オブジェクトには、HTTPステータスコードを含む、リクエストに関する多くの有用な情報が含まれています：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=c1># HTTPステータスコードを確認</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=n>response</span><span class=o>.</span><span class=n>status_code</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>200
</span></code></pre></div></p> <p><code>200</code>ステータスはリクエストが成功したことを意味します（可能なHTTPステータスコードのリストは<a href=https://en.wikipedia.org/wiki/List_of_HTTP_status_codes>こちら</a>で見つけることができます）。しかし、実際に興味があるのは_ペイロード_で、これはバイト、文字列、JSONなどのさまざまな形式でアクセスできます。イシューがJSON形式であることがわかっているので、以下のようにペイロードを調べてみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=c1># JSON形式でレスポンスのペイロードを表示</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a><span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>[{&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756&#39;,
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>  &#39;repository_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets&#39;,
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>  &#39;labels_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756/labels{/name}&#39;,
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a>  &#39;comments_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756/comments&#39;,
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a>  &#39;events_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756/events&#39;,
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a>  &#39;html_url&#39;: &#39;https://github.com/huggingface/datasets/issues/7756&#39;,
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a>  &#39;id&#39;: 3387076693,
</span><span id=__span-80-8><a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a>  &#39;node_id&#39;: &#39;I_kwDODunzps7J4rBV&#39;,
</span><span id=__span-80-9><a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a>  &#39;number&#39;: 7756,
</span><span id=__span-80-10><a id=__codelineno-80-10 name=__codelineno-80-10 href=#__codelineno-80-10></a>  &#39;title&#39;: &#39;datasets.map(f, num_proc=N) hangs with N&gt;1 when run on import&#39;,
</span><span id=__span-80-11><a id=__codelineno-80-11 name=__codelineno-80-11 href=#__codelineno-80-11></a>  &#39;user&#39;: {&#39;login&#39;: &#39;arjunguha&#39;,
</span><span id=__span-80-12><a id=__codelineno-80-12 name=__codelineno-80-12 href=#__codelineno-80-12></a>   &#39;id&#39;: 20065,
</span><span id=__span-80-13><a id=__codelineno-80-13 name=__codelineno-80-13 href=#__codelineno-80-13></a>   &#39;node_id&#39;: &#39;MDQ6VXNlcjIwMDY1&#39;,
</span><span id=__span-80-14><a id=__codelineno-80-14 name=__codelineno-80-14 href=#__codelineno-80-14></a>   &#39;avatar_url&#39;: &#39;https://avatars.githubusercontent.com/u/20065?v=4&#39;,
</span><span id=__span-80-15><a id=__codelineno-80-15 name=__codelineno-80-15 href=#__codelineno-80-15></a>   &#39;gravatar_id&#39;: &#39;&#39;,
</span><span id=__span-80-16><a id=__codelineno-80-16 name=__codelineno-80-16 href=#__codelineno-80-16></a>   &#39;url&#39;: &#39;https://api.github.com/users/arjunguha&#39;,
</span><span id=__span-80-17><a id=__codelineno-80-17 name=__codelineno-80-17 href=#__codelineno-80-17></a>   &#39;html_url&#39;: &#39;https://github.com/arjunguha&#39;,
</span><span id=__span-80-18><a id=__codelineno-80-18 name=__codelineno-80-18 href=#__codelineno-80-18></a>   &#39;followers_url&#39;: &#39;https://api.github.com/users/arjunguha/followers&#39;,
</span><span id=__span-80-19><a id=__codelineno-80-19 name=__codelineno-80-19 href=#__codelineno-80-19></a>   &#39;following_url&#39;: &#39;https://api.github.com/users/arjunguha/following{/other_user}&#39;,
</span><span id=__span-80-20><a id=__codelineno-80-20 name=__codelineno-80-20 href=#__codelineno-80-20></a>   &#39;gists_url&#39;: &#39;https://api.github.com/users/arjunguha/gists{/gist_id}&#39;,
</span><span id=__span-80-21><a id=__codelineno-80-21 name=__codelineno-80-21 href=#__codelineno-80-21></a>   &#39;starred_url&#39;: &#39;https://api.github.com/users/arjunguha/starred{/owner}{/repo}&#39;,
</span><span id=__span-80-22><a id=__codelineno-80-22 name=__codelineno-80-22 href=#__codelineno-80-22></a>   &#39;subscriptions_url&#39;: &#39;https://api.github.com/users/arjunguha/subscriptions&#39;,
</span><span id=__span-80-23><a id=__codelineno-80-23 name=__codelineno-80-23 href=#__codelineno-80-23></a>   &#39;organizations_url&#39;: &#39;https://api.github.com/users/arjunguha/orgs&#39;,
</span><span id=__span-80-24><a id=__codelineno-80-24 name=__codelineno-80-24 href=#__codelineno-80-24></a>   &#39;repos_url&#39;: &#39;https://api.github.com/users/arjunguha/repos&#39;,
</span><span id=__span-80-25><a id=__codelineno-80-25 name=__codelineno-80-25 href=#__codelineno-80-25></a>   &#39;events_url&#39;: &#39;https://api.github.com/users/arjunguha/events{/privacy}&#39;,
</span><span id=__span-80-26><a id=__codelineno-80-26 name=__codelineno-80-26 href=#__codelineno-80-26></a>   &#39;received_events_url&#39;: &#39;https://api.github.com/users/arjunguha/received_events&#39;,
</span><span id=__span-80-27><a id=__codelineno-80-27 name=__codelineno-80-27 href=#__codelineno-80-27></a>   &#39;type&#39;: &#39;User&#39;,
</span><span id=__span-80-28><a id=__codelineno-80-28 name=__codelineno-80-28 href=#__codelineno-80-28></a>   &#39;user_view_type&#39;: &#39;public&#39;,
</span><span id=__span-80-29><a id=__codelineno-80-29 name=__codelineno-80-29 href=#__codelineno-80-29></a>   &#39;site_admin&#39;: False},
</span><span id=__span-80-30><a id=__codelineno-80-30 name=__codelineno-80-30 href=#__codelineno-80-30></a>  &#39;labels&#39;: [],
</span><span id=__span-80-31><a id=__codelineno-80-31 name=__codelineno-80-31 href=#__codelineno-80-31></a>  &#39;state&#39;: &#39;open&#39;,
</span><span id=__span-80-32><a id=__codelineno-80-32 name=__codelineno-80-32 href=#__codelineno-80-32></a>  &#39;locked&#39;: False,
</span><span id=__span-80-33><a id=__codelineno-80-33 name=__codelineno-80-33 href=#__codelineno-80-33></a>  &#39;assignee&#39;: None,
</span><span id=__span-80-34><a id=__codelineno-80-34 name=__codelineno-80-34 href=#__codelineno-80-34></a>  &#39;assignees&#39;: [],
</span><span id=__span-80-35><a id=__codelineno-80-35 name=__codelineno-80-35 href=#__codelineno-80-35></a>  &#39;milestone&#39;: None,
</span><span id=__span-80-36><a id=__codelineno-80-36 name=__codelineno-80-36 href=#__codelineno-80-36></a>  &#39;comments&#39;: 0,
</span><span id=__span-80-37><a id=__codelineno-80-37 name=__codelineno-80-37 href=#__codelineno-80-37></a>  &#39;created_at&#39;: &#39;2025-09-05T10:32:01Z&#39;,
</span><span id=__span-80-38><a id=__codelineno-80-38 name=__codelineno-80-38 href=#__codelineno-80-38></a>  &#39;updated_at&#39;: &#39;2025-09-05T10:32:01Z&#39;,
</span><span id=__span-80-39><a id=__codelineno-80-39 name=__codelineno-80-39 href=#__codelineno-80-39></a>  &#39;closed_at&#39;: None,
</span><span id=__span-80-40><a id=__codelineno-80-40 name=__codelineno-80-40 href=#__codelineno-80-40></a>  &#39;author_association&#39;: &#39;NONE&#39;,
</span><span id=__span-80-41><a id=__codelineno-80-41 name=__codelineno-80-41 href=#__codelineno-80-41></a>  &#39;type&#39;: None,
</span><span id=__span-80-42><a id=__codelineno-80-42 name=__codelineno-80-42 href=#__codelineno-80-42></a>  &#39;active_lock_reason&#39;: None,
</span><span id=__span-80-43><a id=__codelineno-80-43 name=__codelineno-80-43 href=#__codelineno-80-43></a>  &#39;sub_issues_summary&#39;: {&#39;total&#39;: 0, &#39;completed&#39;: 0, &#39;percent_completed&#39;: 0},
</span><span id=__span-80-44><a id=__codelineno-80-44 name=__codelineno-80-44 href=#__codelineno-80-44></a>  &#39;issue_dependencies_summary&#39;: {&#39;blocked_by&#39;: 0,
</span><span id=__span-80-45><a id=__codelineno-80-45 name=__codelineno-80-45 href=#__codelineno-80-45></a>   &#39;total_blocked_by&#39;: 0,
</span><span id=__span-80-46><a id=__codelineno-80-46 name=__codelineno-80-46 href=#__codelineno-80-46></a>   &#39;blocking&#39;: 0,
</span><span id=__span-80-47><a id=__codelineno-80-47 name=__codelineno-80-47 href=#__codelineno-80-47></a>   &#39;total_blocking&#39;: 0},
</span><span id=__span-80-48><a id=__codelineno-80-48 name=__codelineno-80-48 href=#__codelineno-80-48></a>  &#39;body&#39;: &#39;### Describe the bug\n\nIf you `import` a module that runs `datasets.map(f, num_proc=N)` at the top-level, Python hangs.\n\n\n### Steps to reproduce the bug\n\n1. Create a file that runs datasets.map at the top-level:\n\n```bash\ncat &lt;&lt;EOF &gt; import_me.py\nimport datasets\n\nthe_dataset = datasets.load_dataset(&quot;openai/openai_humaneval&quot;)\nthe_dataset = the_dataset.map(lambda item: item, num_proc=2)\nEOF\n```\n\n2. Start Python REPL:\n\n```bash\nuv run --python 3.12.3 --with &quot;datasets==4.0.0&quot;  python3\nPython 3.12.3 (main, Aug 14 2025, 17:47:21) [GCC 13.3.0] on linux\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n```\n\n3. Import the file:\n\n```python\nimport import_me\n````\n\nObserve hang.\n\n### Expected behavior\n\nIdeally would not hang, or would fallback to num_proc=1 with a warning.\n\n### Environment info\n\n\n- `datasets` version: 4.0.0\n- Platform: Linux-6.14.0-29-generic-x86_64-with-glibc2.39\n- Python version: 3.12.3\n- `huggingface_hub` version: 0.34.4\n- PyArrow version: 21.0.0\n- Pandas version: 2.3.2\n- `fsspec` version: 2025.3.0\n&#39;,
</span><span id=__span-80-49><a id=__codelineno-80-49 name=__codelineno-80-49 href=#__codelineno-80-49></a>  &#39;closed_by&#39;: None,
</span><span id=__span-80-50><a id=__codelineno-80-50 name=__codelineno-80-50 href=#__codelineno-80-50></a>  &#39;reactions&#39;: {&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756/reactions&#39;,
</span><span id=__span-80-51><a id=__codelineno-80-51 name=__codelineno-80-51 href=#__codelineno-80-51></a>   &#39;total_count&#39;: 0,
</span><span id=__span-80-52><a id=__codelineno-80-52 name=__codelineno-80-52 href=#__codelineno-80-52></a>   &#39;+1&#39;: 0,
</span><span id=__span-80-53><a id=__codelineno-80-53 name=__codelineno-80-53 href=#__codelineno-80-53></a>   &#39;-1&#39;: 0,
</span><span id=__span-80-54><a id=__codelineno-80-54 name=__codelineno-80-54 href=#__codelineno-80-54></a>   &#39;laugh&#39;: 0,
</span><span id=__span-80-55><a id=__codelineno-80-55 name=__codelineno-80-55 href=#__codelineno-80-55></a>   &#39;hooray&#39;: 0,
</span><span id=__span-80-56><a id=__codelineno-80-56 name=__codelineno-80-56 href=#__codelineno-80-56></a>   &#39;confused&#39;: 0,
</span><span id=__span-80-57><a id=__codelineno-80-57 name=__codelineno-80-57 href=#__codelineno-80-57></a>   &#39;heart&#39;: 0,
</span><span id=__span-80-58><a id=__codelineno-80-58 name=__codelineno-80-58 href=#__codelineno-80-58></a>   &#39;rocket&#39;: 0,
</span><span id=__span-80-59><a id=__codelineno-80-59 name=__codelineno-80-59 href=#__codelineno-80-59></a>   &#39;eyes&#39;: 0},
</span><span id=__span-80-60><a id=__codelineno-80-60 name=__codelineno-80-60 href=#__codelineno-80-60></a>  &#39;timeline_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/7756/timeline&#39;,
</span><span id=__span-80-61><a id=__codelineno-80-61 name=__codelineno-80-61 href=#__codelineno-80-61></a>  &#39;performed_via_github_app&#39;: None,
</span><span id=__span-80-62><a id=__codelineno-80-62 name=__codelineno-80-62 href=#__codelineno-80-62></a>  &#39;state_reason&#39;: None}]
</span></code></pre></div></p> <p>たくさんの情報ですね！イシューを説明する<code>title</code>、<code>body</code>、<code>number</code>などの有用なフィールドや、イシューを開いたGitHubユーザーに関する情報が見えます。</p> <p>GitHub<a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting>ドキュメント</a>で説明されているように、認証されていないリクエストは1時間あたり60リクエストに制限されています。<code>per_page</code>クエリパラメータを増やして行うリクエスト数を減らすことはできますが、数千を超えるイシューを持つリポジトリでは、依然として制限に達してしまいます。代わりに、_パーソナルアクセストークン_を作成するGitHubの<a href=https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token>手順</a>に従って、制限を1時間あたり5,000リクエストまで増やすべきです。トークンを取得したら、リクエストヘッダーの一部として含めることができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=c1># GitHubトークンを使用した認証設定</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=n>GITHUB_TOKEN</span> <span class=o>=</span> <span class=s1>&#39;xxx&#39;</span>  <span class=c1># GitHubトークンをここにコピーしてください</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;Authorization&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;token </span><span class=si>{</span><span class=n>GITHUB_TOKEN</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>}</span>
</span></code></pre></div> <p>アクセストークンができたので、GitHubリポジトリからすべてのイシューをダウンロードできる関数を作成しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=c1># GitHubイシューを取得する関数</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span><span class=o>,</span><span class=w> </span><span class=nn>requests</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=kn>import</span><span class=w> </span><span class=nn>math</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=kn>from</span><span class=w> </span><span class=nn>pathlib</span><span class=w> </span><span class=kn>import</span> <span class=n>Path</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=kn>from</span><span class=w> </span><span class=nn>tqdm.notebook</span><span class=w> </span><span class=kn>import</span> <span class=n>tqdm</span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=k>def</span><span class=w> </span><span class=nf>fetch_issues</span><span class=p>(</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a>    <span class=n>owner</span><span class=o>=</span><span class=s2>&quot;huggingface&quot;</span><span class=p>,</span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a>    <span class=n>repo</span><span class=o>=</span><span class=s2>&quot;datasets&quot;</span><span class=p>,</span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a>    <span class=n>num_issues</span><span class=o>=</span><span class=mi>10_000</span><span class=p>,</span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a>    <span class=n>rate_limit</span><span class=o>=</span><span class=mi>5_000</span><span class=p>,</span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a>    <span class=n>issues_path</span><span class=o>=</span><span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>),</span>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=p>):</span>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>issues_path</span><span class=o>.</span><span class=n>is_dir</span><span class=p>():</span>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a>        <span class=n>issues_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-82-17><a id=__codelineno-82-17 name=__codelineno-82-17 href=#__codelineno-82-17></a>
</span><span id=__span-82-18><a id=__codelineno-82-18 name=__codelineno-82-18 href=#__codelineno-82-18></a>    <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-82-19><a id=__codelineno-82-19 name=__codelineno-82-19 href=#__codelineno-82-19></a>    <span class=n>all_issues</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-82-20><a id=__codelineno-82-20 name=__codelineno-82-20 href=#__codelineno-82-20></a>    <span class=n>per_page</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># ページあたりのイシュー数</span>
</span><span id=__span-82-21><a id=__codelineno-82-21 name=__codelineno-82-21 href=#__codelineno-82-21></a>    <span class=n>num_pages</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>num_issues</span> <span class=o>/</span> <span class=n>per_page</span><span class=p>)</span>
</span><span id=__span-82-22><a id=__codelineno-82-22 name=__codelineno-82-22 href=#__codelineno-82-22></a>    <span class=n>base_url</span> <span class=o>=</span> <span class=s2>&quot;https://api.github.com/repos&quot;</span>
</span><span id=__span-82-23><a id=__codelineno-82-23 name=__codelineno-82-23 href=#__codelineno-82-23></a>
</span><span id=__span-82-24><a id=__codelineno-82-24 name=__codelineno-82-24 href=#__codelineno-82-24></a>    <span class=k>for</span> <span class=n>page</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>num_pages</span><span class=p>)):</span>
</span><span id=__span-82-25><a id=__codelineno-82-25 name=__codelineno-82-25 href=#__codelineno-82-25></a>        <span class=c1># state=allでオープンとクローズ両方のイシューを取得</span>
</span><span id=__span-82-26><a id=__codelineno-82-26 name=__codelineno-82-26 href=#__codelineno-82-26></a>        <span class=n>query</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;issues?page=</span><span class=si>{</span><span class=n>page</span><span class=si>}</span><span class=s2>&amp;per_page=</span><span class=si>{</span><span class=n>per_page</span><span class=si>}</span><span class=s2>&amp;state=all&quot;</span>
</span><span id=__span-82-27><a id=__codelineno-82-27 name=__codelineno-82-27 href=#__codelineno-82-27></a>        <span class=n>issues</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>owner</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>repo</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span><span id=__span-82-28><a id=__codelineno-82-28 name=__codelineno-82-28 href=#__codelineno-82-28></a>        <span class=n>batch</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>issues</span><span class=o>.</span><span class=n>json</span><span class=p>())</span>
</span><span id=__span-82-29><a id=__codelineno-82-29 name=__codelineno-82-29 href=#__codelineno-82-29></a>
</span><span id=__span-82-30><a id=__codelineno-82-30 name=__codelineno-82-30 href=#__codelineno-82-30></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>rate_limit</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>all_issues</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>num_issues</span><span class=p>:</span>
</span><span id=__span-82-31><a id=__codelineno-82-31 name=__codelineno-82-31 href=#__codelineno-82-31></a>            <span class=n>all_issues</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-82-32><a id=__codelineno-82-32 name=__codelineno-82-32 href=#__codelineno-82-32></a>            <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 次の時間間隔のためにバッチをフラッシュ</span>
</span><span id=__span-82-33><a id=__codelineno-82-33 name=__codelineno-82-33 href=#__codelineno-82-33></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;GitHubの制限に到達しました。1時間スリープします...&quot;</span><span class=p>)</span>
</span><span id=__span-82-34><a id=__codelineno-82-34 name=__codelineno-82-34 href=#__codelineno-82-34></a>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-82-35><a id=__codelineno-82-35 name=__codelineno-82-35 href=#__codelineno-82-35></a>
</span><span id=__span-82-36><a id=__codelineno-82-36 name=__codelineno-82-36 href=#__codelineno-82-36></a>    <span class=n>all_issues</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-82-37><a id=__codelineno-82-37 name=__codelineno-82-37 href=#__codelineno-82-37></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=o>.</span><span class=n>from_records</span><span class=p>(</span><span class=n>all_issues</span><span class=p>)</span>
</span><span id=__span-82-38><a id=__codelineno-82-38 name=__codelineno-82-38 href=#__codelineno-82-38></a>    <span class=n>df</span><span class=o>.</span><span class=n>to_json</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>issues_path</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>repo</span><span class=si>}</span><span class=s2>-issues.jsonl&quot;</span><span class=p>,</span> <span class=n>orient</span><span class=o>=</span><span class=s2>&quot;records&quot;</span><span class=p>,</span> <span class=n>lines</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-82-39><a id=__codelineno-82-39 name=__codelineno-82-39 href=#__codelineno-82-39></a>    <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-82-40><a id=__codelineno-82-40 name=__codelineno-82-40 href=#__codelineno-82-40></a>        <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>repo</span><span class=si>}</span><span class=s2>のすべてのイシューをダウンロードしました！データセットは</span><span class=si>{</span><span class=n>issues_path</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>repo</span><span class=si>}</span><span class=s2>-issues.jsonlに保存されています&quot;</span>
</span><span id=__span-82-41><a id=__codelineno-82-41 name=__codelineno-82-41 href=#__codelineno-82-41></a>    <span class=p>)</span>
</span></code></pre></div> <p><code>fetch_issues()</code>を呼び出すと、GitHubの1時間あたりのリクエスト数制限を超えないようにバッチですべてのイシューをダウンロードします。結果は_repository_name-issues.jsonl_ファイルに保存され、各行はイシューを表すJSONオブジェクトです。この関数を使用してHugging Face Datasetsからすべてのイシューを取得してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=c1># インターネット接続によっては、実行に数分かかる場合があります...</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=n>fetch_issues</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a>  0%|          | 0/100 [00:00&lt;?, ?it/s]
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a>GitHubの制限に到達しました。1時間スリープします...
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a>datasetsのすべてのイシューをダウンロードしました！データセットは./datasets-issues.jsonlに保存されています
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=c1># ダウンロードしたデータをDatasetに変換</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>Dataset</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_json</span><span class=p>(</span><span class=s2>&quot;datasets-issues.jsonl&quot;</span><span class=p>,</span> <span class=n>lines</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=n>issues_dataset</span> <span class=o>=</span> <span class=n>Dataset</span><span class=o>.</span><span class=n>from_pandas</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=n>issues_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a>Dataset({
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a>    features: [&#39;url&#39;, &#39;repository_url&#39;, &#39;labels_url&#39;, &#39;comments_url&#39;, &#39;events_url&#39;, &#39;html_url&#39;, &#39;id&#39;, &#39;node_id&#39;, &#39;number&#39;, &#39;title&#39;, &#39;user&#39;, &#39;labels&#39;, &#39;state&#39;, &#39;locked&#39;, &#39;assignee&#39;, &#39;assignees&#39;, &#39;milestone&#39;, &#39;comments&#39;, &#39;created_at&#39;, &#39;updated_at&#39;, &#39;closed_at&#39;, &#39;author_association&#39;, &#39;type&#39;, &#39;active_lock_reason&#39;, &#39;sub_issues_summary&#39;, &#39;issue_dependencies_summary&#39;, &#39;body&#39;, &#39;closed_by&#39;, &#39;reactions&#39;, &#39;timeline_url&#39;, &#39;performed_via_github_app&#39;, &#39;state_reason&#39;, &#39;draft&#39;, &#39;pull_request&#39;],
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a>    num_rows: 7676
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a>})
</span></code></pre></div></p> <h3 id=_13>データのクリーンアップ<a class=headerlink href=#_13 title="Permanent link">&para;</a></h3> <p>GitHubドキュメントの上記スニペットは、<code>pull_request</code>列を使用してイシューとプルリクエストを区別できることを示しています。ランダムサンプルを見て、違いが何かを確認してみましょう。<code>Dataset.shuffle()</code>と<code>Dataset.select()</code>を連鎖させてランダムサンプルを作成し、<code>html_url</code>と<code>pull_request</code>列を圧縮してさまざまなURLを比較できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=c1># ランダムサンプルでイシューとプルリクエストの違いを確認</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=n>sample</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>seed</span><span class=o>=</span><span class=mi>666</span><span class=p>)</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=c1># URLとプルリクエストエントリを出力</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=k>for</span> <span class=n>url</span><span class=p>,</span> <span class=n>pr</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s2>&quot;html_url&quot;</span><span class=p>],</span> <span class=n>sample</span><span class=p>[</span><span class=s2>&quot;pull_request&quot;</span><span class=p>]):</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;&gt;&gt; URL: </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;&gt;&gt; プルリクエスト: </span><span class=si>{</span><span class=n>pr</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a>&gt;&gt; URL: https://github.com/huggingface/datasets/issues/277
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a>&gt;&gt; プルリクエスト: None
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a>&gt;&gt; URL: https://github.com/huggingface/datasets/issues/6132
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a>&gt;&gt; プルリクエスト: None
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a>&gt;&gt; URL: https://github.com/huggingface/datasets/pull/6943
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a>&gt;&gt; プルリクエスト: {&#39;diff_url&#39;: &#39;https://github.com/huggingface/datasets/pull/6943.diff&#39;, &#39;html_url&#39;: &#39;https://github.com/huggingface/datasets/pull/6943&#39;, &#39;merged_at&#39;: &#39;2024-06-03T05:17:40Z&#39;, &#39;patch_url&#39;: &#39;https://github.com/huggingface/datasets/pull/6943.patch&#39;, &#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/pulls/6943&#39;}
</span></code></pre></div></p> <p>ここで、各プルリクエストがさまざまなURLに関連付けられている一方で、通常のイシューには<code>None</code>エントリがあることがわかります。この区別を使用して、<code>pull_request</code>フィールドが<code>None</code>かどうかをチェックする新しい<code>is_pull_request</code>列を作成できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=c1># プルリクエストかどうかを示す新しい列を追加</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a><span class=n>issues_dataset</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;is_pull_request&quot;</span><span class=p>:</span> <span class=kc>False</span> <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;pull_request&quot;</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=kc>True</span><span class=p>}</span>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=p>)</span>
</span></code></pre></div> <p>一部の列を削除または名前変更してデータセットをさらにクリーンアップすることもできますが、一般的に、この段階ではデータセットを「生の」状態にできるだけ保つことは良い慣行です。これにより、複数のアプリケーションで簡単に使用できます。</p> <h3 id=_14>データセットの拡張<a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <p>以下のスクリーンショットに示すように、イシューやプルリクエストに関連するコメントは、特にライブラリに関するユーザーのクエリに答える検索エンジンの構築に興味がある場合、豊富な情報源を提供します。</p> <p>GitHub REST APIは、イシュー番号に関連するすべてのコメントを返す<a href=https://docs.github.com/en/rest/reference/issues#list-issue-comments><code>Comments</code>エンドポイント</a>を提供します。エンドポイントをテストして、何を返すかを確認してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=c1># 特定のイシューのコメントを取得</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=n>issue_number</span> <span class=o>=</span> <span class=mi>2792</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;https://api.github.com/repos/huggingface/datasets/issues/</span><span class=si>{</span><span class=n>issue_number</span><span class=si>}</span><span class=s2>/comments&quot;</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a>[{&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/comments/897594128&#39;,
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a>  &#39;html_url&#39;: &#39;https://github.com/huggingface/datasets/pull/2792#issuecomment-897594128&#39;,
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a>  &#39;issue_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/2792&#39;,
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a>  &#39;id&#39;: 897594128,
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a>  &#39;node_id&#39;: &#39;IC_kwDODunzps41gDMQ&#39;,
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a>  &#39;user&#39;: {&#39;login&#39;: &#39;bhavitvyamalik&#39;,
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a>   &#39;id&#39;: 19718818,
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a>   &#39;node_id&#39;: &#39;MDQ6VXNlcjE5NzE4ODE4&#39;,
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9 href=#__codelineno-91-9></a>   &#39;avatar_url&#39;: &#39;https://avatars.githubusercontent.com/u/19718818?v=4&#39;,
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10 href=#__codelineno-91-10></a>   &#39;gravatar_id&#39;: &#39;&#39;,
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11 href=#__codelineno-91-11></a>   &#39;url&#39;: &#39;https://api.github.com/users/bhavitvyamalik&#39;,
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12 href=#__codelineno-91-12></a>   &#39;html_url&#39;: &#39;https://github.com/bhavitvyamalik&#39;,
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13 href=#__codelineno-91-13></a>   &#39;followers_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/followers&#39;,
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14 href=#__codelineno-91-14></a>   &#39;following_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/following{/other_user}&#39;,
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15 href=#__codelineno-91-15></a>   &#39;gists_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/gists{/gist_id}&#39;,
</span><span id=__span-91-16><a id=__codelineno-91-16 name=__codelineno-91-16 href=#__codelineno-91-16></a>   &#39;starred_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/starred{/owner}{/repo}&#39;,
</span><span id=__span-91-17><a id=__codelineno-91-17 name=__codelineno-91-17 href=#__codelineno-91-17></a>   &#39;subscriptions_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/subscriptions&#39;,
</span><span id=__span-91-18><a id=__codelineno-91-18 name=__codelineno-91-18 href=#__codelineno-91-18></a>   &#39;organizations_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/orgs&#39;,
</span><span id=__span-91-19><a id=__codelineno-91-19 name=__codelineno-91-19 href=#__codelineno-91-19></a>   &#39;repos_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/repos&#39;,
</span><span id=__span-91-20><a id=__codelineno-91-20 name=__codelineno-91-20 href=#__codelineno-91-20></a>   &#39;events_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/events{/privacy}&#39;,
</span><span id=__span-91-21><a id=__codelineno-91-21 name=__codelineno-91-21 href=#__codelineno-91-21></a>   &#39;received_events_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/received_events&#39;,
</span><span id=__span-91-22><a id=__codelineno-91-22 name=__codelineno-91-22 href=#__codelineno-91-22></a>   &#39;type&#39;: &#39;User&#39;,
</span><span id=__span-91-23><a id=__codelineno-91-23 name=__codelineno-91-23 href=#__codelineno-91-23></a>   &#39;user_view_type&#39;: &#39;public&#39;,
</span><span id=__span-91-24><a id=__codelineno-91-24 name=__codelineno-91-24 href=#__codelineno-91-24></a>   &#39;site_admin&#39;: False},
</span><span id=__span-91-25><a id=__codelineno-91-25 name=__codelineno-91-25 href=#__codelineno-91-25></a>  &#39;created_at&#39;: &#39;2021-08-12T12:21:52Z&#39;,
</span><span id=__span-91-26><a id=__codelineno-91-26 name=__codelineno-91-26 href=#__codelineno-91-26></a>  &#39;updated_at&#39;: &#39;2021-08-12T12:31:17Z&#39;,
</span><span id=__span-91-27><a id=__codelineno-91-27 name=__codelineno-91-27 href=#__codelineno-91-27></a>  &#39;author_association&#39;: &#39;CONTRIBUTOR&#39;,
</span><span id=__span-91-28><a id=__codelineno-91-28 name=__codelineno-91-28 href=#__codelineno-91-28></a>  &#39;body&#39;: &quot;@albertvillanova my tests are failing here:\r\n```\r\ndataset_name = &#39;gooaq&#39;\r\n\r\n    def test_load_dataset(self, dataset_name):\r\n        configs = self.dataset_tester.load_all_configs(dataset_name, is_local=True)[:1]\r\n&gt;       self.dataset_tester.check_load_dataset(dataset_name, configs, is_local=True, use_local_dummy_data=True)\r\n\r\ntests/test_dataset_common.py:234: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\ntests/test_dataset_common.py:187: in check_load_dataset\r\n    self.parent.assertTrue(len(dataset[split]) &gt; 0)\r\nE   AssertionError: False is not true\r\n```\r\nWhen I try loading dataset on local machine it works fine. Any suggestions on how can I avoid this error?&quot;,
</span><span id=__span-91-29><a id=__codelineno-91-29 name=__codelineno-91-29 href=#__codelineno-91-29></a>  &#39;reactions&#39;: {&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/comments/897594128/reactions&#39;,
</span><span id=__span-91-30><a id=__codelineno-91-30 name=__codelineno-91-30 href=#__codelineno-91-30></a>   &#39;total_count&#39;: 0,
</span><span id=__span-91-31><a id=__codelineno-91-31 name=__codelineno-91-31 href=#__codelineno-91-31></a>   &#39;+1&#39;: 0,
</span><span id=__span-91-32><a id=__codelineno-91-32 name=__codelineno-91-32 href=#__codelineno-91-32></a>   &#39;-1&#39;: 0,
</span><span id=__span-91-33><a id=__codelineno-91-33 name=__codelineno-91-33 href=#__codelineno-91-33></a>   &#39;laugh&#39;: 0,
</span><span id=__span-91-34><a id=__codelineno-91-34 name=__codelineno-91-34 href=#__codelineno-91-34></a>   &#39;hooray&#39;: 0,
</span><span id=__span-91-35><a id=__codelineno-91-35 name=__codelineno-91-35 href=#__codelineno-91-35></a>   &#39;confused&#39;: 0,
</span><span id=__span-91-36><a id=__codelineno-91-36 name=__codelineno-91-36 href=#__codelineno-91-36></a>   &#39;heart&#39;: 0,
</span><span id=__span-91-37><a id=__codelineno-91-37 name=__codelineno-91-37 href=#__codelineno-91-37></a>   &#39;rocket&#39;: 0,
</span><span id=__span-91-38><a id=__codelineno-91-38 name=__codelineno-91-38 href=#__codelineno-91-38></a>   &#39;eyes&#39;: 0},
</span><span id=__span-91-39><a id=__codelineno-91-39 name=__codelineno-91-39 href=#__codelineno-91-39></a>  &#39;performed_via_github_app&#39;: None},
</span><span id=__span-91-40><a id=__codelineno-91-40 name=__codelineno-91-40 href=#__codelineno-91-40></a> {&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/comments/898644889&#39;,
</span><span id=__span-91-41><a id=__codelineno-91-41 name=__codelineno-91-41 href=#__codelineno-91-41></a>  &#39;html_url&#39;: &#39;https://github.com/huggingface/datasets/pull/2792#issuecomment-898644889&#39;,
</span><span id=__span-91-42><a id=__codelineno-91-42 name=__codelineno-91-42 href=#__codelineno-91-42></a>  &#39;issue_url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/2792&#39;,
</span><span id=__span-91-43><a id=__codelineno-91-43 name=__codelineno-91-43 href=#__codelineno-91-43></a>  &#39;id&#39;: 898644889,
</span><span id=__span-91-44><a id=__codelineno-91-44 name=__codelineno-91-44 href=#__codelineno-91-44></a>  &#39;node_id&#39;: &#39;IC_kwDODunzps41kDuZ&#39;,
</span><span id=__span-91-45><a id=__codelineno-91-45 name=__codelineno-91-45 href=#__codelineno-91-45></a>  &#39;user&#39;: {&#39;login&#39;: &#39;bhavitvyamalik&#39;,
</span><span id=__span-91-46><a id=__codelineno-91-46 name=__codelineno-91-46 href=#__codelineno-91-46></a>   &#39;id&#39;: 19718818,
</span><span id=__span-91-47><a id=__codelineno-91-47 name=__codelineno-91-47 href=#__codelineno-91-47></a>   &#39;node_id&#39;: &#39;MDQ6VXNlcjE5NzE4ODE4&#39;,
</span><span id=__span-91-48><a id=__codelineno-91-48 name=__codelineno-91-48 href=#__codelineno-91-48></a>   &#39;avatar_url&#39;: &#39;https://avatars.githubusercontent.com/u/19718818?v=4&#39;,
</span><span id=__span-91-49><a id=__codelineno-91-49 name=__codelineno-91-49 href=#__codelineno-91-49></a>   &#39;gravatar_id&#39;: &#39;&#39;,
</span><span id=__span-91-50><a id=__codelineno-91-50 name=__codelineno-91-50 href=#__codelineno-91-50></a>   &#39;url&#39;: &#39;https://api.github.com/users/bhavitvyamalik&#39;,
</span><span id=__span-91-51><a id=__codelineno-91-51 name=__codelineno-91-51 href=#__codelineno-91-51></a>   &#39;html_url&#39;: &#39;https://github.com/bhavitvyamalik&#39;,
</span><span id=__span-91-52><a id=__codelineno-91-52 name=__codelineno-91-52 href=#__codelineno-91-52></a>   &#39;followers_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/followers&#39;,
</span><span id=__span-91-53><a id=__codelineno-91-53 name=__codelineno-91-53 href=#__codelineno-91-53></a>   &#39;following_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/following{/other_user}&#39;,
</span><span id=__span-91-54><a id=__codelineno-91-54 name=__codelineno-91-54 href=#__codelineno-91-54></a>   &#39;gists_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/gists{/gist_id}&#39;,
</span><span id=__span-91-55><a id=__codelineno-91-55 name=__codelineno-91-55 href=#__codelineno-91-55></a>   &#39;starred_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/starred{/owner}{/repo}&#39;,
</span><span id=__span-91-56><a id=__codelineno-91-56 name=__codelineno-91-56 href=#__codelineno-91-56></a>   &#39;subscriptions_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/subscriptions&#39;,
</span><span id=__span-91-57><a id=__codelineno-91-57 name=__codelineno-91-57 href=#__codelineno-91-57></a>   &#39;organizations_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/orgs&#39;,
</span><span id=__span-91-58><a id=__codelineno-91-58 name=__codelineno-91-58 href=#__codelineno-91-58></a>   &#39;repos_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/repos&#39;,
</span><span id=__span-91-59><a id=__codelineno-91-59 name=__codelineno-91-59 href=#__codelineno-91-59></a>   &#39;events_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/events{/privacy}&#39;,
</span><span id=__span-91-60><a id=__codelineno-91-60 name=__codelineno-91-60 href=#__codelineno-91-60></a>   &#39;received_events_url&#39;: &#39;https://api.github.com/users/bhavitvyamalik/received_events&#39;,
</span><span id=__span-91-61><a id=__codelineno-91-61 name=__codelineno-91-61 href=#__codelineno-91-61></a>   &#39;type&#39;: &#39;User&#39;,
</span><span id=__span-91-62><a id=__codelineno-91-62 name=__codelineno-91-62 href=#__codelineno-91-62></a>   &#39;user_view_type&#39;: &#39;public&#39;,
</span><span id=__span-91-63><a id=__codelineno-91-63 name=__codelineno-91-63 href=#__codelineno-91-63></a>   &#39;site_admin&#39;: False},
</span><span id=__span-91-64><a id=__codelineno-91-64 name=__codelineno-91-64 href=#__codelineno-91-64></a>  &#39;created_at&#39;: &#39;2021-08-13T18:28:27Z&#39;,
</span><span id=__span-91-65><a id=__codelineno-91-65 name=__codelineno-91-65 href=#__codelineno-91-65></a>  &#39;updated_at&#39;: &#39;2021-08-13T18:28:27Z&#39;,
</span><span id=__span-91-66><a id=__codelineno-91-66 name=__codelineno-91-66 href=#__codelineno-91-66></a>  &#39;author_association&#39;: &#39;CONTRIBUTOR&#39;,
</span><span id=__span-91-67><a id=__codelineno-91-67 name=__codelineno-91-67 href=#__codelineno-91-67></a>  &#39;body&#39;: &#39;Thanks for the help, @albertvillanova! All tests are passing now.&#39;,
</span><span id=__span-91-68><a id=__codelineno-91-68 name=__codelineno-91-68 href=#__codelineno-91-68></a>  &#39;reactions&#39;: {&#39;url&#39;: &#39;https://api.github.com/repos/huggingface/datasets/issues/comments/898644889/reactions&#39;,
</span><span id=__span-91-69><a id=__codelineno-91-69 name=__codelineno-91-69 href=#__codelineno-91-69></a>   &#39;total_count&#39;: 0,
</span><span id=__span-91-70><a id=__codelineno-91-70 name=__codelineno-91-70 href=#__codelineno-91-70></a>   &#39;+1&#39;: 0,
</span><span id=__span-91-71><a id=__codelineno-91-71 name=__codelineno-91-71 href=#__codelineno-91-71></a>   &#39;-1&#39;: 0,
</span><span id=__span-91-72><a id=__codelineno-91-72 name=__codelineno-91-72 href=#__codelineno-91-72></a>   &#39;laugh&#39;: 0,
</span><span id=__span-91-73><a id=__codelineno-91-73 name=__codelineno-91-73 href=#__codelineno-91-73></a>   &#39;hooray&#39;: 0,
</span><span id=__span-91-74><a id=__codelineno-91-74 name=__codelineno-91-74 href=#__codelineno-91-74></a>   &#39;confused&#39;: 0,
</span><span id=__span-91-75><a id=__codelineno-91-75 name=__codelineno-91-75 href=#__codelineno-91-75></a>   &#39;heart&#39;: 0,
</span><span id=__span-91-76><a id=__codelineno-91-76 name=__codelineno-91-76 href=#__codelineno-91-76></a>   &#39;rocket&#39;: 0,
</span><span id=__span-91-77><a id=__codelineno-91-77 name=__codelineno-91-77 href=#__codelineno-91-77></a>   &#39;eyes&#39;: 0},
</span><span id=__span-91-78><a id=__codelineno-91-78 name=__codelineno-91-78 href=#__codelineno-91-78></a>  &#39;performed_via_github_app&#39;: None}]
</span></code></pre></div></p> <p>コメントが<code>body</code>フィールドに保存されていることがわかるので、<code>response.json()</code>の各要素の<code>body</code>内容を取り出すことで、イシューに関連するすべてのコメントを返す簡単な関数を書きましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=c1># イシューのコメントを取得する関数</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=k>def</span><span class=w> </span><span class=nf>get_comments</span><span class=p>(</span><span class=n>issue_number</span><span class=p>):</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;https://api.github.com/repos/huggingface/datasets/issues/</span><span class=si>{</span><span class=n>issue_number</span><span class=si>}</span><span class=s2>/comments&quot;</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a>    <span class=k>return</span> <span class=p>[</span><span class=n>r</span><span class=p>[</span><span class=s2>&quot;body&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()]</span>
</span></code></pre></div> <p>これで良さそうなので、<code>Dataset.map()</code>を使用してデータセット内の各イシューに新しい<code>comments</code>列を追加しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=c1># インターネット接続によっては、数分かかる場合があります...</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=n>issues_with_comments_dataset</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;comments&quot;</span><span class=p>:</span> <span class=n>get_comments</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;number&quot;</span><span class=p>])}</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=p>)</span>
</span></code></pre></div> <p>このデータセットをローカルに保存します。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=c1># データセットをJSONL形式で保存</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=n>issues_with_comments_dataset</span><span class=o>.</span><span class=n>to_json</span><span class=p>(</span><span class=s2>&quot;issues_with_comments-dataset.jsonl&quot;</span><span class=p>)</span>
</span></code></pre></div> <h2 id=faiss>FAISSを使った意味検索<a class=headerlink href=#faiss title="Permanent link">&para;</a></h2> <h3 id=_15>意味検索のための埋め込み<a class=headerlink href=#_15 title="Permanent link">&para;</a></h3> <p>Transformerベースの言語モデルは、テキストのスパン内の各トークンを_埋め込みベクトル_として表現します。個々の埋め込みベクトルを統合（プール）することで、文全体、段落、さらには文書全体のベクトル表現を作成することができます。これらの埋め込みは、各埋め込み間のドット積類似度（または他の類似度メトリック）を計算し、最も重複の大きい文書を返すことで、コーパス内の類似文書を見つけるために使用できます。</p> <p>このセクションでは、埋め込みを使用して意味検索エンジンを開発します。これらの検索エンジンは、クエリ内のキーワードと文書をマッチングすることに基づく従来のアプローチよりもいくつかの利点があります。</p> <h3 id=_16>データセットの読み込みと準備<a class=headerlink href=#_16 title="Permanent link">&para;</a></h3> <p>最初に行う必要があるのは、GitHubイシューのデータセットをダウンロードすることなので、いつものように<code>load_dataset()</code>関数を使用しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=c1># GitHubイシューデータセットの読み込み</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_dataset</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=n>issues_dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;lewtun/github-issues&quot;</span><span class=p>,</span> <span class=n>split</span><span class=o>=</span><span class=s2>&quot;train&quot;</span><span class=p>)</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=n>issues_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a>Repo card metadata block was not found. Setting CardData to empty.
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a>Dataset({
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a>    features: [&#39;url&#39;, &#39;repository_url&#39;, &#39;labels_url&#39;, &#39;comments_url&#39;, &#39;events_url&#39;, &#39;html_url&#39;, &#39;id&#39;, &#39;node_id&#39;, &#39;number&#39;, &#39;title&#39;, &#39;user&#39;, &#39;labels&#39;, &#39;state&#39;, &#39;locked&#39;, &#39;assignee&#39;, &#39;assignees&#39;, &#39;milestone&#39;, &#39;comments&#39;, &#39;created_at&#39;, &#39;updated_at&#39;, &#39;closed_at&#39;, &#39;author_association&#39;, &#39;active_lock_reason&#39;, &#39;pull_request&#39;, &#39;body&#39;, &#39;timeline_url&#39;, &#39;performed_via_github_app&#39;, &#39;is_pull_request&#39;],
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a>    num_rows: 3019
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a>})
</span></code></pre></div></p> <p>ここでは<code>load_dataset()</code>でデフォルトの<code>train</code>分割を指定したので、<code>DatasetDict</code>ではなく<code>Dataset</code>を返します。まず最初にプルリクエストをフィルタリングする必要があります。これらはユーザークエリに答えるためにはめったに使用されず、検索エンジンにノイズを導入するためです。既によく知られているように、<code>Dataset.filter()</code>関数を使用してデータセット内のこれらの行を除外できます。ついでに、コメントのない行もフィルタリングしましょう。これらはユーザークエリに対する回答を提供しないためです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=c1># プルリクエストとコメントなしの行をフィルタリング</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a><span class=n>issues_dataset</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3 href=#__codelineno-97-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;is_pull_request&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=kc>False</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;comments&quot;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4 href=#__codelineno-97-4></a><span class=p>)</span>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5 href=#__codelineno-97-5></a><span class=n>issues_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a>Dataset({
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a>    features: [&#39;url&#39;, &#39;repository_url&#39;, &#39;labels_url&#39;, &#39;comments_url&#39;, &#39;events_url&#39;, &#39;html_url&#39;, &#39;id&#39;, &#39;node_id&#39;, &#39;number&#39;, &#39;title&#39;, &#39;user&#39;, &#39;labels&#39;, &#39;state&#39;, &#39;locked&#39;, &#39;assignee&#39;, &#39;assignees&#39;, &#39;milestone&#39;, &#39;comments&#39;, &#39;created_at&#39;, &#39;updated_at&#39;, &#39;closed_at&#39;, &#39;author_association&#39;, &#39;active_lock_reason&#39;, &#39;pull_request&#39;, &#39;body&#39;, &#39;timeline_url&#39;, &#39;performed_via_github_app&#39;, &#39;is_pull_request&#39;],
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a>    num_rows: 808
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a>})
</span></code></pre></div></p> <p>データセットには多くの列が含まれていますが、検索エンジンの構築に必要なものはごく一部です。検索の観点から、最も情報価値の高い列は<code>title</code>、<code>body</code>、<code>comments</code>であり、<code>html_url</code>はソースイシューへのリンクを提供してくれます。<code>Dataset.remove_columns()</code>関数を使用して残りを削除しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=c1># 検索に必要な列のみを保持</span>
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a><span class=n>columns</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>column_names</span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a><span class=n>columns_to_keep</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;title&quot;</span><span class=p>,</span> <span class=s2>&quot;body&quot;</span><span class=p>,</span> <span class=s2>&quot;html_url&quot;</span><span class=p>,</span> <span class=s2>&quot;comments&quot;</span><span class=p>]</span>
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4 href=#__codelineno-99-4></a><span class=n>columns_to_remove</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>columns_to_keep</span><span class=p>)</span><span class=o>.</span><span class=n>symmetric_difference</span><span class=p>(</span><span class=n>columns</span><span class=p>)</span>
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5 href=#__codelineno-99-5></a><span class=n>issues_dataset</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=o>.</span><span class=n>remove_columns</span><span class=p>(</span><span class=n>columns_to_remove</span><span class=p>)</span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6 href=#__codelineno-99-6></a><span class=n>issues_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a>Dataset({
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a>    features: [&#39;html_url&#39;, &#39;title&#39;, &#39;comments&#39;, &#39;body&#39;],
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a>    num_rows: 808
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a>})
</span></code></pre></div></p> <p>埋め込みを作成するために、これらのフィールドには有用なコンテキスト情報が含まれることが多いため、各コメントにイシューのタイトルと本文を拡張します。<code>comments</code>列は現在各イシューのコメントのリストなので、各行が<code>(html_url, title, body, comment)</code>タプルで構成されるように列を「展開」する必要があります。Pandasでは、リストのような列の各要素に対して新しい行を作成し、他のすべての列の値を複製する<a href=https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.explode.html><code>DataFrame.explode()</code>関数</a>でこれを実行できます。これを実際に見るために、まずPandas <code>DataFrame</code>形式に切り替えましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a><span class=c1># Pandas形式に変換してデータ操作を行う</span>
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a><span class=n>issues_dataset</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;pandas&quot;</span><span class=p>)</span>
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a><span class=n>df</span> <span class=o>=</span> <span class=n>issues_dataset</span><span class=p>[:]</span>
</span></code></pre></div> <p>この<code>DataFrame</code>の最初の行を調べると、このイシューに関連する4つのコメントがあることがわかります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=c1># 最初の行のコメントリストを確認</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=n>df</span><span class=p>[</span><span class=s2>&quot;comments&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a>[&#39;Cool, I think we can do both :)&#39;,
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a> &#39;@lhoestq now the 2 are implemented.\r\n\r\nPlease note that for the the second protection, finally I have chosen to protect the master branch only from **merge commits** (see update comment above), so no need to disable/re-enable the protection on each release (direct commits, different from merge commits, can be pushed to the remote master branch; and eventually reverted without messing up the repo history).&#39;]
</span></code></pre></div></p> <p><code>df</code>を展開すると、これらのコメントのそれぞれに対して1行ずつ取得することが期待されます。それが実際にそうなのかを確認してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=c1># コメントを展開して各コメントを個別の行にする</span>
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a><span class=n>comments_df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>explode</span><span class=p>(</span><span class=s2>&quot;comments&quot;</span><span class=p>,</span> <span class=n>ignore_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=n>comments_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong></p> <table> <thead> <tr> <th>インデックス</th> <th>html_url</th> <th>title</th> <th>comments</th> <th>body</th> </tr> </thead> <tbody> <tr> <td>0</td> <td>https://github.com/huggingface/datasets/issues...</td> <td>Protect master branch</td> <td>Cool, I think we can do both :)</td> <td>After accidental merge commit (91c55355b634d0d...</td> </tr> <tr> <td>1</td> <td>https://github.com/huggingface/datasets/issues...</td> <td>Protect master branch</td> <td>@lhoestq now the 2 are implemented.\r\n\r\nPle...</td> <td>After accidental merge commit (91c55355b634d0d...</td> </tr> <tr> <td>2</td> <td>https://github.com/huggingface/datasets/issues...</td> <td>Backwards compatibility broken for cached data...</td> <td>Hi ! I guess the caching mechanism should have...</td> <td>## Describe the bug\r\nAfter upgrading to data...</td> </tr> <tr> <td>3</td> <td>https://github.com/huggingface/datasets/issues...</td> <td>Backwards compatibility broken for cached data...</td> <td>If it's easy enough to implement, then yes ple...</td> <td>## Describe the bug\r\nAfter upgrading to data...</td> </tr> </tbody> </table> <p>素晴らしい！行が複製され、<code>comments</code>列に個別のコメントが含まれていることがわかります！Pandasでの作業が終わったので、メモリ内の<code>DataFrame</code>をロードして素早く<code>Dataset</code>に戻すことができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=c1># DataFrameをDatasetに変換</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>Dataset</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4 href=#__codelineno-105-4></a><span class=n>comments_dataset</span> <span class=o>=</span> <span class=n>Dataset</span><span class=o>.</span><span class=n>from_pandas</span><span class=p>(</span><span class=n>comments_df</span><span class=p>)</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5 href=#__codelineno-105-5></a><span class=n>comments_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a>Dataset({
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a>    features: [&#39;html_url&#39;, &#39;title&#39;, &#39;comments&#39;, &#39;body&#39;],
</span><span id=__span-106-3><a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a>    num_rows: 2964
</span><span id=__span-106-4><a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a>})
</span></code></pre></div></p> <p>コメントごとに1行ができたので、コメントあたりの単語数を含む新しい<code>comments_length</code>列を作成しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a><span class=c1># コメントの長さを計算する新しい列を追加</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a><span class=n>comments_dataset</span> <span class=o>=</span> <span class=n>comments_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;comment_length&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;comments&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>())}</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a><span class=p>)</span>
</span></code></pre></div> <p>この新しい列を使用して短いコメントをフィルタリングできます。これらには通常「cc @lewtun」や「Thanks!」などの検索エンジンに関連しないものが含まれています。フィルタに選択する正確な数はありませんが、15語程度が良いスタートのようです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=c1># 15語未満の短いコメントをフィルタリング</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a><span class=n>comments_dataset</span> <span class=o>=</span> <span class=n>comments_dataset</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;comment_length&quot;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>15</span><span class=p>)</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a><span class=n>comments_dataset</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a>Filter:   0%|          | 0/2964 [00:00&lt;?, ? examples/s]
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a>
</span><span id=__span-109-3><a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a>Dataset({
</span><span id=__span-109-4><a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a>    features: [&#39;html_url&#39;, &#39;title&#39;, &#39;comments&#39;, &#39;body&#39;, &#39;comment_length&#39;],
</span><span id=__span-109-5><a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a>    num_rows: 2175
</span><span id=__span-109-6><a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a>})
</span></code></pre></div></p> <p>データセットを少しクリーンアップしたので、イシューのタイトル、説明、コメントを新しい<code>text</code>列で連結しましょう。いつものように、<code>Dataset.map()</code>に渡すことができる簡単な関数を書きます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=c1># タイトル、本文、コメントを連結する関数</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=k>def</span><span class=w> </span><span class=nf>concatenate_text</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-110-3><a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-110-4><a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a>        <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;title&quot;</span><span class=p>]</span>
</span><span id=__span-110-5><a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a>        <span class=o>+</span> <span class=s2>&quot; </span><span class=se>\n</span><span class=s2> &quot;</span>
</span><span id=__span-110-6><a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a>        <span class=o>+</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;body&quot;</span><span class=p>]</span>
</span><span id=__span-110-7><a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a>        <span class=o>+</span> <span class=s2>&quot; </span><span class=se>\n</span><span class=s2> &quot;</span>
</span><span id=__span-110-8><a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a>        <span class=o>+</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;comments&quot;</span><span class=p>]</span>
</span><span id=__span-110-9><a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a>    <span class=p>}</span>
</span><span id=__span-110-10><a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a>
</span><span id=__span-110-11><a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a><span class=n>comments_dataset</span> <span class=o>=</span> <span class=n>comments_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>concatenate_text</span><span class=p>)</span>
</span></code></pre></div> <p>ついに埋め込みを作成する準備ができました！見てみましょう。</p> <h3 id=_17>テキスト埋め込みの作成<a class=headerlink href=#_17 title="Permanent link">&para;</a></h3> <p><code>AutoModel</code>クラスを使用してトークン埋め込みを取得できます。モデルをロードするための適切なチェックポイントを選択するだけです。幸い、埋め込みの作成に特化した<code>sentence-transformers</code>というライブラリがあります。ライブラリの<a href=https://www.sbert.net/examples/applications/semantic-search/README.html#symmetric-vs-asymmetric-semantic-search>ドキュメント</a>で説明されているように、私たちのユースケースは_非対称意味検索_の例です。短いクエリがあり、その答えをイシューコメントのようなより長い文書で見つけたいからです。ドキュメントの便利な<a href=https://www.sbert.net/docs/pretrained_models.html#model-overview>モデル概要表</a>によると、<code>multi-qa-mpnet-base-dot-v1</code>チェックポイントが意味検索で最高のパフォーマンスを持っているので、アプリケーションでそれを使用します。同じチェックポイントを使用してトークナイザーもロードします：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a><span class=c1># 意味検索用のモデルとトークナイザーをロード</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>AutoTokenizer</span><span class=p>,</span> <span class=n>AutoModel</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a>
</span><span id=__span-111-4><a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a><span class=n>model_ckpt</span> <span class=o>=</span> <span class=s2>&quot;sentence-transformers/multi-qa-mpnet-base-dot-v1&quot;</span>
</span><span id=__span-111-5><a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_ckpt</span><span class=p>)</span>
</span><span id=__span-111-6><a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a><span class=n>model</span> <span class=o>=</span> <span class=n>AutoModel</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_ckpt</span><span class=p>)</span>
</span></code></pre></div> <p>埋め込みプロセスを高速化するため、モデルと入力をGPUデバイスに配置すると役立ちます。今それを行いましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a><span class=c1># モデルをGPUデバイスに移動</span>
</span><span id=__span-112-2><a id=__codelineno-112-2 name=__codelineno-112-2 href=#__codelineno-112-2></a><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span><span id=__span-112-3><a id=__codelineno-112-3 name=__codelineno-112-3 href=#__codelineno-112-3></a>
</span><span id=__span-112-4><a id=__codelineno-112-4 name=__codelineno-112-4 href=#__codelineno-112-4></a><span class=n>device</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;mps&quot;</span><span class=p>)</span>
</span><span id=__span-112-5><a id=__codelineno-112-5 name=__codelineno-112-5 href=#__codelineno-112-5></a><span class=n>model</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></code></pre></div> <p>前述のように、GitHubイシューコーパスの各エントリを単一のベクトルとして表現したいので、トークン埋め込みを何らかの方法で「プール」または平均化する必要があります。人気のあるアプローチの1つは、モデルの出力に対して<em>CLSプーリング</em>を実行することです。これは、特別な<code>[CLS]</code>トークンの最後の隠れ状態を単純に収集するものです。以下の関数がこれを実行してくれます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a><span class=c1># CLSプーリングを実行する関数</span>
</span><span id=__span-113-2><a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a><span class=k>def</span><span class=w> </span><span class=nf>cls_pooling</span><span class=p>(</span><span class=n>model_output</span><span class=p>):</span>
</span><span id=__span-113-3><a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a>    <span class=k>return</span> <span class=n>model_output</span><span class=o>.</span><span class=n>last_hidden_state</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span>
</span></code></pre></div> <p>次に、文書のリストをトークン化し、テンソルをGPUに配置し、モデルに送り、最後に出力にCLSプーリングを適用するヘルパー関数を作成します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=c1># 埋め込みを取得するヘルパー関数</span>
</span><span id=__span-114-2><a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a><span class=k>def</span><span class=w> </span><span class=nf>get_embeddings</span><span class=p>(</span><span class=n>text_list</span><span class=p>):</span>
</span><span id=__span-114-3><a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a>    <span class=n>encoded_input</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-114-4><a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a>        <span class=n>text_list</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&quot;pt&quot;</span>
</span><span id=__span-114-5><a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a>    <span class=p>)</span>
</span><span id=__span-114-6><a id=__codelineno-114-6 name=__codelineno-114-6 href=#__codelineno-114-6></a>    <span class=n>encoded_input</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>encoded_input</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span><span id=__span-114-7><a id=__codelineno-114-7 name=__codelineno-114-7 href=#__codelineno-114-7></a>    <span class=n>model_output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>encoded_input</span><span class=p>)</span>
</span><span id=__span-114-8><a id=__codelineno-114-8 name=__codelineno-114-8 href=#__codelineno-114-8></a>    <span class=k>return</span> <span class=n>cls_pooling</span><span class=p>(</span><span class=n>model_output</span><span class=p>)</span>
</span></code></pre></div> <p>コーパスの最初のテキストエントリを渡して出力形状を調べることで、関数が動作することをテストできます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a><span class=c1># 埋め込み関数をテスト</span>
</span><span id=__span-115-2><a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=n>embedding</span> <span class=o>=</span> <span class=n>get_embeddings</span><span class=p>(</span><span class=n>comments_dataset</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-115-3><a id=__codelineno-115-3 name=__codelineno-115-3 href=#__codelineno-115-3></a><span class=n>embedding</span><span class=o>.</span><span class=n>shape</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a>torch.Size([1, 768])
</span></code></pre></div></p> <p>素晴らしい！コーパスの最初のエントリを768次元ベクトルに変換しました！<code>Dataset.map()</code>を使用して<code>get_embeddings()</code>関数をコーパスの各行に適用できるので、以下のように新しい<code>embeddings</code>列を作成しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a><span class=c1># データセット全体の埋め込みを作成</span>
</span><span id=__span-117-2><a id=__codelineno-117-2 name=__codelineno-117-2 href=#__codelineno-117-2></a><span class=n>embeddings_dataset</span> <span class=o>=</span> <span class=n>comments_dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-117-3><a id=__codelineno-117-3 name=__codelineno-117-3 href=#__codelineno-117-3></a>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;embeddings&quot;</span><span class=p>:</span> <span class=n>get_embeddings</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>])</span><span class=o>.</span><span class=n>detach</span><span class=p>()</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()[</span><span class=mi>0</span><span class=p>]}</span>
</span><span id=__span-117-4><a id=__codelineno-117-4 name=__codelineno-117-4 href=#__codelineno-117-4></a><span class=p>)</span>
</span></code></pre></div> <p>埋め込みをNumPy配列に変換していることに注意してください。これは、FAISSでインデックスを付けようとするときにHugging Face Datasetsがこの形式を要求するためです。次にこれを行います。</p> <h3 id=faiss_1>効率的な類似度検索のためのFAISS<a class=headerlink href=#faiss_1 title="Permanent link">&para;</a></h3> <p>埋め込みのデータセットができたので、それらを検索する方法が必要です。これを行うために、Hugging Face Datasetsの_FAISSインデックス_と呼ばれる特別なデータ構造を使用します。<a href=https://faiss.ai/ >FAISS</a>（Facebook AI Similarity Searchの略）は、埋め込みベクトルを素早く検索およびクラスタリングするための効率的なアルゴリズムを提供するライブラリです。</p> <p>FAISSの背後にある基本的なアイデアは、入力埋め込みと類似している埋め込みを見つけることができる_インデックス_と呼ばれる特別なデータ構造を作成することです。Hugging Face DatasetsでFAISSインデックスを作成するのは簡単です。<code>Dataset.add_faiss_index()</code>関数を使用し、データセットのどの列をインデックス化したいかを指定します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a><span class=c1># FAISSインデックスを作成</span>
</span><span id=__span-118-2><a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a><span class=n>embeddings_dataset</span><span class=o>.</span><span class=n>add_faiss_index</span><span class=p>(</span><span class=n>column</span><span class=o>=</span><span class=s2>&quot;embeddings&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a>Dataset({
</span><span id=__span-119-2><a id=__codelineno-119-2 name=__codelineno-119-2 href=#__codelineno-119-2></a>    features: [&#39;html_url&#39;, &#39;title&#39;, &#39;comments&#39;, &#39;body&#39;, &#39;comment_length&#39;, &#39;text&#39;, &#39;embeddings&#39;],
</span><span id=__span-119-3><a id=__codelineno-119-3 name=__codelineno-119-3 href=#__codelineno-119-3></a>    num_rows: 2175
</span><span id=__span-119-4><a id=__codelineno-119-4 name=__codelineno-119-4 href=#__codelineno-119-4></a>})
</span></code></pre></div></p> <p><code>Dataset.get_nearest_examples()</code>関数で最近傍検索を行うことで、このインデックスでクエリを実行できるようになりました。まず以下のように質問を埋め込むことでこれをテストしてみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-120-1><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a><span class=c1># 質問を埋め込みベクトルに変換</span>
</span><span id=__span-120-2><a id=__codelineno-120-2 name=__codelineno-120-2 href=#__codelineno-120-2></a><span class=n>question</span> <span class=o>=</span> <span class=s2>&quot;How can I load a dataset offline?&quot;</span>
</span><span id=__span-120-3><a id=__codelineno-120-3 name=__codelineno-120-3 href=#__codelineno-120-3></a><span class=n>question_embedding</span> <span class=o>=</span> <span class=n>get_embeddings</span><span class=p>([</span><span class=n>question</span><span class=p>])</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>detach</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span><span id=__span-120-4><a id=__codelineno-120-4 name=__codelineno-120-4 href=#__codelineno-120-4></a><span class=n>question_embedding</span><span class=o>.</span><span class=n>shape</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-121-1><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a>(1, 768)
</span></code></pre></div></p> <p>文書と同様に、クエリを表す768次元ベクトルができました。これをコーパス全体と比較して最も類似した埋め込みを見つけることができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-122-1><a id=__codelineno-122-1 name=__codelineno-122-1 href=#__codelineno-122-1></a><span class=c1># 最も類似した例を検索</span>
</span><span id=__span-122-2><a id=__codelineno-122-2 name=__codelineno-122-2 href=#__codelineno-122-2></a><span class=n>scores</span><span class=p>,</span> <span class=n>samples</span> <span class=o>=</span> <span class=n>embeddings_dataset</span><span class=o>.</span><span class=n>get_nearest_examples</span><span class=p>(</span>
</span><span id=__span-122-3><a id=__codelineno-122-3 name=__codelineno-122-3 href=#__codelineno-122-3></a>    <span class=s2>&quot;embeddings&quot;</span><span class=p>,</span> <span class=n>question_embedding</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>5</span>
</span><span id=__span-122-4><a id=__codelineno-122-4 name=__codelineno-122-4 href=#__codelineno-122-4></a><span class=p>)</span>
</span></code></pre></div> <p><code>Dataset.get_nearest_examples()</code>関数は、クエリと文書間の重複をランク付けするスコアと、対応するサンプルセット（ここでは上位5つのマッチ）のタプルを返します。これらを<code>pandas.DataFrame</code>に集めて簡単にソートできるようにしましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-123-1><a id=__codelineno-123-1 name=__codelineno-123-1 href=#__codelineno-123-1></a><span class=c1># 結果をDataFrameに整理</span>
</span><span id=__span-123-2><a id=__codelineno-123-2 name=__codelineno-123-2 href=#__codelineno-123-2></a><span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
</span><span id=__span-123-3><a id=__codelineno-123-3 name=__codelineno-123-3 href=#__codelineno-123-3></a>
</span><span id=__span-123-4><a id=__codelineno-123-4 name=__codelineno-123-4 href=#__codelineno-123-4></a><span class=n>samples_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=o>.</span><span class=n>from_dict</span><span class=p>(</span><span class=n>samples</span><span class=p>)</span>
</span><span id=__span-123-5><a id=__codelineno-123-5 name=__codelineno-123-5 href=#__codelineno-123-5></a><span class=n>samples_df</span><span class=p>[</span><span class=s2>&quot;scores&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span>
</span><span id=__span-123-6><a id=__codelineno-123-6 name=__codelineno-123-6 href=#__codelineno-123-6></a><span class=n>samples_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s2>&quot;scores&quot;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <p>最初の数行を反復処理して、クエリが利用可能なコメントとどの程度うまくマッチしたかを確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-124-1><a id=__codelineno-124-1 name=__codelineno-124-1 href=#__codelineno-124-1></a><span class=c1># 検索結果を表示</span>
</span><span id=__span-124-2><a id=__codelineno-124-2 name=__codelineno-124-2 href=#__codelineno-124-2></a><span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>samples_df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span><span id=__span-124-3><a id=__codelineno-124-3 name=__codelineno-124-3 href=#__codelineno-124-3></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;コメント: </span><span class=si>{</span><span class=n>row</span><span class=o>.</span><span class=n>comments</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-124-4><a id=__codelineno-124-4 name=__codelineno-124-4 href=#__codelineno-124-4></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;スコア: </span><span class=si>{</span><span class=n>row</span><span class=o>.</span><span class=n>scores</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-124-5><a id=__codelineno-124-5 name=__codelineno-124-5 href=#__codelineno-124-5></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;タイトル: </span><span class=si>{</span><span class=n>row</span><span class=o>.</span><span class=n>title</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-124-6><a id=__codelineno-124-6 name=__codelineno-124-6 href=#__codelineno-124-6></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;URL: </span><span class=si>{</span><span class=n>row</span><span class=o>.</span><span class=n>html_url</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-124-7><a id=__codelineno-124-7 name=__codelineno-124-7 href=#__codelineno-124-7></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>
</span><span id=__span-124-8><a id=__codelineno-124-8 name=__codelineno-124-8 href=#__codelineno-124-8></a>    <span class=nb>print</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-125-1><a id=__codelineno-125-1 name=__codelineno-125-1 href=#__codelineno-125-1></a>    COMMENT: Requiring online connection is a deal breaker in some cases unfortunately so it&#39;d be great if offline mode is added similar to how `transformers` loads models offline fine.
</span><span id=__span-125-2><a id=__codelineno-125-2 name=__codelineno-125-2 href=#__codelineno-125-2></a>
</span><span id=__span-125-3><a id=__codelineno-125-3 name=__codelineno-125-3 href=#__codelineno-125-3></a>    @mandubian&#39;s second bullet point suggests that there&#39;s a workaround allowing you to use your offline (custom?) dataset with `datasets`. Could you please elaborate on how that should look like?
</span><span id=__span-125-4><a id=__codelineno-125-4 name=__codelineno-125-4 href=#__codelineno-125-4></a>    SCORE: 25.50501251220703
</span><span id=__span-125-5><a id=__codelineno-125-5 name=__codelineno-125-5 href=#__codelineno-125-5></a>    TITLE: Discussion using datasets in offline mode
</span><span id=__span-125-6><a id=__codelineno-125-6 name=__codelineno-125-6 href=#__codelineno-125-6></a>    URL: https://github.com/huggingface/datasets/issues/824
</span><span id=__span-125-7><a id=__codelineno-125-7 name=__codelineno-125-7 href=#__codelineno-125-7></a>    ==================================================
</span><span id=__span-125-8><a id=__codelineno-125-8 name=__codelineno-125-8 href=#__codelineno-125-8></a>
</span><span id=__span-125-9><a id=__codelineno-125-9 name=__codelineno-125-9 href=#__codelineno-125-9></a>    COMMENT: The local dataset builders (csv, text , json and pandas) are now part of the `datasets` package since #1726 :)
</span><span id=__span-125-10><a id=__codelineno-125-10 name=__codelineno-125-10 href=#__codelineno-125-10></a>    You can now use them offline
</span><span id=__span-125-11><a id=__codelineno-125-11 name=__codelineno-125-11 href=#__codelineno-125-11></a>    ```python
</span><span id=__span-125-12><a id=__codelineno-125-12 name=__codelineno-125-12 href=#__codelineno-125-12></a>    datasets = load_dataset(&#39;text&#39;, data_files=data_files)
</span><span id=__span-125-13><a id=__codelineno-125-13 name=__codelineno-125-13 href=#__codelineno-125-13></a>    ```
</span><span id=__span-125-14><a id=__codelineno-125-14 name=__codelineno-125-14 href=#__codelineno-125-14></a>
</span><span id=__span-125-15><a id=__codelineno-125-15 name=__codelineno-125-15 href=#__codelineno-125-15></a>    We&#39;ll do a new release soon
</span><span id=__span-125-16><a id=__codelineno-125-16 name=__codelineno-125-16 href=#__codelineno-125-16></a>    SCORE: 24.55551528930664
</span><span id=__span-125-17><a id=__codelineno-125-17 name=__codelineno-125-17 href=#__codelineno-125-17></a>    TITLE: Discussion using datasets in offline mode
</span><span id=__span-125-18><a id=__codelineno-125-18 name=__codelineno-125-18 href=#__codelineno-125-18></a>    URL: https://github.com/huggingface/datasets/issues/824
</span><span id=__span-125-19><a id=__codelineno-125-19 name=__codelineno-125-19 href=#__codelineno-125-19></a>    ==================================================
</span><span id=__span-125-20><a id=__codelineno-125-20 name=__codelineno-125-20 href=#__codelineno-125-20></a>
</span><span id=__span-125-21><a id=__codelineno-125-21 name=__codelineno-125-21 href=#__codelineno-125-21></a>    COMMENT: I opened a PR that allows to reload modules that have already been loaded once even if there&#39;s no internet.
</span><span id=__span-125-22><a id=__codelineno-125-22 name=__codelineno-125-22 href=#__codelineno-125-22></a>
</span><span id=__span-125-23><a id=__codelineno-125-23 name=__codelineno-125-23 href=#__codelineno-125-23></a>    Let me know if you know other ways that can make the offline mode experience better. I&#39;d be happy to add them :) 
</span><span id=__span-125-24><a id=__codelineno-125-24 name=__codelineno-125-24 href=#__codelineno-125-24></a>
</span><span id=__span-125-25><a id=__codelineno-125-25 name=__codelineno-125-25 href=#__codelineno-125-25></a>    I already note the &quot;freeze&quot; modules option, to prevent local modules updates. It would be a cool feature.
</span><span id=__span-125-26><a id=__codelineno-125-26 name=__codelineno-125-26 href=#__codelineno-125-26></a>
</span><span id=__span-125-27><a id=__codelineno-125-27 name=__codelineno-125-27 href=#__codelineno-125-27></a>    ----------
</span><span id=__span-125-28><a id=__codelineno-125-28 name=__codelineno-125-28 href=#__codelineno-125-28></a>
</span><span id=__span-125-29><a id=__codelineno-125-29 name=__codelineno-125-29 href=#__codelineno-125-29></a>    &gt; @mandubian&#39;s second bullet point suggests that there&#39;s a workaround allowing you to use your offline (custom?) dataset with `datasets`. Could you please elaborate on how that should look like?
</span><span id=__span-125-30><a id=__codelineno-125-30 name=__codelineno-125-30 href=#__codelineno-125-30></a>
</span><span id=__span-125-31><a id=__codelineno-125-31 name=__codelineno-125-31 href=#__codelineno-125-31></a>    Indeed `load_dataset` allows to load remote dataset script (squad, glue, etc.) but also you own local ones.
</span><span id=__span-125-32><a id=__codelineno-125-32 name=__codelineno-125-32 href=#__codelineno-125-32></a>    For example if you have a dataset script at `./my_dataset/my_dataset.py` then you can do
</span><span id=__span-125-33><a id=__codelineno-125-33 name=__codelineno-125-33 href=#__codelineno-125-33></a>    ```python
</span><span id=__span-125-34><a id=__codelineno-125-34 name=__codelineno-125-34 href=#__codelineno-125-34></a>    load_dataset(&quot;./my_dataset&quot;)
</span><span id=__span-125-35><a id=__codelineno-125-35 name=__codelineno-125-35 href=#__codelineno-125-35></a>    ```
</span><span id=__span-125-36><a id=__codelineno-125-36 name=__codelineno-125-36 href=#__codelineno-125-36></a>    and the dataset script will generate your dataset once and for all.
</span><span id=__span-125-37><a id=__codelineno-125-37 name=__codelineno-125-37 href=#__codelineno-125-37></a>
</span><span id=__span-125-38><a id=__codelineno-125-38 name=__codelineno-125-38 href=#__codelineno-125-38></a>    ----------
</span><span id=__span-125-39><a id=__codelineno-125-39 name=__codelineno-125-39 href=#__codelineno-125-39></a>
</span><span id=__span-125-40><a id=__codelineno-125-40 name=__codelineno-125-40 href=#__codelineno-125-40></a>    About I&#39;m looking into having `csv`, `json`, `text`, `pandas` dataset builders already included in the `datasets` package, so that they are available offline by default, as opposed to the other datasets that require the script to be downloaded.
</span><span id=__span-125-41><a id=__codelineno-125-41 name=__codelineno-125-41 href=#__codelineno-125-41></a>    cf #1724 
</span><span id=__span-125-42><a id=__codelineno-125-42 name=__codelineno-125-42 href=#__codelineno-125-42></a>    SCORE: 24.14898681640625
</span><span id=__span-125-43><a id=__codelineno-125-43 name=__codelineno-125-43 href=#__codelineno-125-43></a>    TITLE: Discussion using datasets in offline mode
</span><span id=__span-125-44><a id=__codelineno-125-44 name=__codelineno-125-44 href=#__codelineno-125-44></a>    URL: https://github.com/huggingface/datasets/issues/824
</span><span id=__span-125-45><a id=__codelineno-125-45 name=__codelineno-125-45 href=#__codelineno-125-45></a>    ==================================================
</span><span id=__span-125-46><a id=__codelineno-125-46 name=__codelineno-125-46 href=#__codelineno-125-46></a>
</span><span id=__span-125-47><a id=__codelineno-125-47 name=__codelineno-125-47 href=#__codelineno-125-47></a>    COMMENT: &gt; here is my way to load a dataset offline, but it **requires** an online machine
</span><span id=__span-125-48><a id=__codelineno-125-48 name=__codelineno-125-48 href=#__codelineno-125-48></a>    &gt; 
</span><span id=__span-125-49><a id=__codelineno-125-49 name=__codelineno-125-49 href=#__codelineno-125-49></a>    &gt; 1. (online machine)
</span><span id=__span-125-50><a id=__codelineno-125-50 name=__codelineno-125-50 href=#__codelineno-125-50></a>    &gt; 
</span><span id=__span-125-51><a id=__codelineno-125-51 name=__codelineno-125-51 href=#__codelineno-125-51></a>    &gt; ```
</span><span id=__span-125-52><a id=__codelineno-125-52 name=__codelineno-125-52 href=#__codelineno-125-52></a>    &gt; 
</span><span id=__span-125-53><a id=__codelineno-125-53 name=__codelineno-125-53 href=#__codelineno-125-53></a>    &gt; import datasets
</span><span id=__span-125-54><a id=__codelineno-125-54 name=__codelineno-125-54 href=#__codelineno-125-54></a>    &gt; 
</span><span id=__span-125-55><a id=__codelineno-125-55 name=__codelineno-125-55 href=#__codelineno-125-55></a>    &gt; data = datasets.load_dataset(...)
</span><span id=__span-125-56><a id=__codelineno-125-56 name=__codelineno-125-56 href=#__codelineno-125-56></a>    &gt; 
</span><span id=__span-125-57><a id=__codelineno-125-57 name=__codelineno-125-57 href=#__codelineno-125-57></a>    &gt; data.save_to_disk(/YOUR/DATASET/DIR)
</span><span id=__span-125-58><a id=__codelineno-125-58 name=__codelineno-125-58 href=#__codelineno-125-58></a>    &gt; 
</span><span id=__span-125-59><a id=__codelineno-125-59 name=__codelineno-125-59 href=#__codelineno-125-59></a>    &gt; ```
</span><span id=__span-125-60><a id=__codelineno-125-60 name=__codelineno-125-60 href=#__codelineno-125-60></a>    &gt; 
</span><span id=__span-125-61><a id=__codelineno-125-61 name=__codelineno-125-61 href=#__codelineno-125-61></a>    &gt; 2. copy the dir from online to the offline machine
</span><span id=__span-125-62><a id=__codelineno-125-62 name=__codelineno-125-62 href=#__codelineno-125-62></a>    &gt; 
</span><span id=__span-125-63><a id=__codelineno-125-63 name=__codelineno-125-63 href=#__codelineno-125-63></a>    &gt; 3. (offline machine)
</span><span id=__span-125-64><a id=__codelineno-125-64 name=__codelineno-125-64 href=#__codelineno-125-64></a>    &gt; 
</span><span id=__span-125-65><a id=__codelineno-125-65 name=__codelineno-125-65 href=#__codelineno-125-65></a>    &gt; ```
</span><span id=__span-125-66><a id=__codelineno-125-66 name=__codelineno-125-66 href=#__codelineno-125-66></a>    &gt; 
</span><span id=__span-125-67><a id=__codelineno-125-67 name=__codelineno-125-67 href=#__codelineno-125-67></a>    &gt; import datasets
</span><span id=__span-125-68><a id=__codelineno-125-68 name=__codelineno-125-68 href=#__codelineno-125-68></a>    &gt; 
</span><span id=__span-125-69><a id=__codelineno-125-69 name=__codelineno-125-69 href=#__codelineno-125-69></a>    &gt; data = datasets.load_from_disk(/SAVED/DATA/DIR)
</span><span id=__span-125-70><a id=__codelineno-125-70 name=__codelineno-125-70 href=#__codelineno-125-70></a>    &gt; 
</span><span id=__span-125-71><a id=__codelineno-125-71 name=__codelineno-125-71 href=#__codelineno-125-71></a>    &gt; ```
</span><span id=__span-125-72><a id=__codelineno-125-72 name=__codelineno-125-72 href=#__codelineno-125-72></a>    &gt; 
</span><span id=__span-125-73><a id=__codelineno-125-73 name=__codelineno-125-73 href=#__codelineno-125-73></a>    &gt; 
</span><span id=__span-125-74><a id=__codelineno-125-74 name=__codelineno-125-74 href=#__codelineno-125-74></a>    &gt; 
</span><span id=__span-125-75><a id=__codelineno-125-75 name=__codelineno-125-75 href=#__codelineno-125-75></a>    &gt; HTH.
</span><span id=__span-125-76><a id=__codelineno-125-76 name=__codelineno-125-76 href=#__codelineno-125-76></a>
</span><span id=__span-125-77><a id=__codelineno-125-77 name=__codelineno-125-77 href=#__codelineno-125-77></a>
</span><span id=__span-125-78><a id=__codelineno-125-78 name=__codelineno-125-78 href=#__codelineno-125-78></a>    SCORE: 22.894004821777344
</span><span id=__span-125-79><a id=__codelineno-125-79 name=__codelineno-125-79 href=#__codelineno-125-79></a>    TITLE: Discussion using datasets in offline mode
</span><span id=__span-125-80><a id=__codelineno-125-80 name=__codelineno-125-80 href=#__codelineno-125-80></a>    URL: https://github.com/huggingface/datasets/issues/824
</span><span id=__span-125-81><a id=__codelineno-125-81 name=__codelineno-125-81 href=#__codelineno-125-81></a>    ==================================================
</span><span id=__span-125-82><a id=__codelineno-125-82 name=__codelineno-125-82 href=#__codelineno-125-82></a>
</span><span id=__span-125-83><a id=__codelineno-125-83 name=__codelineno-125-83 href=#__codelineno-125-83></a>    COMMENT: here is my way to load a dataset offline, but it **requires** an online machine
</span><span id=__span-125-84><a id=__codelineno-125-84 name=__codelineno-125-84 href=#__codelineno-125-84></a>    1. (online machine)
</span><span id=__span-125-85><a id=__codelineno-125-85 name=__codelineno-125-85 href=#__codelineno-125-85></a>    ```
</span><span id=__span-125-86><a id=__codelineno-125-86 name=__codelineno-125-86 href=#__codelineno-125-86></a>    import datasets
</span><span id=__span-125-87><a id=__codelineno-125-87 name=__codelineno-125-87 href=#__codelineno-125-87></a>    data = datasets.load_dataset(...)
</span><span id=__span-125-88><a id=__codelineno-125-88 name=__codelineno-125-88 href=#__codelineno-125-88></a>    data.save_to_disk(/YOUR/DATASET/DIR)
</span><span id=__span-125-89><a id=__codelineno-125-89 name=__codelineno-125-89 href=#__codelineno-125-89></a>    ```
</span><span id=__span-125-90><a id=__codelineno-125-90 name=__codelineno-125-90 href=#__codelineno-125-90></a>    2. copy the dir from online to the offline machine
</span><span id=__span-125-91><a id=__codelineno-125-91 name=__codelineno-125-91 href=#__codelineno-125-91></a>    3. (offline machine)
</span><span id=__span-125-92><a id=__codelineno-125-92 name=__codelineno-125-92 href=#__codelineno-125-92></a>    ```
</span><span id=__span-125-93><a id=__codelineno-125-93 name=__codelineno-125-93 href=#__codelineno-125-93></a>    import datasets
</span><span id=__span-125-94><a id=__codelineno-125-94 name=__codelineno-125-94 href=#__codelineno-125-94></a>    data = datasets.load_from_disk(/SAVED/DATA/DIR)
</span><span id=__span-125-95><a id=__codelineno-125-95 name=__codelineno-125-95 href=#__codelineno-125-95></a>    ```
</span><span id=__span-125-96><a id=__codelineno-125-96 name=__codelineno-125-96 href=#__codelineno-125-96></a>
</span><span id=__span-125-97><a id=__codelineno-125-97 name=__codelineno-125-97 href=#__codelineno-125-97></a>    HTH.
</span><span id=__span-125-98><a id=__codelineno-125-98 name=__codelineno-125-98 href=#__codelineno-125-98></a>    SCORE: 22.406654357910156
</span><span id=__span-125-99><a id=__codelineno-125-99 name=__codelineno-125-99 href=#__codelineno-125-99></a>    TITLE: Discussion using datasets in offline mode
</span><span id=__span-125-100><a id=__codelineno-125-100 name=__codelineno-125-100 href=#__codelineno-125-100></a>    URL: https://github.com/huggingface/datasets/issues/824
</span><span id=__span-125-101><a id=__codelineno-125-101 name=__codelineno-125-101 href=#__codelineno-125-101></a>    ==================================================
</span></code></pre></div></p> <p>悪くありません！2番目のヒットがクエリにマッチしているようです。</p> <h2 id=_18>まとめ<a class=headerlink href=#_18 title="Permanent link">&para;</a></h2> <p>この記事では、Hugging Face Datasetsライブラリの包括的な使用方法を学びました。主な学習ポイントを振り返ってみましょう：</p> <p><strong>データセットの読み込みと操作</strong> - ローカルおよびリモートファイルからのデータセット読み込み方法 - CSV、JSON、TSV、Pandasなど様々な形式への対応 - 自動解凍機能による効率的なファイル処理</p> <p><strong>データの前処理とクリーニング</strong> - <code>Dataset.map()</code>を使用した効率的なデータ変換 - バッチ処理とマルチプロセッシングによる高速化 - Pandasとの相互運用性による高度なデータ操作</p> <p><strong>データセットの保存と管理</strong> - Arrow、CSV、JSON形式での保存オプション - 検証セットの作成による適切なモデル評価体制の構築 - メモリ効率的なデータ管理手法</p> <p><strong>実践的なアプリケーション</strong> - GitHub APIを使用した独自データセットの作成 - FAISSを活用した高速な意味検索システムの構築 - トランスフォーマーモデルによるテキスト埋め込みの生成</p> <h2 id=_19>次のステップ<a class=headerlink href=#_19 title="Permanent link">&para;</a></h2> <p>この記事で学んだ技術を活用して、以下のような発展的なプロジェクトに取り組むことができます：</p> <ul> <li>より大規模なデータセットでの分散処理</li> <li>カスタム埋め込みモデルの作成と最適化</li> <li>マルチモーダル検索システムの構築</li> <li>ストリーミングデータセットの処理</li> </ul> <h2 id=_20>参考資料<a class=headerlink href=#_20 title="Permanent link">&para;</a></h2> <ul> <li><a href=https://huggingface.co/docs/datasets>Hugging Face Datasets公式ドキュメント</a></li> <li><a href=https://faiss.ai/ >FAISS公式ドキュメント</a></li> <li><a href=https://www.sbert.net/ >Sentence Transformersライブラリ</a></li> <li><a href=https://arrow.apache.org/ >Apache Arrow仕様</a></li> <li><a href=https://docs.github.com/en/rest>GitHub REST API仕様</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最終更新日> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年9月28日 19:08:34 JST">2025年9月28日 19:08:34</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> ページトップへ戻る </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 - 2025 vinsmoke-three </div> </div> <div class=md-social> <a href=https://github.com/vinsmoke-three target=_blank rel=noopener title=GitHub class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.copy", "navigation.expand", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"BERT": "bert", "CNN": "convolutional-neural-network", "FashionMNIST": "fashion-mnist", "GPT": "gpt", "LLM": "large-language-model", "ML\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3": "ml-pipeline", "NLP": "nlp", "PyTorch": "pytorch", "Python": "python", "TensorBoard": "tensorboard", "TinyVGG": "tinyvgg", "Transformer": "transformer", "\u30ab\u30b9\u30bf\u30e0\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8": "custom-datasets", "\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30d3\u30b8\u30e7\u30f3": "computer-vision", "\u30b9\u30af\u30ea\u30d7\u30c8\u30e2\u30fc\u30c9": "script-mode", "\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb": "tutorial", "\u30c6\u30f3\u30bd\u30eb": "tensor", "\u30c7\u30fc\u30bf\u62e1\u5f35": "data-augmentation", "\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af": "neural-network", "\u30e2\u30b8\u30e5\u30fc\u30eb\u5316": "modularization", "\u30ef\u30fc\u30af\u30d5\u30ed\u30fc": "workflow", "\u4e0a\u7d1a\u8005\u5411\u3051": "advanced", "\u4e2d\u7d1a\u8005\u5411\u3051": "intermediate", "\u518d\u5229\u7528": "reusability", "\u5206\u985e": "classification", "\u521d\u5fc3\u8005\u5411\u3051": "beginner", "\u5927\u898f\u6a21\u8a00\u8a9e\u30e2\u30c7\u30eb": "large-language-model", "\u5b9f\u8df5": "practical", "\u5b9f\u9a13\u8ffd\u8de1": "experiment-tracking", "\u6a5f\u68b0\u5b66\u7fd2": "machine-learning", "\u6df1\u5c64\u5b66\u7fd2": "deep-learning", "\u753b\u50cf\u5206\u985e": "image-classification", "\u7dda\u5f62\u56de\u5e30": "linear-regression", "\u81ea\u7136\u8a00\u8a9e\u51e6\u7406": "natural-language-processing", "\u8ee2\u79fb\u5b66\u7fd2": "transfer-learning"}, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=../../javascripts/meta.js></script> <script src=../../javascripts/structured-data.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>