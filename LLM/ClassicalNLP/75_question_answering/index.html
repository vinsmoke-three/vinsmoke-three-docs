<!doctype html><html lang=ja class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=BERTモデルをSQuADデータセットでファインチューニングして、高精度な質問応答システムを構築する方法を詳細に解説します。データの前処理からモデル学習、評価まで完全カバー。><meta name=author content=vinsmoke-three><link href=https://vinsmoke-three.com/LLM/ClassicalNLP/75_question_answering/ rel=canonical><link href=../74_summarization/ rel=prev><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.20"><title>SQuAD質問応答システムの構築 - BERTファインチューニング完全ガイド - vinsmoke-three - 機械学習・深層学習ドキュメント</title><link rel=stylesheet href=../../../assets/stylesheets/main.e53b48f4.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-BXKYE0NT9N"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-BXKYE0NT9N",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-BXKYE0NT9N",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#squad-bert class=md-skip> コンテンツにスキップ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=ヘッダー> <a href=../../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-header__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> vinsmoke-three - 機械学習・深層学習ドキュメント </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> SQuAD質問応答システムの構築 - BERTファインチューニング完全ガイド </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=検索 placeholder=検索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=検索> <a href=javascript:void(0) class="md-search__icon md-icon" title=共有 aria-label=共有 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=クリア aria-label=クリア tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 検索を初期化 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=タブ data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../PyTorch/00_setup/ class=md-tabs__link> PyTorch </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../00_illustrated_transformer/ class=md-tabs__link> LLM </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=ナビゲーション data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-nav__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> vinsmoke-three - 機械学習・深層学習ドキュメント </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> PyTorch </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> PyTorch </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../PyTorch/00_setup/ class=md-nav__link> <span class=md-ellipsis> 0. setup </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/01_pytorch_fundamentals/ class=md-nav__link> <span class=md-ellipsis> 1. PyTorch fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/02_pytorch_workflow/ class=md-nav__link> <span class=md-ellipsis> 2. PyTorch workflow </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/03_pytorch_classification/ class=md-nav__link> <span class=md-ellipsis> 3. PyTorch classification </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/04_pytorch_computer_vision/ class=md-nav__link> <span class=md-ellipsis> 4. PyTorch computer vision </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/05_pytorch_custom_datasets/ class=md-nav__link> <span class=md-ellipsis> 5. PyTorch custom datasets </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/06_pytorch_modular/ class=md-nav__link> <span class=md-ellipsis> 6. PyTorch modular </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/07_pytorch_transfer_learning/ class=md-nav__link> <span class=md-ellipsis> 7. PyTorch transfer learning </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/08_pytorch_experiment_tracking/ class=md-nav__link> <span class=md-ellipsis> 8. PyTorch experiment tracking </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/09_pytorch_paper_replicating/ class=md-nav__link> <span class=md-ellipsis> 9. PyTorch paper replicating </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/10_pytorch_model_deployment/ class=md-nav__link> <span class=md-ellipsis> 10. PyTorch model deployment </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> LLM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LLM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../00_illustrated_transformer/ class=md-nav__link> <span class=md-ellipsis> 0. The illustrated transformer </span> </a> </li> <li class=md-nav__item> <a href=../../01_transformer_models/ class=md-nav__link> <span class=md-ellipsis> 1. Transformer models </span> </a> </li> <li class=md-nav__item> <a href=../../02_using_transformers/ class=md-nav__link> <span class=md-ellipsis> 2. Using transformers </span> </a> </li> <li class=md-nav__item> <a href=../../03_fine_tuning_a_pretrained_model/ class=md-nav__link> <span class=md-ellipsis> 3. Fine-tuning a pretrained model </span> </a> </li> <li class=md-nav__item> <a href=../../04_the_huggingface_tokenizers_library/ class=md-nav__link> <span class=md-ellipsis> 4. Tokenizers library </span> </a> </li> <li class=md-nav__item> <a href=../../05_Let%27s_build_GPT_from_scratch/ class=md-nav__link> <span class=md-ellipsis> 5. Let't build GPT from scratch </span> </a> </li> <li class=md-nav__item> <a href=../../06_the_huggingface_datasets_library/ class=md-nav__link> <span class=md-ellipsis> 6. Datasets library </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8 checked> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex=0> <span class=md-ellipsis> 7. Classical NLP Tasks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=true> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> 7. Classical NLP Tasks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../71_token_classification/ class=md-nav__link> <span class=md-ellipsis> Token Classification </span> </a> </li> <li class=md-nav__item> <a href=../72_masked_language_modeling/ class=md-nav__link> <span class=md-ellipsis> Masked Language Modeling </span> </a> </li> <li class=md-nav__item> <a href=../73_translation/ class=md-nav__link> <span class=md-ellipsis> Translation </span> </a> </li> <li class=md-nav__item> <a href=../74_summarization/ class=md-nav__link> <span class=md-ellipsis> Summarization </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Question Answering </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Question Answering </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 質問応答とは </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> データの準備 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 訓練データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 検証データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#trainerapi class=md-nav__link> <span class=md-ellipsis> TrainerAPIによるファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> カスタム訓練ループ </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> ファインチューニング済みモデルの使用 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 評価指標の解説 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 質問応答とは </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> データの準備 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 訓練データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 検証データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#trainerapi class=md-nav__link> <span class=md-ellipsis> TrainerAPIによるファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> カスタム訓練ループ </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> ファインチューニング済みモデルの使用 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 評価指標の解説 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=squad-bert>SQuAD質問応答システムの構築 - BERTファインチューニング完全ガイド<a class=headerlink href=#squad-bert title="Permanent link">&para;</a></h1> <h2 id=_1>概要<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>この記事では、BERTモデルをSQuADデータセットでファインチューニングして、高精度な質問応答システムを構築する方法を解説します。質問応答（Question Answering）は自然言語処理の重要なタスクの一つで、文書から質問に対する答えを抽出する技術です。</p> <div class="admonition info"> <p class=admonition-title>参考資料</p> <p>本ドキュメントは <a href=https://huggingface.co/learn/llm-course/chapter7/7>Hugging Face LLM Course</a> を参考に、日本語で学習内容をまとめた個人的な学習ノートです。詳細な内容や最新情報については、原文も併せてご参照ください。</p> </div> <h2 id=_2>前提知識<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <ul> <li>Python基礎プログラミング</li> <li>機械学習の基本概念</li> <li>transformersライブラリの基本的な使用方法</li> <li>PyTorchの基礎知識</li> </ul> <h2 id=_3>質問応答とは<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>質問応答にはさまざまな形式がありますが、この記事では<strong>抽出型質問応答</strong>（extractive question answering）に焦点を当てます。これは、文書について質問し、その答えを文書内のテキストスパンとして特定するタスクです。</p> <p>私たちは<a href=https://rajpurkar.github.io/SQuAD-explorer/ >SQuAD dataset</a>でBERTモデルをファインチューニングします。SQuADは、Wikipedia記事に対してクラウドワーカーが作成した質問で構成されています。</p> <h2 id=_4>データの準備<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>抽出型質問応答の学術ベンチマークとして最も使用されているのは<a href=https://rajpurkar.github.io/SQuAD-explorer/ >SQuAD</a>なので、今回はこれを使用します。より困難な<a href=https://huggingface.co/datasets/rajpurkar/squad_v2>SQuAD v2</a>ベンチマークもあり、これには答えが存在しない質問も含まれています。</p> <h3 id=squad>SQuADデータセットの読み込み<a class=headerlink href=#squad title="Permanent link">&para;</a></h3> <p><code>load_dataset()</code>を使用してデータセットを簡単にダウンロード・キャッシュできます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_dataset</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=n>raw_datasets</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;rajpurkar/squad_v2&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>DatasetDict({
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>    train: Dataset({
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>        num_rows: 130319
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>    })
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>    validation: Dataset({
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        num_rows: 11873
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    })
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>})
</span></code></pre></div></p> <p>データセットの構造を確認してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>raw_datasets</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>DatasetDict({
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    train: Dataset({
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>        num_rows: 130319
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    })
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    validation: Dataset({
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        num_rows: 11873
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    })
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>})
</span></code></pre></div></p> <p>必要な<code>context</code>、<code>question</code>、<code>answers</code>フィールドがすべて揃っています。訓練セットの最初の要素を見てみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Context: &quot;</span><span class=p>,</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;context&quot;</span><span class=p>])</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Question: &quot;</span><span class=p>,</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;question&quot;</span><span class=p>])</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Answer: &quot;</span><span class=p>,</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;answers&quot;</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>Context:  BeyoncÃ© Giselle Knowles-Carter (/biËËˆjÉ&#39;nseÉª/ bee-YON-say) (born September 4, 1981) is an American singer, songwriter, record producer and actress. Born and raised in Houston, Texas, she performed in various singing and dancing competitions as a child, and rose to fame in the late 1990s as lead singer of R&amp;B girl-group Destiny&#39;s Child. Managed by her father, Mathew Knowles, the group became one of the world&#39;s best-selling girl groups of all time. Their hiatus saw the release of BeyoncÃ©&#39;s debut album, Dangerously in Love (2003), which established her as a solo artist worldwide, earned five Grammy Awards and featured the Billboard Hot 100 number-one singles &quot;Crazy in Love&quot; and &quot;Baby Boy&quot;.
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>Question:  When did Beyonce start becoming popular?
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>Answer:  {&#39;text&#39;: [&#39;in the late 1990s&#39;], &#39;answer_start&#39;: [269]}
</span></code></pre></div></p> <p><code>context</code>と<code>question</code>フィールドは直感的です。<code>answers</code>フィールドは少し複雑で、どちらもリストである2つのフィールドを持つ辞書形式になっています。<code>text</code>フィールドは明確で、<code>answer_start</code>フィールドには文脈内での各答えの開始文字インデックスが含まれています。</p> <p>SQuAD2.0では、SQuAD1.1の10万問に加えて、5万問以上の答えのない質問が追加されています。これらは、答えのある質問に似せてクラウドワーカーが作成した対抗的な質問です。</p> <p>答えのない質問を確認してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>unanswerable</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&quot;answers&quot;</span><span class=p>][</span><span class=s2>&quot;text&quot;</span><span class=p>])</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>unanswerable</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>{&#39;id&#39;: &#39;5a8d7bf7df8bba001a0f9ab1&#39;,
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a> &#39;title&#39;: &#39;The_Legend_of_Zelda:_Twilight_Princess&#39;,
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a> &#39;context&#39;: &#39;The Legend of Zelda: Twilight Princess (Japanese: ゼルダの伝説 トワイライトプリンセス, Hepburn: Zeruda no Densetsu: Towairaito Purinsesu?) is an action-adventure game developed and published by Nintendo for the GameCube and Wii home video game consoles. It is the thirteenth installment in the The Legend of Zelda series. Originally planned for release on the GameCube in November 2005, Twilight Princess was delayed by Nintendo to allow its developers to refine the game, add more content, and port it to the Wii. The Wii version was released alongside the console in North America in November 2006, and in Japan, Europe, and Australia the following month. The GameCube version was released worldwide in December 2006.[b]&#39;,
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a> &#39;question&#39;: &#39;What category of game is Legend of Zelda: Australia Twilight?&#39;,
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a> &#39;answers&#39;: {&#39;text&#39;: [], &#39;answer_start&#39;: []}}
</span></code></pre></div></p> <p>評価時には、各サンプルに対して複数の正解が存在する場合があります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=nb>print</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>][</span><span class=mi>132</span><span class=p>][</span><span class=s2>&quot;answers&quot;</span><span class=p>])</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=nb>print</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>][</span><span class=mi>3</span><span class=p>][</span><span class=s2>&quot;answers&quot;</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>{&#39;text&#39;: [&#39;1018&#39;, &#39;1064&#39;, &#39;1018&#39;], &#39;answer_start&#39;: [221, 345, 221]}
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>{&#39;text&#39;: [&#39;Rollo&#39;, &#39;Rollo&#39;, &#39;Rollo&#39;, &#39;Rollo&#39;], &#39;answer_start&#39;: [308, 308, 308, 308]}
</span></code></pre></div></p> <p>例として、インデックス132のサンプルを見てみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=nb>print</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>][</span><span class=mi>132</span><span class=p>][</span><span class=s2>&quot;context&quot;</span><span class=p>])</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=nb>print</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>][</span><span class=mi>132</span><span class=p>][</span><span class=s2>&quot;question&quot;</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>The legendary religious zeal of the Normans was exercised in religious wars long before the First Crusade carved out a Norman principality in Antioch. They were major foreign participants in the Reconquista in Iberia. In 1018, Roger de Tosny travelled to the Iberian Peninsula to carve out a state for himself from Moorish lands, but failed. In 1064, during the War of Barbastro, William of Montreuil led the papal army and took a huge booty.
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>What year did Roger de Tosny fail to accomplish what he set out to do?
</span></code></pre></div></p> <h2 id=_5>訓練データの前処理<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <p>訓練データの前処理から始めましょう。最も重要な処理は、質問の答えのラベルを生成することです。これは、文脈内で答えに対応するトークンの開始位置と終了位置になります。</p> <p>まず、tokenizerを使用してテキストをモデルが理解できるIDに変換する必要があります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>AutoTokenizer</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=n>model_checkpoint</span> <span class=o>=</span> <span class=s2>&quot;bert-base-cased&quot;</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_checkpoint</span><span class=p>)</span>
</span></code></pre></div> <p>BERTモデルをファインチューニングしますが、高速tokenizerが実装されている他のモデルタイプも使用できます。<code>is_fast</code>属性を確認して、tokenizerが実際に🤗 Tokenizersによってサポートされているか確認できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=n>tokenizer</span><span class=o>.</span><span class=n>is_fast</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>True
</span></code></pre></div></p> <p>tokenizerに質問と文脈を一緒に渡すことで、適切な特殊トークンが挿入された以下のような文が形成されます：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>[CLS] question [SEP] context [SEP]
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=n>context</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;context&quot;</span><span class=p>]</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=n>question</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;question&quot;</span><span class=p>]</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>question</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>&#39;[CLS] When did Beyonce start becoming popular? [SEP] BeyoncÃ© Giselle Knowles - Carter ( / [UNK] / bee - YON - say ) ( born September 4, 1981 ) is an American singer, songwriter, record producer and actress. Born and raised in Houston, Texas, she performed in various singing and dancing competitions as a child, and rose to fame in the late 1990s as lead singer of R &amp; B girl - group Destiny \&#39; s Child. Managed by her father, Mathew Knowles, the group became one of the world \&#39; s best - selling girl groups of all time. Their hiatus saw the release of BeyoncÃ© \&#39; s debut album, Dangerously in Love ( 2003 ), which established her as a solo artist worldwide, earned five Grammy Awards and featured the Billboard Hot 100 number - one singles &quot; Crazy in Love &quot; and &quot; Baby Boy &quot;. [SEP]&#39;
</span></code></pre></div></p> <h3 id=_6>長い文脈への対応<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>この例では文脈は長すぎませんが、データセット内の一部の例では、設定した最大長（ここでは384）を超える非常に長い文脈があります。長い文脈を処理するために、スライディングウィンドウを使用して1つのサンプルから複数の訓練特徴を作成します。</p> <p>現在の例を使って、長さを100に制限し、50トークンのスライディングウィンドウを使用する方法を見てみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>    <span class=n>question</span><span class=p>,</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>    <span class=n>context</span><span class=p>,</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>    <span class=n>truncation</span><span class=o>=</span><span class=s2>&quot;only_second&quot;</span><span class=p>,</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>    <span class=n>stride</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>    <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=p>)</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=k>for</span> <span class=n>ids</span> <span class=ow>in</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>]:</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>    <span class=nb>print</span><span class=p>(</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>ids</span><span class=p>))</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>[CLS] When did Beyonce start becoming popular? [SEP] BeyoncÃ© Giselle Knowles - Carter ( / [UNK] / bee - YON - say ) ( born September 4, 1981 ) is an American singer, songwriter, record producer and actress. Born and raised in Houston, Texas, she performed in various singing and dancing competitions as a child, and rose to fame in the late 1990s as lead singer of R &amp; B girl - group Destiny &#39; s Child. Managed by her father, Mathew Knowles [SEP]
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>[CLS] When did Beyonce start becoming popular? [SEP] raised in Houston, Texas, she performed in various singing and dancing competitions as a child, and rose to fame in the late 1990s as lead singer of R &amp; B girl - group Destiny &#39; s Child. Managed by her father, Mathew Knowles, the group became one of the world &#39; s best - selling girl groups of all time. Their hiatus saw the release of BeyoncÃ© &#39; s debut album, Dangerously in Love ( 2003 ) [SEP]
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>[CLS] When did Beyonce start becoming popular? [SEP] s Child. Managed by her father, Mathew Knowles, the group became one of the world &#39; s best - selling girl groups of all time. Their hiatus saw the release of BeyoncÃ© &#39; s debut album, Dangerously in Love ( 2003 ), which established her as a solo artist worldwide, earned five Grammy Awards and featured the Billboard Hot 100 number - one singles &quot; Crazy in Love &quot; and &quot; Baby Boy &quot;. [SEP]
</span></code></pre></div></p> <p>例が4つの入力に分割され、それぞれが質問と文脈の一部を含んでいることがわかります。答えが文脈に完全に含まれない場合は、ラベルを<code>start_position = end_position = 0</code>（<code>[CLS]</code>トークンを予測）に設定します。</p> <h3 id=_7>オフセットマッピングの活用<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>オフセットマッピングを取得するために、<code>return_offsets_mapping=True</code>を渡します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>    <span class=n>question</span><span class=p>,</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>    <span class=n>context</span><span class=p>,</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>    <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>    <span class=n>truncation</span><span class=o>=</span><span class=s2>&quot;only_second&quot;</span><span class=p>,</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>    <span class=n>stride</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>    <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>    <span class=n>return_offsets_mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=n>inputs</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>dict_keys([&#39;input_ids&#39;, &#39;token_type_ids&#39;, &#39;attention_mask&#39;, &#39;offset_mapping&#39;, &#39;overflow_to_sample_mapping&#39;])
</span></code></pre></div></p> <p><code>overflow_to_sample_mapping</code>は、各特徴がどの例から生成されたかを示します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>[0, 0, 0]
</span></code></pre></div></p> <p>複数の例をtokenizeすると、この情報がより有用になります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>    <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>2</span><span class=p>:</span><span class=mi>6</span><span class=p>][</span><span class=s2>&quot;question&quot;</span><span class=p>],</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>    <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>2</span><span class=p>:</span><span class=mi>6</span><span class=p>][</span><span class=s2>&quot;context&quot;</span><span class=p>],</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>    <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>    <span class=n>truncation</span><span class=o>=</span><span class=s2>&quot;only_second&quot;</span><span class=p>,</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>    <span class=n>stride</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>    <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>    <span class=n>return_offsets_mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=p>)</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;4つの例から</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s1>&#39;input_ids&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>個の特徴が生成されました。&quot;</span><span class=p>)</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;各特徴の元の例: </span><span class=si>{</span><span class=n>inputs</span><span class=p>[</span><span class=s1>&#39;overflow_to_sample_mapping&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>4つの例から15個の特徴が生成されました。
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>各特徴の元の例: [0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3]
</span></code></pre></div></p> <h3 id=_8>ラベルの生成<a class=headerlink href=#_8 title="Permanent link">&para;</a></h3> <p>適切なラベルを生成するために、文脈内での答えの位置を特定する必要があります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=n>answers</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>2</span><span class=p>:</span><span class=mi>6</span><span class=p>][</span><span class=s2>&quot;answers&quot;</span><span class=p>]</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=n>start_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=n>end_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>offset</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>]):</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>    <span class=n>sample_idx</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>    <span class=n>answer</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>sample_idx</span><span class=p>]</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>    <span class=n>start_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&quot;answer_start&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>    <span class=n>end_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&quot;answer_start&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>    <span class=n>sequence_ids</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>sequence_ids</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a>    <span class=c1># 文脈の開始と終了を見つける</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a>    <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a>    <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>        <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>    <span class=n>context_start</span> <span class=o>=</span> <span class=n>idx</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a>    <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a>        <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a>    <span class=n>context_end</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a>    <span class=c1># 答えが文脈内に完全に含まれていない場合、ラベルは(0, 0)</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a>    <span class=k>if</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_start</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>start_char</span> <span class=ow>or</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_end</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>end_char</span><span class=p>:</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a>        <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a>        <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a>        <span class=c1># そうでなければ、開始と終了のトークン位置</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a>        <span class=n>idx</span> <span class=o>=</span> <span class=n>context_start</span>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a>        <span class=k>while</span> <span class=n>idx</span> <span class=o>&lt;=</span> <span class=n>context_end</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>start_char</span><span class=p>:</span>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a>        <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a>
</span><span id=__span-27-32><a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a>        <span class=n>idx</span> <span class=o>=</span> <span class=n>context_end</span>
</span><span id=__span-27-33><a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a>        <span class=k>while</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=n>context_start</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>end_char</span><span class=p>:</span>
</span><span id=__span-27-34><a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a>            <span class=n>idx</span> <span class=o>-=</span> <span class=mi>1</span>
</span><span id=__span-27-35><a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a>        <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-27-36><a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a>
</span><span id=__span-27-37><a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=n>start_positions</span><span class=p>,</span> <span class=n>end_positions</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>([0, 0, 80, 49, 54, 19, 0, 0, 74, 37, 0, 88, 53, 18, 0],
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a> [0, 0, 80, 49, 56, 21, 0, 0, 75, 38, 0, 91, 56, 21, 0])
</span></code></pre></div></p> <p>結果を検証してみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=n>idx</span> <span class=o>=</span> <span class=mi>2</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=n>sample_idx</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>][</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=n>answer</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>sample_idx</span><span class=p>][</span><span class=s2>&quot;text&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=n>start</span> <span class=o>=</span> <span class=n>start_positions</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=n>end</span> <span class=o>=</span> <span class=n>end_positions</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=n>labeled_answer</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>][</span><span class=n>idx</span><span class=p>][</span><span class=n>start</span> <span class=p>:</span> <span class=n>end</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;理論上の答え: </span><span class=si>{</span><span class=n>answer</span><span class=si>}</span><span class=s2>, ラベルから: </span><span class=si>{</span><span class=n>labeled_answer</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>理論上の答え: 2003, ラベルから: 2003
</span></code></pre></div></p> <h3 id=_9>前処理関数の実装<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>訓練データセット全体に適用する前処理関数を作成します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=n>max_length</span> <span class=o>=</span> <span class=mi>384</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=n>stride</span> <span class=o>=</span> <span class=mi>128</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess_training_example</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>    <span class=n>questions</span> <span class=o>=</span> <span class=p>[</span><span class=n>q</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;question&quot;</span><span class=p>]]</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>        <span class=n>questions</span><span class=p>,</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>        <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;context&quot;</span><span class=p>],</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>        <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>,</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>        <span class=n>truncation</span><span class=o>=</span><span class=s2>&quot;only_second&quot;</span><span class=p>,</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>        <span class=n>stride</span><span class=o>=</span><span class=n>stride</span><span class=p>,</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>        <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a>        <span class=n>return_offsets_mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>        <span class=n>padding</span><span class=o>=</span><span class=s2>&quot;max_length&quot;</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a>    <span class=p>)</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a>    <span class=n>offset_mapping</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>)</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a>    <span class=n>sample_map</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>)</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a>    <span class=n>answers</span> <span class=o>=</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;answers&quot;</span><span class=p>]</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a>    <span class=n>start_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a>    <span class=n>end_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a>
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>offset</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>offset_mapping</span><span class=p>):</span>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a>        <span class=n>sample_idx</span> <span class=o>=</span> <span class=n>sample_map</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a>        <span class=n>answer</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>sample_idx</span><span class=p>]</span>
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a>        <span class=c1># 空の答えをチェック</span>
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a>        <span class=k>if</span> <span class=p>(</span><span class=ow>not</span> <span class=n>answer</span> <span class=ow>or</span> 
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a>            <span class=ow>not</span> <span class=n>answer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;answer_start&quot;</span><span class=p>)</span> <span class=ow>or</span> 
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a>            <span class=ow>not</span> <span class=n>answer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;text&quot;</span><span class=p>)</span> <span class=ow>or</span>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a>            <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>[</span><span class=s2>&quot;answer_start&quot;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>or</span> 
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a>            <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span>
</span><span id=__span-31-32><a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a>            <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-31-33><a id=__codelineno-31-33 name=__codelineno-31-33 href=#__codelineno-31-33></a>            <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-31-34><a id=__codelineno-31-34 name=__codelineno-31-34 href=#__codelineno-31-34></a>            <span class=k>continue</span>
</span><span id=__span-31-35><a id=__codelineno-31-35 name=__codelineno-31-35 href=#__codelineno-31-35></a>        <span class=n>start_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&quot;answer_start&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-31-36><a id=__codelineno-31-36 name=__codelineno-31-36 href=#__codelineno-31-36></a>        <span class=n>end_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&quot;answer_start&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-31-37><a id=__codelineno-31-37 name=__codelineno-31-37 href=#__codelineno-31-37></a>        <span class=n>sequence_ids</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>sequence_ids</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-31-38><a id=__codelineno-31-38 name=__codelineno-31-38 href=#__codelineno-31-38></a>
</span><span id=__span-31-39><a id=__codelineno-31-39 name=__codelineno-31-39 href=#__codelineno-31-39></a>        <span class=c1># 文脈の開始と終了を見つける</span>
</span><span id=__span-31-40><a id=__codelineno-31-40 name=__codelineno-31-40 href=#__codelineno-31-40></a>        <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-31-41><a id=__codelineno-31-41 name=__codelineno-31-41 href=#__codelineno-31-41></a>        <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-31-42><a id=__codelineno-31-42 name=__codelineno-31-42 href=#__codelineno-31-42></a>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-31-43><a id=__codelineno-31-43 name=__codelineno-31-43 href=#__codelineno-31-43></a>        <span class=n>context_start</span> <span class=o>=</span> <span class=n>idx</span>
</span><span id=__span-31-44><a id=__codelineno-31-44 name=__codelineno-31-44 href=#__codelineno-31-44></a>        <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>==</span><span class=mi>1</span><span class=p>:</span>
</span><span id=__span-31-45><a id=__codelineno-31-45 name=__codelineno-31-45 href=#__codelineno-31-45></a>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-31-46><a id=__codelineno-31-46 name=__codelineno-31-46 href=#__codelineno-31-46></a>        <span class=n>context_end</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-31-47><a id=__codelineno-31-47 name=__codelineno-31-47 href=#__codelineno-31-47></a>
</span><span id=__span-31-48><a id=__codelineno-31-48 name=__codelineno-31-48 href=#__codelineno-31-48></a>        <span class=c1># 答えが文脈内に完全に含まれていない場合、ラベルは(0, 0)</span>
</span><span id=__span-31-49><a id=__codelineno-31-49 name=__codelineno-31-49 href=#__codelineno-31-49></a>        <span class=k>if</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_start</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>start_char</span> <span class=ow>or</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_end</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>end_char</span><span class=p>:</span>
</span><span id=__span-31-50><a id=__codelineno-31-50 name=__codelineno-31-50 href=#__codelineno-31-50></a>            <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-31-51><a id=__codelineno-31-51 name=__codelineno-31-51 href=#__codelineno-31-51></a>            <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-31-52><a id=__codelineno-31-52 name=__codelineno-31-52 href=#__codelineno-31-52></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-31-53><a id=__codelineno-31-53 name=__codelineno-31-53 href=#__codelineno-31-53></a>            <span class=c1># そうでなければ、開始と終了のトークン位置</span>
</span><span id=__span-31-54><a id=__codelineno-31-54 name=__codelineno-31-54 href=#__codelineno-31-54></a>            <span class=n>idx</span> <span class=o>=</span> <span class=n>context_start</span>
</span><span id=__span-31-55><a id=__codelineno-31-55 name=__codelineno-31-55 href=#__codelineno-31-55></a>            <span class=k>while</span> <span class=n>idx</span> <span class=o>&lt;=</span> <span class=n>context_end</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>start_char</span><span class=p>:</span>
</span><span id=__span-31-56><a id=__codelineno-31-56 name=__codelineno-31-56 href=#__codelineno-31-56></a>                <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-31-57><a id=__codelineno-31-57 name=__codelineno-31-57 href=#__codelineno-31-57></a>            <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-31-58><a id=__codelineno-31-58 name=__codelineno-31-58 href=#__codelineno-31-58></a>
</span><span id=__span-31-59><a id=__codelineno-31-59 name=__codelineno-31-59 href=#__codelineno-31-59></a>            <span class=n>idx</span> <span class=o>=</span> <span class=n>context_end</span>
</span><span id=__span-31-60><a id=__codelineno-31-60 name=__codelineno-31-60 href=#__codelineno-31-60></a>            <span class=k>while</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=n>context_start</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>end_char</span><span class=p>:</span>
</span><span id=__span-31-61><a id=__codelineno-31-61 name=__codelineno-31-61 href=#__codelineno-31-61></a>                <span class=n>idx</span> <span class=o>-=</span> <span class=mi>1</span>
</span><span id=__span-31-62><a id=__codelineno-31-62 name=__codelineno-31-62 href=#__codelineno-31-62></a>            <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-31-63><a id=__codelineno-31-63 name=__codelineno-31-63 href=#__codelineno-31-63></a>
</span><span id=__span-31-64><a id=__codelineno-31-64 name=__codelineno-31-64 href=#__codelineno-31-64></a>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;start_positions&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>start_positions</span>
</span><span id=__span-31-65><a id=__codelineno-31-65 name=__codelineno-31-65 href=#__codelineno-31-65></a>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;end_positions&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>end_positions</span>
</span><span id=__span-31-66><a id=__codelineno-31-66 name=__codelineno-31-66 href=#__codelineno-31-66></a>
</span><span id=__span-31-67><a id=__codelineno-31-67 name=__codelineno-31-67 href=#__codelineno-31-67></a>    <span class=k>return</span> <span class=n>inputs</span>
</span></code></pre></div> <p>この関数を訓練セット全体に適用します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=n>train_dataset</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>    <span class=n>preprocess_training_example</span><span class=p>,</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>    <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>    <span class=n>remove_columns</span><span class=o>=</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>column_names</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=p>)</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=nb>len</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]),</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_dataset</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>(130319, 132079)
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=nb>print</span><span class=p>(</span><span class=n>train_dataset</span><span class=o>.</span><span class=n>column_names</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>[&#39;input_ids&#39;, &#39;token_type_ids&#39;, &#39;attention_mask&#39;, &#39;start_positions&#39;, &#39;end_positions&#39;]
</span></code></pre></div></p> <h2 id=_10>検証データの前処理<a class=headerlink href=#_10 title="Permanent link">&para;</a></h2> <p>検証データの前処理は、ラベルを生成する必要がないため少し簡単です。重要なのは、オフセットマッピングと各特徴を元の例にマッチさせる方法を保存することです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess_validation_examples</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>    <span class=n>questions</span> <span class=o>=</span> <span class=p>[</span><span class=n>q</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;question&quot;</span><span class=p>]]</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>        <span class=n>questions</span><span class=p>,</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>        <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;context&quot;</span><span class=p>],</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>        <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>,</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>        <span class=n>truncation</span><span class=o>=</span><span class=s2>&quot;only_second&quot;</span><span class=p>,</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>        <span class=n>stride</span><span class=o>=</span><span class=n>stride</span><span class=p>,</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a>        <span class=n>return_overflowing_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>        <span class=n>return_offsets_mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a>        <span class=n>padding</span><span class=o>=</span><span class=s2>&quot;max_length&quot;</span><span class=p>,</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>    <span class=p>)</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a>    <span class=n>sample_map</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;overflow_to_sample_mapping&quot;</span><span class=p>)</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a>    <span class=n>example_ids</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>])):</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a>        <span class=n>sample_idx</span> <span class=o>=</span> <span class=n>sample_map</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a>        <span class=n>example_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>examples</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>][</span><span class=n>sample_idx</span><span class=p>])</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a>        <span class=n>sequence_ids</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>sequence_ids</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a>        <span class=n>offset</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a>        <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a>            <span class=n>o</span> <span class=k>if</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span> <span class=k>else</span> <span class=kc>None</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>o</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a>        <span class=p>]</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;example_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>example_ids</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a>    <span class=k>return</span> <span class=n>inputs</span>
</span></code></pre></div> <p>検証データセット全体に適用します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=n>validation_dataset</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>    <span class=n>preprocess_validation_examples</span><span class=p>,</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>    <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a>    <span class=n>remove_columns</span><span class=o>=</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>column_names</span><span class=p>,</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=p>)</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=nb>len</span><span class=p>(</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]),</span> <span class=nb>len</span><span class=p>(</span><span class=n>validation_dataset</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>(11873, 12199)
</span></code></pre></div></p> <h2 id=trainerapi>TrainerAPIによるファインチューニング<a class=headerlink href=#trainerapi title="Permanent link">&para;</a></h2> <h3 id=_11>後処理関数の実装<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>モデルの予測を元の例のテキストスパンに変換する後処理関数を実装します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=n>small_eval_set</span> <span class=o>=</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>))</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=n>trained_checkpoint</span> <span class=o>=</span> <span class=s2>&quot;distilbert-base-cased-distilled-squad&quot;</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>trained_checkpoint</span><span class=p>)</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=n>eval_set</span> <span class=o>=</span> <span class=n>small_eval_set</span><span class=o>.</span><span class=n>map</span><span class=p>(</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>    <span class=n>preprocess_validation_examples</span><span class=p>,</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a>    <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a>    <span class=n>remove_columns</span><span class=o>=</span><span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>column_names</span><span class=p>,</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=p>)</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=n>eval_set</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>Dataset({
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>    features: [&#39;input_ids&#39;, &#39;attention_mask&#39;, &#39;offset_mapping&#39;, &#39;example_id&#39;],
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>    num_rows: 107
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>})
</span></code></pre></div></p> <p>tokenizerを元に戻します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_checkpoint</span><span class=p>)</span>
</span></code></pre></div> <p>訓練済みモデルで予測を生成します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>AutoModelForQuestionAnswering</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=n>eval_set_for_model</span> <span class=o>=</span> <span class=n>eval_set</span><span class=o>.</span><span class=n>remove_columns</span><span class=p>([</span><span class=s2>&quot;example_id&quot;</span><span class=p>,</span> <span class=s2>&quot;offset_mapping&quot;</span><span class=p>])</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=n>eval_set_for_model</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;torch&quot;</span><span class=p>)</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=nb>print</span><span class=p>(</span><span class=n>eval_set_for_model</span><span class=p>)</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=n>device</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;mps&quot;</span><span class=p>)</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>mps</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;cpu&quot;</span><span class=p>)</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=n>batch</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>eval_set_for_model</span><span class=p>[:][</span><span class=n>k</span><span class=p>]</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>eval_set_for_model</span><span class=o>.</span><span class=n>column_names</span><span class=p>}</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=n>trained_model</span> <span class=o>=</span> <span class=n>AutoModelForQuestionAnswering</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>trained_checkpoint</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>trained_model</span><span class=p>(</span><span class=o>**</span><span class=n>batch</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>Dataset({
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>    features: [&#39;input_ids&#39;, &#39;attention_mask&#39;],
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>    num_rows: 107
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>})
</span></code></pre></div></p> <p>logitsをNumPy配列に変換します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=n>start_logits</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>start_logits</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=n>end_logits</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>end_logits</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></code></pre></div> <p>例と特徴のマッピングを作成します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=kn>import</span><span class=w> </span><span class=nn>collections</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=n>example_to_features</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>feature</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>eval_set</span><span class=p>):</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>    <span class=n>example_to_features</span><span class=p>[</span><span class=n>feature</span><span class=p>[</span><span class=s2>&quot;example_id&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span>
</span></code></pre></div> <p>最適な答えを見つけるためのアルゴリズムを実装します（SQuAD 2.0対応版）：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=n>n_best</span> <span class=o>=</span> <span class=mi>20</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=n>max_answer_length</span> <span class=o>=</span> <span class=mi>30</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=n>predicted_answers</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=k>for</span> <span class=n>example</span> <span class=ow>in</span> <span class=n>small_eval_set</span><span class=p>:</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>    <span class=n>example_id</span> <span class=o>=</span> <span class=n>example</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a>    <span class=n>context</span> <span class=o>=</span> <span class=n>example</span><span class=p>[</span><span class=s2>&quot;context&quot;</span><span class=p>]</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a>    <span class=n>answers</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a>    <span class=n>null_scores</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 各特徴のnull score（CLSトークンのスコア）</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a>    <span class=k>for</span> <span class=n>feature_index</span> <span class=ow>in</span> <span class=n>example_to_features</span><span class=p>[</span><span class=n>example_id</span><span class=p>]:</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a>        <span class=n>start_logit</span> <span class=o>=</span> <span class=n>start_logits</span><span class=p>[</span><span class=n>feature_index</span><span class=p>]</span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a>        <span class=n>end_logit</span> <span class=o>=</span> <span class=n>end_logits</span><span class=p>[</span><span class=n>feature_index</span><span class=p>]</span>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a>        <span class=n>offsets</span> <span class=o>=</span> <span class=n>eval_set</span><span class=p>[</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>][</span><span class=n>feature_index</span><span class=p>]</span>
</span><span id=__span-46-17><a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a>
</span><span id=__span-46-18><a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a>        <span class=c1># Null score（答えなしの信頼度）を計算</span>
</span><span id=__span-46-19><a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a>        <span class=n>null_score</span> <span class=o>=</span> <span class=n>start_logit</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>end_logit</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-46-20><a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a>        <span class=n>null_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>null_score</span><span class=p>)</span>
</span><span id=__span-46-21><a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a>
</span><span id=__span-46-22><a id=__codelineno-46-22 name=__codelineno-46-22 href=#__codelineno-46-22></a>        <span class=n>start_indexes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>start_logit</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=n>n_best</span> <span class=o>-</span> <span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-46-23><a id=__codelineno-46-23 name=__codelineno-46-23 href=#__codelineno-46-23></a>        <span class=n>end_indexes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>end_logit</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=n>n_best</span> <span class=o>-</span> <span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-46-24><a id=__codelineno-46-24 name=__codelineno-46-24 href=#__codelineno-46-24></a>
</span><span id=__span-46-25><a id=__codelineno-46-25 name=__codelineno-46-25 href=#__codelineno-46-25></a>        <span class=k>for</span> <span class=n>start_index</span> <span class=ow>in</span> <span class=n>start_indexes</span><span class=p>:</span>
</span><span id=__span-46-26><a id=__codelineno-46-26 name=__codelineno-46-26 href=#__codelineno-46-26></a>            <span class=k>for</span> <span class=n>end_index</span> <span class=ow>in</span> <span class=n>end_indexes</span><span class=p>:</span>
</span><span id=__span-46-27><a id=__codelineno-46-27 name=__codelineno-46-27 href=#__codelineno-46-27></a>                <span class=c1># 文脈内に完全に含まれていない答えをスキップ</span>
</span><span id=__span-46-28><a id=__codelineno-46-28 name=__codelineno-46-28 href=#__codelineno-46-28></a>                <span class=k>if</span> <span class=n>offsets</span><span class=p>[</span><span class=n>start_index</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>offsets</span><span class=p>[</span><span class=n>end_index</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-46-29><a id=__codelineno-46-29 name=__codelineno-46-29 href=#__codelineno-46-29></a>                    <span class=k>continue</span>
</span><span id=__span-46-30><a id=__codelineno-46-30 name=__codelineno-46-30 href=#__codelineno-46-30></a>                <span class=c1># 長さが不正な答えをスキップ</span>
</span><span id=__span-46-31><a id=__codelineno-46-31 name=__codelineno-46-31 href=#__codelineno-46-31></a>                <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-46-32><a id=__codelineno-46-32 name=__codelineno-46-32 href=#__codelineno-46-32></a>                    <span class=n>end_index</span> <span class=o>&lt;</span> <span class=n>start_index</span>
</span><span id=__span-46-33><a id=__codelineno-46-33 name=__codelineno-46-33 href=#__codelineno-46-33></a>                    <span class=ow>or</span> <span class=n>end_index</span> <span class=o>-</span> <span class=n>start_index</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>max_answer_length</span>
</span><span id=__span-46-34><a id=__codelineno-46-34 name=__codelineno-46-34 href=#__codelineno-46-34></a>                <span class=p>):</span>
</span><span id=__span-46-35><a id=__codelineno-46-35 name=__codelineno-46-35 href=#__codelineno-46-35></a>                    <span class=k>continue</span>
</span><span id=__span-46-36><a id=__codelineno-46-36 name=__codelineno-46-36 href=#__codelineno-46-36></a>
</span><span id=__span-46-37><a id=__codelineno-46-37 name=__codelineno-46-37 href=#__codelineno-46-37></a>                <span class=n>answer_score</span> <span class=o>=</span> <span class=n>start_logit</span><span class=p>[</span><span class=n>start_index</span><span class=p>]</span> <span class=o>+</span> <span class=n>end_logit</span><span class=p>[</span><span class=n>end_index</span><span class=p>]</span>
</span><span id=__span-46-38><a id=__codelineno-46-38 name=__codelineno-46-38 href=#__codelineno-46-38></a>                <span class=n>answers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span><span id=__span-46-39><a id=__codelineno-46-39 name=__codelineno-46-39 href=#__codelineno-46-39></a>                    <span class=p>{</span>
</span><span id=__span-46-40><a id=__codelineno-46-40 name=__codelineno-46-40 href=#__codelineno-46-40></a>                        <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>context</span><span class=p>[</span><span class=n>offsets</span><span class=p>[</span><span class=n>start_index</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=p>:</span> <span class=n>offsets</span><span class=p>[</span><span class=n>end_index</span><span class=p>][</span><span class=mi>1</span><span class=p>]],</span>
</span><span id=__span-46-41><a id=__codelineno-46-41 name=__codelineno-46-41 href=#__codelineno-46-41></a>                        <span class=s2>&quot;logit_score&quot;</span><span class=p>:</span> <span class=n>answer_score</span><span class=p>,</span>
</span><span id=__span-46-42><a id=__codelineno-46-42 name=__codelineno-46-42 href=#__codelineno-46-42></a>                    <span class=p>}</span>
</span><span id=__span-46-43><a id=__codelineno-46-43 name=__codelineno-46-43 href=#__codelineno-46-43></a>                <span class=p>)</span>
</span><span id=__span-46-44><a id=__codelineno-46-44 name=__codelineno-46-44 href=#__codelineno-46-44></a>
</span><span id=__span-46-45><a id=__codelineno-46-45 name=__codelineno-46-45 href=#__codelineno-46-45></a>    <span class=c1># SQuAD 2.0の重要な処理：答えなし判定</span>
</span><span id=__span-46-46><a id=__codelineno-46-46 name=__codelineno-46-46 href=#__codelineno-46-46></a>    <span class=n>min_null_score</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>null_scores</span><span class=p>)</span> <span class=k>if</span> <span class=n>null_scores</span> <span class=k>else</span> <span class=mf>0.0</span>
</span><span id=__span-46-47><a id=__codelineno-46-47 name=__codelineno-46-47 href=#__codelineno-46-47></a>
</span><span id=__span-46-48><a id=__codelineno-46-48 name=__codelineno-46-48 href=#__codelineno-46-48></a>    <span class=k>if</span> <span class=n>answers</span><span class=p>:</span>
</span><span id=__span-46-49><a id=__codelineno-46-49 name=__codelineno-46-49 href=#__codelineno-46-49></a>        <span class=n>best_answer</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>answers</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;logit_score&quot;</span><span class=p>])</span>
</span><span id=__span-46-50><a id=__codelineno-46-50 name=__codelineno-46-50 href=#__codelineno-46-50></a>        <span class=c1># 答えありスコアとnullスコアを比較</span>
</span><span id=__span-46-51><a id=__codelineno-46-51 name=__codelineno-46-51 href=#__codelineno-46-51></a>        <span class=n>score_diff</span> <span class=o>=</span> <span class=n>best_answer</span><span class=p>[</span><span class=s2>&quot;logit_score&quot;</span><span class=p>]</span> <span class=o>-</span> <span class=n>min_null_score</span>
</span><span id=__span-46-52><a id=__codelineno-46-52 name=__codelineno-46-52 href=#__codelineno-46-52></a>
</span><span id=__span-46-53><a id=__codelineno-46-53 name=__codelineno-46-53 href=#__codelineno-46-53></a>        <span class=k>if</span> <span class=n>score_diff</span> <span class=o>&gt;</span> <span class=mf>0.0</span><span class=p>:</span>  <span class=c1># 閾値：0.0（調整可能）</span>
</span><span id=__span-46-54><a id=__codelineno-46-54 name=__codelineno-46-54 href=#__codelineno-46-54></a>            <span class=c1># 答えあり</span>
</span><span id=__span-46-55><a id=__codelineno-46-55 name=__codelineno-46-55 href=#__codelineno-46-55></a>            <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-46-56><a id=__codelineno-46-56 name=__codelineno-46-56 href=#__codelineno-46-56></a>                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span>
</span><span id=__span-46-57><a id=__codelineno-46-57 name=__codelineno-46-57 href=#__codelineno-46-57></a>                <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=n>best_answer</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>],</span>
</span><span id=__span-46-58><a id=__codelineno-46-58 name=__codelineno-46-58 href=#__codelineno-46-58></a>                <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>0.0</span>
</span><span id=__span-46-59><a id=__codelineno-46-59 name=__codelineno-46-59 href=#__codelineno-46-59></a>            <span class=p>})</span>
</span><span id=__span-46-60><a id=__codelineno-46-60 name=__codelineno-46-60 href=#__codelineno-46-60></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-46-61><a id=__codelineno-46-61 name=__codelineno-46-61 href=#__codelineno-46-61></a>            <span class=c1># 答えなし</span>
</span><span id=__span-46-62><a id=__codelineno-46-62 name=__codelineno-46-62 href=#__codelineno-46-62></a>            <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-46-63><a id=__codelineno-46-63 name=__codelineno-46-63 href=#__codelineno-46-63></a>                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span>
</span><span id=__span-46-64><a id=__codelineno-46-64 name=__codelineno-46-64 href=#__codelineno-46-64></a>                <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-46-65><a id=__codelineno-46-65 name=__codelineno-46-65 href=#__codelineno-46-65></a>                <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>1.0</span>
</span><span id=__span-46-66><a id=__codelineno-46-66 name=__codelineno-46-66 href=#__codelineno-46-66></a>            <span class=p>})</span>
</span><span id=__span-46-67><a id=__codelineno-46-67 name=__codelineno-46-67 href=#__codelineno-46-67></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-46-68><a id=__codelineno-46-68 name=__codelineno-46-68 href=#__codelineno-46-68></a>        <span class=c1># 候補が見つからない場合は答えなし</span>
</span><span id=__span-46-69><a id=__codelineno-46-69 name=__codelineno-46-69 href=#__codelineno-46-69></a>        <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-46-70><a id=__codelineno-46-70 name=__codelineno-46-70 href=#__codelineno-46-70></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span>
</span><span id=__span-46-71><a id=__codelineno-46-71 name=__codelineno-46-71 href=#__codelineno-46-71></a>            <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-46-72><a id=__codelineno-46-72 name=__codelineno-46-72 href=#__codelineno-46-72></a>            <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>1.0</span>
</span><span id=__span-46-73><a id=__codelineno-46-73 name=__codelineno-46-73 href=#__codelineno-46-73></a>        <span class=p>})</span>
</span></code></pre></div> <p>評価メトリクスを読み込みます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=kn>import</span><span class=w> </span><span class=nn>evaluate</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=n>metric</span> <span class=o>=</span> <span class=n>evaluate</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;squad_v2&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>理論的な答えの形式を準備します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=n>theoretical_answers</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a>    <span class=p>{</span><span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>ex</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=s2>&quot;answers&quot;</span><span class=p>:</span> <span class=n>ex</span><span class=p>[</span><span class=s2>&quot;answers&quot;</span><span class=p>]}</span> <span class=k>for</span> <span class=n>ex</span> <span class=ow>in</span> <span class=n>small_eval_set</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=p>]</span>
</span></code></pre></div> <p>予測結果を確認します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=nb>print</span><span class=p>(</span><span class=n>predicted_answers</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=nb>print</span><span class=p>(</span><span class=n>theoretical_answers</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>{&#39;id&#39;: &#39;56ddde6b9a695914005b9629&#39;, &#39;prediction_text&#39;: &#39;10th and 11th centuries&#39;, &#39;no_answer_probability&#39;: 0.0}
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>{&#39;id&#39;: &#39;56ddde6b9a695914005b9629&#39;, &#39;answers&#39;: {&#39;text&#39;: [&#39;10th and 11th centuries&#39;, &#39;in the 10th and 11th centuries&#39;, &#39;10th and 11th centuries&#39;, &#39;10th and 11th centuries&#39;], &#39;answer_start&#39;: [94, 87, 94, 94]}}
</span></code></pre></div></p> <p>評価関数を実装します（SQuAD 2.0対応修正版）：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=k>def</span><span class=w> </span><span class=nf>evaluate_squad_format</span><span class=p>():</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;SQuAD 2.0標準形式で評価（答えなし対応）&quot;&quot;&quot;</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a>    <span class=c1># 正しい形式に変換</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a>    <span class=n>formatted_predictions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a>    <span class=n>formatted_references</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a>    <span class=k>for</span> <span class=n>pred</span><span class=p>,</span> <span class=n>ref</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>predicted_answers</span><span class=p>,</span> <span class=n>theoretical_answers</span><span class=p>):</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a>        <span class=c1># 予測形式（修正版：no_answer_probabilityを正しく設定）</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a>        <span class=n>formatted_predictions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>pred</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a>            <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=n>pred</span><span class=p>[</span><span class=s2>&quot;prediction_text&quot;</span><span class=p>],</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a>            <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=n>pred</span><span class=p>[</span><span class=s2>&quot;no_answer_probability&quot;</span><span class=p>]</span>  <span class=c1># 修正：動的に設定</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a>        <span class=p>})</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a>        <span class=c1># 参考形式</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a>        <span class=n>formatted_references</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>ref</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a>            <span class=s2>&quot;answers&quot;</span><span class=p>:</span> <span class=n>ref</span><span class=p>[</span><span class=s2>&quot;answers&quot;</span><span class=p>]</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a>        <span class=p>})</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a>    <span class=c1># SQuAD指標を使用</span>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a>    <span class=n>results</span> <span class=o>=</span> <span class=n>metric</span><span class=o>.</span><span class=n>compute</span><span class=p>(</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a>        <span class=n>predictions</span><span class=o>=</span><span class=n>formatted_predictions</span><span class=p>,</span>
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25 href=#__codelineno-51-25></a>        <span class=n>references</span><span class=o>=</span><span class=n>formatted_references</span>
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26 href=#__codelineno-51-26></a>    <span class=p>)</span>
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27 href=#__codelineno-51-27></a>
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28 href=#__codelineno-51-28></a>    <span class=k>return</span> <span class=n>results</span>
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29 href=#__codelineno-51-29></a>
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30 href=#__codelineno-51-30></a><span class=c1># 評価を実行</span>
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31 href=#__codelineno-51-31></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32 href=#__codelineno-51-32></a>    <span class=n>results</span> <span class=o>=</span> <span class=n>evaluate_squad_format</span><span class=p>()</span>
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33 href=#__codelineno-51-33></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SQuAD評価結果:&quot;</span><span class=p>)</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34 href=#__codelineno-51-34></a>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-51-35><a id=__codelineno-51-35 name=__codelineno-51-35 href=#__codelineno-51-35></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-51-36><a id=__codelineno-51-36 name=__codelineno-51-36 href=#__codelineno-51-36></a><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-51-37><a id=__codelineno-51-37 name=__codelineno-51-37 href=#__codelineno-51-37></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;SQuAD評価でエラー: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>SQuAD評価結果:
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>  exact: 68.0000
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>  f1: 69.7262
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>  total: 100.0000
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a>  HasAns_exact: 73.3333
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>  HasAns_f1: 77.1693
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a>  HasAns_total: 45.0000
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>  NoAns_exact: 63.6364
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a>  NoAns_f1: 63.6364
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a>  NoAns_total: 55.0000
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a>  best_exact: 68.0000
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a>  best_exact_thresh: 0.0000
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a>  best_f1: 69.7262
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a>  best_f1_thresh: 0.0000
</span></code></pre></div></p> <p>完全なメトリクス計算関数を実装します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=kn>from</span><span class=w> </span><span class=nn>tqdm.auto</span><span class=w> </span><span class=kn>import</span> <span class=n>tqdm</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=k>def</span><span class=w> </span><span class=nf>find_optimal_threshold</span><span class=p>(</span><span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>features</span><span class=p>,</span> <span class=n>examples</span><span class=p>):</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;最適な閾値を見つける関数&quot;&quot;&quot;</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>    <span class=n>best_f1</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a>    <span class=n>best_threshold</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a>    <span class=k>for</span> <span class=n>threshold</span> <span class=ow>in</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=o>-</span><span class=mf>5.0</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>):</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a>        <span class=n>metrics</span> <span class=o>=</span> <span class=n>compute_metrics</span><span class=p>(</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a>            <span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>features</span><span class=p>,</span> <span class=n>examples</span><span class=p>,</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a>            <span class=n>null_score_diff_threshold</span><span class=o>=</span><span class=n>threshold</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a>        <span class=p>)</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a>        <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;f1&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>best_f1</span><span class=p>:</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a>            <span class=n>best_f1</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;f1&#39;</span><span class=p>]</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a>            <span class=n>best_threshold</span> <span class=o>=</span> <span class=n>threshold</span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a>
</span><span id=__span-53-18><a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a>    <span class=k>return</span> <span class=n>best_threshold</span>
</span><span id=__span-53-19><a id=__codelineno-53-19 name=__codelineno-53-19 href=#__codelineno-53-19></a>
</span><span id=__span-53-20><a id=__codelineno-53-20 name=__codelineno-53-20 href=#__codelineno-53-20></a><span class=k>def</span><span class=w> </span><span class=nf>compute_metrics</span><span class=p>(</span><span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>features</span><span class=p>,</span> <span class=n>examples</span><span class=p>,</span>
</span><span id=__span-53-21><a id=__codelineno-53-21 name=__codelineno-53-21 href=#__codelineno-53-21></a>                           <span class=n>null_score_diff_threshold</span><span class=o>=</span><span class=mf>0.0</span><span class=p>):</span>
</span><span id=__span-53-22><a id=__codelineno-53-22 name=__codelineno-53-22 href=#__codelineno-53-22></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;SQuAD 2.0対応、答えなし検出をサポート&quot;&quot;&quot;</span>
</span><span id=__span-53-23><a id=__codelineno-53-23 name=__codelineno-53-23 href=#__codelineno-53-23></a>
</span><span id=__span-53-24><a id=__codelineno-53-24 name=__codelineno-53-24 href=#__codelineno-53-24></a>    <span class=n>example_to_features</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-53-25><a id=__codelineno-53-25 name=__codelineno-53-25 href=#__codelineno-53-25></a>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>feature</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>features</span><span class=p>):</span>
</span><span id=__span-53-26><a id=__codelineno-53-26 name=__codelineno-53-26 href=#__codelineno-53-26></a>        <span class=n>example_to_features</span><span class=p>[</span><span class=n>feature</span><span class=p>[</span><span class=s2>&quot;example_id&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span>
</span><span id=__span-53-27><a id=__codelineno-53-27 name=__codelineno-53-27 href=#__codelineno-53-27></a>
</span><span id=__span-53-28><a id=__codelineno-53-28 name=__codelineno-53-28 href=#__codelineno-53-28></a>    <span class=n>predicted_answers</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-53-29><a id=__codelineno-53-29 name=__codelineno-53-29 href=#__codelineno-53-29></a>
</span><span id=__span-53-30><a id=__codelineno-53-30 name=__codelineno-53-30 href=#__codelineno-53-30></a>    <span class=k>for</span> <span class=n>example</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-53-31><a id=__codelineno-53-31 name=__codelineno-53-31 href=#__codelineno-53-31></a>        <span class=n>example_id</span> <span class=o>=</span> <span class=n>example</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
</span><span id=__span-53-32><a id=__codelineno-53-32 name=__codelineno-53-32 href=#__codelineno-53-32></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>example</span><span class=p>[</span><span class=s2>&quot;context&quot;</span><span class=p>]</span>
</span><span id=__span-53-33><a id=__codelineno-53-33 name=__codelineno-53-33 href=#__codelineno-53-33></a>        <span class=n>answers</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-53-34><a id=__codelineno-53-34 name=__codelineno-53-34 href=#__codelineno-53-34></a>
</span><span id=__span-53-35><a id=__codelineno-53-35 name=__codelineno-53-35 href=#__codelineno-53-35></a>        <span class=c1># 全特徴のnull score (CLS token score)を収集</span>
</span><span id=__span-53-36><a id=__codelineno-53-36 name=__codelineno-53-36 href=#__codelineno-53-36></a>        <span class=n>null_scores</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-53-37><a id=__codelineno-53-37 name=__codelineno-53-37 href=#__codelineno-53-37></a>
</span><span id=__span-53-38><a id=__codelineno-53-38 name=__codelineno-53-38 href=#__codelineno-53-38></a>        <span class=c1># この例に関連する全特徴をループ処理</span>
</span><span id=__span-53-39><a id=__codelineno-53-39 name=__codelineno-53-39 href=#__codelineno-53-39></a>        <span class=k>for</span> <span class=n>feature_index</span> <span class=ow>in</span> <span class=n>example_to_features</span><span class=p>[</span><span class=n>example_id</span><span class=p>]:</span>
</span><span id=__span-53-40><a id=__codelineno-53-40 name=__codelineno-53-40 href=#__codelineno-53-40></a>            <span class=n>start_logit</span> <span class=o>=</span> <span class=n>start_logits</span><span class=p>[</span><span class=n>feature_index</span><span class=p>]</span>
</span><span id=__span-53-41><a id=__codelineno-53-41 name=__codelineno-53-41 href=#__codelineno-53-41></a>            <span class=n>end_logit</span> <span class=o>=</span> <span class=n>end_logits</span><span class=p>[</span><span class=n>feature_index</span><span class=p>]</span>
</span><span id=__span-53-42><a id=__codelineno-53-42 name=__codelineno-53-42 href=#__codelineno-53-42></a>            <span class=n>offsets</span> <span class=o>=</span> <span class=n>features</span><span class=p>[</span><span class=n>feature_index</span><span class=p>][</span><span class=s2>&quot;offset_mapping&quot;</span><span class=p>]</span>
</span><span id=__span-53-43><a id=__codelineno-53-43 name=__codelineno-53-43 href=#__codelineno-53-43></a>
</span><span id=__span-53-44><a id=__codelineno-53-44 name=__codelineno-53-44 href=#__codelineno-53-44></a>            <span class=c1># null score (CLSトークンのスコア)を計算</span>
</span><span id=__span-53-45><a id=__codelineno-53-45 name=__codelineno-53-45 href=#__codelineno-53-45></a>            <span class=n>null_score</span> <span class=o>=</span> <span class=n>start_logit</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>end_logit</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-53-46><a id=__codelineno-53-46 name=__codelineno-53-46 href=#__codelineno-53-46></a>            <span class=n>null_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>null_score</span><span class=p>)</span>
</span><span id=__span-53-47><a id=__codelineno-53-47 name=__codelineno-53-47 href=#__codelineno-53-47></a>
</span><span id=__span-53-48><a id=__codelineno-53-48 name=__codelineno-53-48 href=#__codelineno-53-48></a>            <span class=n>start_indexes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>start_logit</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=n>n_best</span> <span class=o>-</span> <span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-53-49><a id=__codelineno-53-49 name=__codelineno-53-49 href=#__codelineno-53-49></a>            <span class=n>end_indexes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>end_logit</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=n>n_best</span> <span class=o>-</span> <span class=mi>1</span> <span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-53-50><a id=__codelineno-53-50 name=__codelineno-53-50 href=#__codelineno-53-50></a>
</span><span id=__span-53-51><a id=__codelineno-53-51 name=__codelineno-53-51 href=#__codelineno-53-51></a>            <span class=k>for</span> <span class=n>start_index</span> <span class=ow>in</span> <span class=n>start_indexes</span><span class=p>:</span>
</span><span id=__span-53-52><a id=__codelineno-53-52 name=__codelineno-53-52 href=#__codelineno-53-52></a>                <span class=k>for</span> <span class=n>end_index</span> <span class=ow>in</span> <span class=n>end_indexes</span><span class=p>:</span>
</span><span id=__span-53-53><a id=__codelineno-53-53 name=__codelineno-53-53 href=#__codelineno-53-53></a>                    <span class=c1># 文脈内にない答えをスキップ</span>
</span><span id=__span-53-54><a id=__codelineno-53-54 name=__codelineno-53-54 href=#__codelineno-53-54></a>                    <span class=k>if</span> <span class=n>offsets</span><span class=p>[</span><span class=n>start_index</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>offsets</span><span class=p>[</span><span class=n>end_index</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-53-55><a id=__codelineno-53-55 name=__codelineno-53-55 href=#__codelineno-53-55></a>                        <span class=k>continue</span>
</span><span id=__span-53-56><a id=__codelineno-53-56 name=__codelineno-53-56 href=#__codelineno-53-56></a>                    <span class=c1># 長さが不適切な答えをスキップ</span>
</span><span id=__span-53-57><a id=__codelineno-53-57 name=__codelineno-53-57 href=#__codelineno-53-57></a>                    <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-53-58><a id=__codelineno-53-58 name=__codelineno-53-58 href=#__codelineno-53-58></a>                        <span class=n>end_index</span> <span class=o>&lt;</span> <span class=n>start_index</span>
</span><span id=__span-53-59><a id=__codelineno-53-59 name=__codelineno-53-59 href=#__codelineno-53-59></a>                        <span class=ow>or</span> <span class=n>end_index</span> <span class=o>-</span> <span class=n>start_index</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>max_answer_length</span>
</span><span id=__span-53-60><a id=__codelineno-53-60 name=__codelineno-53-60 href=#__codelineno-53-60></a>                    <span class=p>):</span>
</span><span id=__span-53-61><a id=__codelineno-53-61 name=__codelineno-53-61 href=#__codelineno-53-61></a>                        <span class=k>continue</span>
</span><span id=__span-53-62><a id=__codelineno-53-62 name=__codelineno-53-62 href=#__codelineno-53-62></a>
</span><span id=__span-53-63><a id=__codelineno-53-63 name=__codelineno-53-63 href=#__codelineno-53-63></a>                    <span class=n>answer</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-53-64><a id=__codelineno-53-64 name=__codelineno-53-64 href=#__codelineno-53-64></a>                        <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>context</span><span class=p>[</span><span class=n>offsets</span><span class=p>[</span><span class=n>start_index</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=p>:</span> <span class=n>offsets</span><span class=p>[</span><span class=n>end_index</span><span class=p>][</span><span class=mi>1</span><span class=p>]],</span>
</span><span id=__span-53-65><a id=__codelineno-53-65 name=__codelineno-53-65 href=#__codelineno-53-65></a>                        <span class=s2>&quot;logit_score&quot;</span><span class=p>:</span> <span class=n>start_logit</span><span class=p>[</span><span class=n>start_index</span><span class=p>]</span> <span class=o>+</span> <span class=n>end_logit</span><span class=p>[</span><span class=n>end_index</span><span class=p>],</span>
</span><span id=__span-53-66><a id=__codelineno-53-66 name=__codelineno-53-66 href=#__codelineno-53-66></a>                        <span class=s2>&quot;feature_index&quot;</span><span class=p>:</span> <span class=n>feature_index</span>
</span><span id=__span-53-67><a id=__codelineno-53-67 name=__codelineno-53-67 href=#__codelineno-53-67></a>                    <span class=p>}</span>
</span><span id=__span-53-68><a id=__codelineno-53-68 name=__codelineno-53-68 href=#__codelineno-53-68></a>                    <span class=n>answers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span>
</span><span id=__span-53-69><a id=__codelineno-53-69 name=__codelineno-53-69 href=#__codelineno-53-69></a>
</span><span id=__span-53-70><a id=__codelineno-53-70 name=__codelineno-53-70 href=#__codelineno-53-70></a>        <span class=c1># 最適なnull scoreを計算</span>
</span><span id=__span-53-71><a id=__codelineno-53-71 name=__codelineno-53-71 href=#__codelineno-53-71></a>        <span class=n>min_null_score</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>null_scores</span><span class=p>)</span> <span class=k>if</span> <span class=n>null_scores</span> <span class=k>else</span> <span class=mf>0.0</span>
</span><span id=__span-53-72><a id=__codelineno-53-72 name=__codelineno-53-72 href=#__codelineno-53-72></a>
</span><span id=__span-53-73><a id=__codelineno-53-73 name=__codelineno-53-73 href=#__codelineno-53-73></a>        <span class=c1># 最適な答えを選択</span>
</span><span id=__span-53-74><a id=__codelineno-53-74 name=__codelineno-53-74 href=#__codelineno-53-74></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-53-75><a id=__codelineno-53-75 name=__codelineno-53-75 href=#__codelineno-53-75></a>            <span class=n>best_answer</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>answers</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&quot;logit_score&quot;</span><span class=p>])</span>
</span><span id=__span-53-76><a id=__codelineno-53-76 name=__codelineno-53-76 href=#__codelineno-53-76></a>
</span><span id=__span-53-77><a id=__codelineno-53-77 name=__codelineno-53-77 href=#__codelineno-53-77></a>            <span class=c1># SQuAD 2.0の重要な点：最適答案スコアとnullスコアを比較</span>
</span><span id=__span-53-78><a id=__codelineno-53-78 name=__codelineno-53-78 href=#__codelineno-53-78></a>            <span class=n>score_diff</span> <span class=o>=</span> <span class=n>best_answer</span><span class=p>[</span><span class=s2>&quot;logit_score&quot;</span><span class=p>]</span> <span class=o>-</span> <span class=n>min_null_score</span>
</span><span id=__span-53-79><a id=__codelineno-53-79 name=__codelineno-53-79 href=#__codelineno-53-79></a>
</span><span id=__span-53-80><a id=__codelineno-53-80 name=__codelineno-53-80 href=#__codelineno-53-80></a>            <span class=k>if</span> <span class=n>score_diff</span> <span class=o>&gt;</span> <span class=n>null_score_diff_threshold</span><span class=p>:</span>
</span><span id=__span-53-81><a id=__codelineno-53-81 name=__codelineno-53-81 href=#__codelineno-53-81></a>                <span class=c1># 答えあり</span>
</span><span id=__span-53-82><a id=__codelineno-53-82 name=__codelineno-53-82 href=#__codelineno-53-82></a>                <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-53-83><a id=__codelineno-53-83 name=__codelineno-53-83 href=#__codelineno-53-83></a>                    <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span> 
</span><span id=__span-53-84><a id=__codelineno-53-84 name=__codelineno-53-84 href=#__codelineno-53-84></a>                    <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=n>best_answer</span><span class=p>[</span><span class=s2>&quot;text&quot;</span><span class=p>],</span>
</span><span id=__span-53-85><a id=__codelineno-53-85 name=__codelineno-53-85 href=#__codelineno-53-85></a>                    <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>0.0</span>
</span><span id=__span-53-86><a id=__codelineno-53-86 name=__codelineno-53-86 href=#__codelineno-53-86></a>                <span class=p>})</span>
</span><span id=__span-53-87><a id=__codelineno-53-87 name=__codelineno-53-87 href=#__codelineno-53-87></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-53-88><a id=__codelineno-53-88 name=__codelineno-53-88 href=#__codelineno-53-88></a>                <span class=c1># 答えなし</span>
</span><span id=__span-53-89><a id=__codelineno-53-89 name=__codelineno-53-89 href=#__codelineno-53-89></a>                <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-53-90><a id=__codelineno-53-90 name=__codelineno-53-90 href=#__codelineno-53-90></a>                    <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span> 
</span><span id=__span-53-91><a id=__codelineno-53-91 name=__codelineno-53-91 href=#__codelineno-53-91></a>                    <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-53-92><a id=__codelineno-53-92 name=__codelineno-53-92 href=#__codelineno-53-92></a>                    <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>1.0</span>
</span><span id=__span-53-93><a id=__codelineno-53-93 name=__codelineno-53-93 href=#__codelineno-53-93></a>                <span class=p>})</span>
</span><span id=__span-53-94><a id=__codelineno-53-94 name=__codelineno-53-94 href=#__codelineno-53-94></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-53-95><a id=__codelineno-53-95 name=__codelineno-53-95 href=#__codelineno-53-95></a>            <span class=c1># 候補答案が見つからない場合、確実に答えなし</span>
</span><span id=__span-53-96><a id=__codelineno-53-96 name=__codelineno-53-96 href=#__codelineno-53-96></a>            <span class=n>predicted_answers</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span><span id=__span-53-97><a id=__codelineno-53-97 name=__codelineno-53-97 href=#__codelineno-53-97></a>                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>example_id</span><span class=p>,</span> 
</span><span id=__span-53-98><a id=__codelineno-53-98 name=__codelineno-53-98 href=#__codelineno-53-98></a>                <span class=s2>&quot;prediction_text&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-53-99><a id=__codelineno-53-99 name=__codelineno-53-99 href=#__codelineno-53-99></a>                <span class=s2>&quot;no_answer_probability&quot;</span><span class=p>:</span> <span class=mf>1.0</span>
</span><span id=__span-53-100><a id=__codelineno-53-100 name=__codelineno-53-100 href=#__codelineno-53-100></a>            <span class=p>})</span>
</span><span id=__span-53-101><a id=__codelineno-53-101 name=__codelineno-53-101 href=#__codelineno-53-101></a>
</span><span id=__span-53-102><a id=__codelineno-53-102 name=__codelineno-53-102 href=#__codelineno-53-102></a>    <span class=n>theoretical_answers</span> <span class=o>=</span> <span class=p>[{</span><span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>ex</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=s2>&quot;answers&quot;</span><span class=p>:</span> <span class=n>ex</span><span class=p>[</span><span class=s2>&quot;answers&quot;</span><span class=p>]}</span> <span class=k>for</span> <span class=n>ex</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>]</span>
</span><span id=__span-53-103><a id=__codelineno-53-103 name=__codelineno-53-103 href=#__codelineno-53-103></a>    <span class=k>return</span> <span class=n>metric</span><span class=o>.</span><span class=n>compute</span><span class=p>(</span><span class=n>predictions</span><span class=o>=</span><span class=n>predicted_answers</span><span class=p>,</span> <span class=n>references</span><span class=o>=</span><span class=n>theoretical_answers</span><span class=p>)</span>
</span></code></pre></div> <p>評価を実行します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=n>compute_metrics</span><span class=p>(</span><span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>eval_set</span><span class=p>,</span> <span class=n>small_eval_set</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>{&#39;exact&#39;: 68.0,
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a> &#39;f1&#39;: 69.72619047619048,
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a> &#39;total&#39;: 100,
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a> &#39;HasAns_exact&#39;: 73.33333333333333,
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a> &#39;HasAns_f1&#39;: 77.16931216931216,
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a> &#39;HasAns_total&#39;: 45,
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a> &#39;NoAns_exact&#39;: 63.63636363636363,
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a> &#39;NoAns_f1&#39;: 63.63636363636363,
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a> &#39;NoAns_total&#39;: 55,
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a> &#39;best_exact&#39;: 68.0,
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a> &#39;best_exact_thresh&#39;: 0.0,
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a> &#39;best_f1&#39;: 69.72619047619048,
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a> &#39;best_f1_thresh&#39;: 0.0}
</span></code></pre></div></p> <h3 id=_12>モデルのファインチューニング<a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <p>質問応答用のBERTモデルを作成します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>AutoModelForQuestionAnswering</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForQuestionAnswering</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_checkpoint</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>Some weights of BertForQuestionAnswering were not initialized from the model checkpoint at bert-base-cased and are newly initialized: [&#39;qa_outputs.bias&#39;, &#39;qa_outputs.weight&#39;]
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</span></code></pre></div></p> <p>訓練引数を設定します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>TrainingArguments</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=n>args</span> <span class=o>=</span> <span class=n>TrainingArguments</span><span class=p>(</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a>    <span class=s2>&quot;bert-finetuned-squad&quot;</span><span class=p>,</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a>    <span class=n>eval_strategy</span><span class=o>=</span><span class=s2>&quot;no&quot;</span><span class=p>,</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a>    <span class=n>save_strategy</span><span class=o>=</span><span class=s2>&quot;epoch&quot;</span><span class=p>,</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a>    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>2e-5</span><span class=p>,</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a>    <span class=n>num_train_epochs</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a>    <span class=n>weight_decay</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a>    <span class=n>fp16</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a>    <span class=n>dataloader_pin_memory</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a><span class=p>)</span>
</span></code></pre></div> <p>Trainerクラスで訓練を開始します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>Trainer</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=n>trainer</span> <span class=o>=</span> <span class=n>Trainer</span><span class=p>(</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>    <span class=n>args</span><span class=o>=</span><span class=n>args</span><span class=p>,</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>    <span class=n>train_dataset</span><span class=o>=</span><span class=n>train_dataset</span><span class=p>,</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>    <span class=n>eval_dataset</span><span class=o>=</span><span class=n>validation_dataset</span><span class=p>,</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a>    <span class=n>processing_class</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=p>)</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=nb>print</span><span class=p>(</span><span class=nb>next</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>())</span><span class=o>.</span><span class=n>device</span><span class=p>)</span> 
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a>mps:0
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1># trainer.train()</span>
</span></code></pre></div> <h2 id=_13>カスタム訓練ループ<a class=headerlink href=#_13 title="Permanent link">&para;</a></h2> <p>完全な訓練ループを実装して、必要な部分を簡単にカスタマイズできるようにしましょう。</p> <h3 id=_14>訓練の準備<a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <p>まず、データセットからDataLoaderを構築します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=kn>from</span><span class=w> </span><span class=nn>torch.utils.data</span><span class=w> </span><span class=kn>import</span> <span class=n>DataLoader</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>default_data_collator</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=n>train_dataset</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;torch&quot;</span><span class=p>)</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=n>validation_set</span> <span class=o>=</span> <span class=n>validation_dataset</span><span class=o>.</span><span class=n>remove_columns</span><span class=p>([</span><span class=s2>&quot;example_id&quot;</span><span class=p>,</span> <span class=s2>&quot;offset_mapping&quot;</span><span class=p>])</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=n>validation_set</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;torch&quot;</span><span class=p>)</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=n>train_dataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a>    <span class=n>train_dataset</span><span class=p>,</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a>    <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a>    <span class=n>collate_fn</span><span class=o>=</span><span class=n>default_data_collator</span><span class=p>,</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>  <span class=c1># 高速化のため倍増</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=p>)</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=n>eval_dataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a>    <span class=n>validation_set</span><span class=p>,</span> <span class=n>collate_fn</span><span class=o>=</span><span class=n>default_data_collator</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>16</span>  <span class=c1># 評価も高速化</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=p>)</span>
</span></code></pre></div> <p>モデルを再インスタンス化します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForQuestionAnswering</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_checkpoint</span><span class=p>)</span>
</span></code></pre></div> <p>オプティマイザーを設定します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=kn>from</span><span class=w> </span><span class=nn>torch.optim</span><span class=w> </span><span class=kn>import</span> <span class=n>AdamW</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=n>optimizer</span> <span class=o>=</span> <span class=n>AdamW</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span> <span class=n>lr</span><span class=o>=</span><span class=mf>2e-5</span><span class=p>)</span>
</span></code></pre></div> <p>Acceleratorを使用して分散訓練を準備します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=kn>from</span><span class=w> </span><span class=nn>accelerate</span><span class=w> </span><span class=kn>import</span> <span class=n>Accelerator</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=n>accelerator</span> <span class=o>=</span> <span class=n>Accelerator</span><span class=p>()</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=n>model</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>train_dataloader</span><span class=p>,</span> <span class=n>eval_dataloader</span> <span class=o>=</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>prepare</span><span class=p>(</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a>    <span class=n>model</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>train_dataloader</span><span class=p>,</span> <span class=n>eval_dataloader</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=p>)</span>
</span></code></pre></div> <p>学習率スケジューラーを設定します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>get_scheduler</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=n>num_train_epochs</span> <span class=o>=</span> <span class=mi>1</span>  <span class=c1># クイックテスト用</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=n>num_update_steps_per_epoch</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_dataloader</span><span class=p>)</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=n>num_training_steps</span> <span class=o>=</span> <span class=n>num_train_epochs</span> <span class=o>*</span> <span class=n>num_update_steps_per_epoch</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>get_scheduler</span><span class=p>(</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>    <span class=s2>&quot;linear&quot;</span><span class=p>,</span>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a>    <span class=n>optimizer</span><span class=o>=</span><span class=n>optimizer</span><span class=p>,</span>
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a>    <span class=n>num_warmup_steps</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a>    <span class=n>num_training_steps</span><span class=o>=</span><span class=n>num_training_steps</span><span class=p>,</span>
</span><span id=__span-66-12><a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=n>output_dir</span> <span class=o>=</span> <span class=s2>&quot;bert-finetuned-squad-accelerate&quot;</span>
</span></code></pre></div> <h3 id=_15>訓練ループの実行<a class=headerlink href=#_15 title="Permanent link">&para;</a></h3> <p>完全な訓練ループを実装します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=kn>from</span><span class=w> </span><span class=nn>tqdm.auto</span><span class=w> </span><span class=kn>import</span> <span class=n>tqdm</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=n>progress_bar</span> <span class=o>=</span> <span class=n>tqdm</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>num_training_steps</span><span class=p>))</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=nb>print</span><span class=p>(</span><span class=nb>next</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>())</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_train_epochs</span><span class=p>):</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a>    <span class=c1># 訓練フェーズ</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a>    <span class=k>for</span> <span class=n>step</span><span class=p>,</span> <span class=n>batch</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>train_dataloader</span><span class=p>):</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a>        <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a>        <span class=n>loss</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>loss</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a>        <span class=n>accelerator</span><span class=o>.</span><span class=n>backward</span><span class=p>(</span><span class=n>loss</span><span class=p>)</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-68-15><a id=__codelineno-68-15 name=__codelineno-68-15 href=#__codelineno-68-15></a>        <span class=n>lr_scheduler</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-68-16><a id=__codelineno-68-16 name=__codelineno-68-16 href=#__codelineno-68-16></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span><span id=__span-68-17><a id=__codelineno-68-17 name=__codelineno-68-17 href=#__codelineno-68-17></a>        <span class=n>progress_bar</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-68-18><a id=__codelineno-68-18 name=__codelineno-68-18 href=#__codelineno-68-18></a>
</span><span id=__span-68-19><a id=__codelineno-68-19 name=__codelineno-68-19 href=#__codelineno-68-19></a>    <span class=c1># 評価フェーズ</span>
</span><span id=__span-68-20><a id=__codelineno-68-20 name=__codelineno-68-20 href=#__codelineno-68-20></a>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span><span id=__span-68-21><a id=__codelineno-68-21 name=__codelineno-68-21 href=#__codelineno-68-21></a>    <span class=n>start_logits</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-68-22><a id=__codelineno-68-22 name=__codelineno-68-22 href=#__codelineno-68-22></a>    <span class=n>end_logits</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-68-23><a id=__codelineno-68-23 name=__codelineno-68-23 href=#__codelineno-68-23></a>    <span class=n>accelerator</span><span class=o>.</span><span class=n>print</span><span class=p>(</span><span class=s2>&quot;評価中!&quot;</span><span class=p>)</span>
</span><span id=__span-68-24><a id=__codelineno-68-24 name=__codelineno-68-24 href=#__codelineno-68-24></a>    <span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>eval_dataloader</span><span class=p>):</span>
</span><span id=__span-68-25><a id=__codelineno-68-25 name=__codelineno-68-25 href=#__codelineno-68-25></a>        <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-68-26><a id=__codelineno-68-26 name=__codelineno-68-26 href=#__codelineno-68-26></a>            <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-68-27><a id=__codelineno-68-27 name=__codelineno-68-27 href=#__codelineno-68-27></a>
</span><span id=__span-68-28><a id=__codelineno-68-28 name=__codelineno-68-28 href=#__codelineno-68-28></a>        <span class=n>start_logits</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>accelerator</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=n>outputs</span><span class=o>.</span><span class=n>start_logits</span><span class=p>)</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>())</span>
</span><span id=__span-68-29><a id=__codelineno-68-29 name=__codelineno-68-29 href=#__codelineno-68-29></a>        <span class=n>end_logits</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>accelerator</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=n>outputs</span><span class=o>.</span><span class=n>end_logits</span><span class=p>)</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>())</span>
</span><span id=__span-68-30><a id=__codelineno-68-30 name=__codelineno-68-30 href=#__codelineno-68-30></a>
</span><span id=__span-68-31><a id=__codelineno-68-31 name=__codelineno-68-31 href=#__codelineno-68-31></a>    <span class=n>start_logits</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>start_logits</span><span class=p>)</span>
</span><span id=__span-68-32><a id=__codelineno-68-32 name=__codelineno-68-32 href=#__codelineno-68-32></a>    <span class=n>end_logits</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>end_logits</span><span class=p>)</span>
</span><span id=__span-68-33><a id=__codelineno-68-33 name=__codelineno-68-33 href=#__codelineno-68-33></a>    <span class=n>start_logits</span> <span class=o>=</span> <span class=n>start_logits</span><span class=p>[:</span> <span class=nb>len</span><span class=p>(</span><span class=n>validation_dataset</span><span class=p>)]</span>
</span><span id=__span-68-34><a id=__codelineno-68-34 name=__codelineno-68-34 href=#__codelineno-68-34></a>    <span class=n>end_logits</span> <span class=o>=</span> <span class=n>end_logits</span><span class=p>[:</span> <span class=nb>len</span><span class=p>(</span><span class=n>validation_dataset</span><span class=p>)]</span>
</span><span id=__span-68-35><a id=__codelineno-68-35 name=__codelineno-68-35 href=#__codelineno-68-35></a>
</span><span id=__span-68-36><a id=__codelineno-68-36 name=__codelineno-68-36 href=#__codelineno-68-36></a>    <span class=c1># 最適閾値を計算してメトリクスを評価</span>
</span><span id=__span-68-37><a id=__codelineno-68-37 name=__codelineno-68-37 href=#__codelineno-68-37></a>    <span class=n>best_threshold</span> <span class=o>=</span> <span class=n>find_optimal_threshold</span><span class=p>(</span>
</span><span id=__span-68-38><a id=__codelineno-68-38 name=__codelineno-68-38 href=#__codelineno-68-38></a>        <span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>validation_dataset</span><span class=p>,</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>]</span>
</span><span id=__span-68-39><a id=__codelineno-68-39 name=__codelineno-68-39 href=#__codelineno-68-39></a>    <span class=p>)</span>
</span><span id=__span-68-40><a id=__codelineno-68-40 name=__codelineno-68-40 href=#__codelineno-68-40></a>
</span><span id=__span-68-41><a id=__codelineno-68-41 name=__codelineno-68-41 href=#__codelineno-68-41></a>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>compute_metrics</span><span class=p>(</span>
</span><span id=__span-68-42><a id=__codelineno-68-42 name=__codelineno-68-42 href=#__codelineno-68-42></a>        <span class=n>start_logits</span><span class=p>,</span> <span class=n>end_logits</span><span class=p>,</span> <span class=n>validation_dataset</span><span class=p>,</span> <span class=n>raw_datasets</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>],</span>
</span><span id=__span-68-43><a id=__codelineno-68-43 name=__codelineno-68-43 href=#__codelineno-68-43></a>        <span class=n>null_score_diff_threshold</span><span class=o>=</span><span class=n>best_threshold</span>
</span><span id=__span-68-44><a id=__codelineno-68-44 name=__codelineno-68-44 href=#__codelineno-68-44></a>    <span class=p>)</span>
</span><span id=__span-68-45><a id=__codelineno-68-45 name=__codelineno-68-45 href=#__codelineno-68-45></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;エポック </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2> (最適閾値: </span><span class=si>{</span><span class=n>best_threshold</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>):&quot;</span><span class=p>,</span> <span class=n>metrics</span><span class=p>)</span>
</span><span id=__span-68-46><a id=__codelineno-68-46 name=__codelineno-68-46 href=#__codelineno-68-46></a>
</span><span id=__span-68-47><a id=__codelineno-68-47 name=__codelineno-68-47 href=#__codelineno-68-47></a>    <span class=c1># 保存とアップロード</span>
</span><span id=__span-68-48><a id=__codelineno-68-48 name=__codelineno-68-48 href=#__codelineno-68-48></a>    <span class=n>accelerator</span><span class=o>.</span><span class=n>wait_for_everyone</span><span class=p>()</span>
</span><span id=__span-68-49><a id=__codelineno-68-49 name=__codelineno-68-49 href=#__codelineno-68-49></a>    <span class=n>unwrapped_model</span> <span class=o>=</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>unwrap_model</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</span><span id=__span-68-50><a id=__codelineno-68-50 name=__codelineno-68-50 href=#__codelineno-68-50></a>    <span class=n>unwrapped_model</span><span class=o>.</span><span class=n>save_pretrained</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>save_function</span><span class=o>=</span><span class=n>accelerator</span><span class=o>.</span><span class=n>save</span><span class=p>)</span>
</span><span id=__span-68-51><a id=__codelineno-68-51 name=__codelineno-68-51 href=#__codelineno-68-51></a>    <span class=k>if</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>is_main_process</span><span class=p>:</span>
</span><span id=__span-68-52><a id=__codelineno-68-52 name=__codelineno-68-52 href=#__codelineno-68-52></a>        <span class=n>tokenizer</span><span class=o>.</span><span class=n>save_pretrained</span><span class=p>(</span><span class=n>output_dir</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>エポック 0 (最適閾値: 4.00): {&#39;exact&#39;: 73.07335972374294, &#39;f1&#39;: 76.27284417400911, &#39;total&#39;: 11873, &#39;HasAns_exact&#39;: 66.31241565452092, &#39;HasAns_f1&#39;: 72.72055986471157, &#39;HasAns_total&#39;: 5928, &#39;NoAns_exact&#39;: 79.81497056349873, &#39;NoAns_f1&#39;: 79.81497056349873, &#39;NoAns_total&#39;: 5945, &#39;best_exact&#39;: 73.07335972374294, &#39;best_exact_thresh&#39;: 0.0, &#39;best_f1&#39;: 76.27284417400917, &#39;best_f1_thresh&#39;: 0.0}
</span></code></pre></div></p> <h2 id=_16>ファインチューニング済みモデルの使用<a class=headerlink href=#_16 title="Permanent link">&para;</a></h2> <p>ファインチューニングしたモデルを使用してみましょう。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>pipeline</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=c1># SQuAD 2.0対応のPipeline設定</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=n>model_checkpoint</span> <span class=o>=</span> <span class=s2>&quot;bert-finetuned-squad-accelerate&quot;</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=n>question_answerer</span> <span class=o>=</span> <span class=n>pipeline</span><span class=p>(</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a>    <span class=s2>&quot;question-answering&quot;</span><span class=p>,</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a>    <span class=n>model</span><span class=o>=</span><span class=n>model_checkpoint</span><span class=p>,</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a>    <span class=n>handle_impossible_answer</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># 重要：SQuAD 2.0サポート</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a>    <span class=n>max_answer_len</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a>    <span class=n>max_seq_len</span><span class=o>=</span><span class=mi>384</span><span class=p>,</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a>    <span class=n>doc_stride</span><span class=o>=</span><span class=mi>128</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=p>)</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=n>context</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=s2>🤗 Transformers is backed by the three most popular deep learning libraries — Jax, PyTorch and TensorFlow — with a seamless integration</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=s2>between them. It&#39;s straightforward to train your models with one before loading them for inference with the other.</span>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-70-18><a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a><span class=n>question</span> <span class=o>=</span> <span class=s2>&quot;Which deep learning libraries back 🤗 Transformers?&quot;</span>
</span><span id=__span-70-19><a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a>
</span><span id=__span-70-20><a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a><span class=c1># 基本的な推論</span>
</span><span id=__span-70-21><a id=__codelineno-70-21 name=__codelineno-70-21 href=#__codelineno-70-21></a><span class=n>result</span> <span class=o>=</span> <span class=n>question_answerer</span><span class=p>(</span><span class=n>question</span><span class=o>=</span><span class=n>question</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=n>context</span><span class=p>)</span>
</span><span id=__span-70-22><a id=__codelineno-70-22 name=__codelineno-70-22 href=#__codelineno-70-22></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;答え: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-70-23><a id=__codelineno-70-23 name=__codelineno-70-23 href=#__codelineno-70-23></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;スコア: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-70-24><a id=__codelineno-70-24 name=__codelineno-70-24 href=#__codelineno-70-24></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;開始位置: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;start&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-70-25><a id=__codelineno-70-25 name=__codelineno-70-25 href=#__codelineno-70-25></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;終了位置: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;end&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-70-26><a id=__codelineno-70-26 name=__codelineno-70-26 href=#__codelineno-70-26></a>
</span><span id=__span-70-27><a id=__codelineno-70-27 name=__codelineno-70-27 href=#__codelineno-70-27></a><span class=c1># 複数の候補を取得（より詳細な分析）</span>
</span><span id=__span-70-28><a id=__codelineno-70-28 name=__codelineno-70-28 href=#__codelineno-70-28></a><span class=n>results</span> <span class=o>=</span> <span class=n>question_answerer</span><span class=p>(</span>
</span><span id=__span-70-29><a id=__codelineno-70-29 name=__codelineno-70-29 href=#__codelineno-70-29></a>    <span class=n>question</span><span class=o>=</span><span class=n>question</span><span class=p>,</span>
</span><span id=__span-70-30><a id=__codelineno-70-30 name=__codelineno-70-30 href=#__codelineno-70-30></a>    <span class=n>context</span><span class=o>=</span><span class=n>context</span><span class=p>,</span>
</span><span id=__span-70-31><a id=__codelineno-70-31 name=__codelineno-70-31 href=#__codelineno-70-31></a>    <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span>  <span class=c1># トップ3の候補を取得</span>
</span><span id=__span-70-32><a id=__codelineno-70-32 name=__codelineno-70-32 href=#__codelineno-70-32></a><span class=p>)</span>
</span><span id=__span-70-33><a id=__codelineno-70-33 name=__codelineno-70-33 href=#__codelineno-70-33></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>トップ3の候補:&quot;</span><span class=p>)</span>
</span><span id=__span-70-34><a id=__codelineno-70-34 name=__codelineno-70-34 href=#__codelineno-70-34></a><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>res</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>):</span>
</span><span id=__span-70-35><a id=__codelineno-70-35 name=__codelineno-70-35 href=#__codelineno-70-35></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>res</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> (スコア: </span><span class=si>{</span><span class=n>res</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>答え: Jax, PyTorch and TensorFlow
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>スコア: 0.8929
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>開始位置: 78
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>終了位置: 105
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a>トップ3の候補:
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a>1. Jax, PyTorch and TensorFlow (スコア: 0.8929)
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a>2. Jax, PyTorch and TensorFlow — (スコア: 0.0314)
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a>3.  (スコア: 0.0012)
</span></code></pre></div></p> <h2 id=_17>評価指標の解説<a class=headerlink href=#_17 title="Permanent link">&para;</a></h2> <h3 id=exact-match-em>Exact Match (EM)<a class=headerlink href=#exact-match-em title="Permanent link">&para;</a></h3> <p>予測した答えが正解と完全に一致する割合です。大文字小文字や句読点は無視されます。</p> <h3 id=f1>F1スコア<a class=headerlink href=#f1 title="Permanent link">&para;</a></h3> <p>予測と正解の間での単語レベルの重複を測定します。各予測-正解ペアに対してF1スコアを計算し、最大値を取ります。</p> <h3 id=squad-20>SQuAD 2.0特有の指標<a class=headerlink href=#squad-20 title="Permanent link">&para;</a></h3> <ul> <li><strong>HasAns</strong>: 答えがある質問のみの性能</li> <li><strong>NoAns</strong>: 答えがない質問のみの性能</li> <li><strong>best_exact/best_f1</strong>: 最適な閾値での性能</li> </ul> <h2 id=_18>まとめ<a class=headerlink href=#_18 title="Permanent link">&para;</a></h2> <p>この記事では、BERTモデルをSQuADデータセットでファインチューニングして質問応答システムを構築する方法を学びました。主なポイントは以下の通りです：</p> <ol> <li><strong>データ前処理</strong>: 長い文脈を適切に分割し、オフセットマッピングを活用してラベルを生成</li> <li><strong>モデル学習</strong>: TrainerAPIとカスタム訓練ループの両方を実装</li> <li><strong>評価</strong>: SQuAD 2.0の複雑な評価指標を理解し、答えのない質問への対応</li> <li><strong>後処理</strong>: モデルの予測をテキストスパンに変換する効率的なアルゴリズム</li> </ol> <p>最終的に得られたモデルは、約76%のF1スコアを達成し、実用的な質問応答システムとして活用できます。</p> <h2 id=_19>参考資料<a class=headerlink href=#_19 title="Permanent link">&para;</a></h2> <ul> <li><a href=https://rajpurkar.github.io/SQuAD-explorer/ >SQuAD Dataset</a></li> <li><a href=https://huggingface.co/docs/transformers>Hugging Face Transformers Documentation</a></li> <li><a href=https://arxiv.org/abs/1810.04805>BERT: Pre-training of Deep Bidirectional Transformers</a></li> <li><a href=https://arxiv.org/abs/1806.03822>SQuAD 2.0 Paper</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最終更新日> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年9月28日 19:08:34 JST">2025年9月28日 19:08:34</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> ページトップへ戻る </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 - 2025 vinsmoke-three </div> </div> <div class=md-social> <a href=https://github.com/vinsmoke-three target=_blank rel=noopener title=GitHub class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.copy", "navigation.expand", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"BERT": "bert", "CNN": "convolutional-neural-network", "FashionMNIST": "fashion-mnist", "GPT": "gpt", "LLM": "large-language-model", "ML\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3": "ml-pipeline", "NLP": "nlp", "PyTorch": "pytorch", "Python": "python", "TensorBoard": "tensorboard", "TinyVGG": "tinyvgg", "Transformer": "transformer", "\u30ab\u30b9\u30bf\u30e0\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8": "custom-datasets", "\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30d3\u30b8\u30e7\u30f3": "computer-vision", "\u30b9\u30af\u30ea\u30d7\u30c8\u30e2\u30fc\u30c9": "script-mode", "\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb": "tutorial", "\u30c6\u30f3\u30bd\u30eb": "tensor", "\u30c7\u30fc\u30bf\u62e1\u5f35": "data-augmentation", "\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af": "neural-network", "\u30e2\u30b8\u30e5\u30fc\u30eb\u5316": "modularization", "\u30ef\u30fc\u30af\u30d5\u30ed\u30fc": "workflow", "\u4e0a\u7d1a\u8005\u5411\u3051": "advanced", "\u4e2d\u7d1a\u8005\u5411\u3051": "intermediate", "\u518d\u5229\u7528": "reusability", "\u5206\u985e": "classification", "\u521d\u5fc3\u8005\u5411\u3051": "beginner", "\u5927\u898f\u6a21\u8a00\u8a9e\u30e2\u30c7\u30eb": "large-language-model", "\u5b9f\u8df5": "practical", "\u5b9f\u9a13\u8ffd\u8de1": "experiment-tracking", "\u6a5f\u68b0\u5b66\u7fd2": "machine-learning", "\u6df1\u5c64\u5b66\u7fd2": "deep-learning", "\u753b\u50cf\u5206\u985e": "image-classification", "\u7dda\u5f62\u56de\u5e30": "linear-regression", "\u81ea\u7136\u8a00\u8a9e\u51e6\u7406": "natural-language-processing", "\u8ee2\u79fb\u5b66\u7fd2": "transfer-learning"}, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src=../../../javascripts/meta.js></script> <script src=../../../javascripts/structured-data.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>