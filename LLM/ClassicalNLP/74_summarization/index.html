<!doctype html><html lang=ja class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=Transformerモデル（T5）を使用して長い文書を要約する方法を学びます。CNN/DailyMailデータセットを用いたファインチューニングから評価まで、実践的な実装を詳しく解説します。><meta name=author content=vinsmoke-three><link href=https://vinsmoke-three.com/LLM/ClassicalNLP/74_summarization/ rel=canonical><link href=../73_translation/ rel=prev><link href=../75_question_answering/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.20"><title>Transformerを使ったテキスト要約の実装ガイド - T5モデルによる文書要約 - vinsmoke-three - 機械学習・深層学習ドキュメント</title><link rel=stylesheet href=../../../assets/stylesheets/main.e53b48f4.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-BXKYE0NT9N"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-BXKYE0NT9N",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-BXKYE0NT9N",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#transformer class=md-skip> コンテンツにスキップ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=ヘッダー> <a href=../../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-header__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> vinsmoke-three - 機械学習・深層学習ドキュメント </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Transformerを使ったテキスト要約の実装ガイド - T5モデルによる文書要約 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=検索 placeholder=検索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=検索> <a href=javascript:void(0) class="md-search__icon md-icon" title=共有 aria-label=共有 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=クリア aria-label=クリア tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 検索を初期化 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=タブ data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../PyTorch/00_setup/ class=md-tabs__link> PyTorch </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../00_illustrated_transformer/ class=md-tabs__link> LLM </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=ナビゲーション data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="vinsmoke-three - 機械学習・深層学習ドキュメント" class="md-nav__button md-logo" aria-label="vinsmoke-three - 機械学習・深層学習ドキュメント" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 14.27 10.64 13A11.24 11.24 0 0 0 5 10.18v6.95c2.61.34 5 1.34 7 2.82 2-1.48 4.39-2.48 7-2.82v-6.95c-2.16.39-4.09 1.39-5.64 2.82M19 8.15c.65-.1 1.32-.15 2-.15v11c-3.5 0-6.64 1.35-9 3.54C9.64 20.35 6.5 19 3 19V8c.68 0 1.35.05 2 .15 2.69.41 5.1 1.63 7 3.39 1.9-1.76 4.31-2.98 7-3.39M12 6c.27 0 .5-.1.71-.29.19-.21.29-.44.29-.71s-.1-.5-.29-.71C12.5 4.11 12.27 4 12 4s-.5.11-.71.29c-.18.21-.29.45-.29.71s.11.5.29.71c.21.19.45.29.71.29m2.12 1.12a2.997 2.997 0 1 1-4.24-4.24 2.997 2.997 0 1 1 4.24 4.24"/></svg> </a> vinsmoke-three - 機械学習・深層学習ドキュメント </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> PyTorch </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> PyTorch </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../PyTorch/00_setup/ class=md-nav__link> <span class=md-ellipsis> 0. setup </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/01_pytorch_fundamentals/ class=md-nav__link> <span class=md-ellipsis> 1. PyTorch fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/02_pytorch_workflow/ class=md-nav__link> <span class=md-ellipsis> 2. PyTorch workflow </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/03_pytorch_classification/ class=md-nav__link> <span class=md-ellipsis> 3. PyTorch classification </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/04_pytorch_computer_vision/ class=md-nav__link> <span class=md-ellipsis> 4. PyTorch computer vision </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/05_pytorch_custom_datasets/ class=md-nav__link> <span class=md-ellipsis> 5. PyTorch custom datasets </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/06_pytorch_modular/ class=md-nav__link> <span class=md-ellipsis> 6. PyTorch modular </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/07_pytorch_transfer_learning/ class=md-nav__link> <span class=md-ellipsis> 7. PyTorch transfer learning </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/08_pytorch_experiment_tracking/ class=md-nav__link> <span class=md-ellipsis> 8. PyTorch experiment tracking </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/09_pytorch_paper_replicating/ class=md-nav__link> <span class=md-ellipsis> 9. PyTorch paper replicating </span> </a> </li> <li class=md-nav__item> <a href=../../../PyTorch/10_pytorch_model_deployment/ class=md-nav__link> <span class=md-ellipsis> 10. PyTorch model deployment </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> LLM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LLM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../00_illustrated_transformer/ class=md-nav__link> <span class=md-ellipsis> 0. The illustrated transformer </span> </a> </li> <li class=md-nav__item> <a href=../../01_transformer_models/ class=md-nav__link> <span class=md-ellipsis> 1. Transformer models </span> </a> </li> <li class=md-nav__item> <a href=../../02_using_transformers/ class=md-nav__link> <span class=md-ellipsis> 2. Using transformers </span> </a> </li> <li class=md-nav__item> <a href=../../03_fine_tuning_a_pretrained_model/ class=md-nav__link> <span class=md-ellipsis> 3. Fine-tuning a pretrained model </span> </a> </li> <li class=md-nav__item> <a href=../../04_the_huggingface_tokenizers_library/ class=md-nav__link> <span class=md-ellipsis> 4. Tokenizers library </span> </a> </li> <li class=md-nav__item> <a href=../../05_Let%27s_build_GPT_from_scratch/ class=md-nav__link> <span class=md-ellipsis> 5. Let't build GPT from scratch </span> </a> </li> <li class=md-nav__item> <a href=../../06_the_huggingface_datasets_library/ class=md-nav__link> <span class=md-ellipsis> 6. Datasets library </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8 checked> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex=0> <span class=md-ellipsis> 7. Classical NLP Tasks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=true> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> 7. Classical NLP Tasks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../71_token_classification/ class=md-nav__link> <span class=md-ellipsis> Token Classification </span> </a> </li> <li class=md-nav__item> <a href=../72_masked_language_modeling/ class=md-nav__link> <span class=md-ellipsis> Masked Language Modeling </span> </a> </li> <li class=md-nav__item> <a href=../73_translation/ class=md-nav__link> <span class=md-ellipsis> Translation </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Summarization </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Summarization </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> データセットの準備 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> テキスト要約のためのモデル </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#trainer-apit5 class=md-nav__link> <span class=md-ellipsis> Trainer APIを使用したT5のファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#hugging-face-acceleratet5 class=md-nav__link> <span class=md-ellipsis> Hugging Face Accelerateを使ったT5のファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 学習結果の分析と活用 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 性能向上のための追加技術 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 実用的な活用例 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../75_question_answering/ class=md-nav__link> <span class=md-ellipsis> Question Answering </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 概要 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前提知識 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> データセットの準備 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> テキスト要約のためのモデル </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> データの前処理 </span> </a> </li> <li class=md-nav__item> <a href=#trainer-apit5 class=md-nav__link> <span class=md-ellipsis> Trainer APIを使用したT5のファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#hugging-face-acceleratet5 class=md-nav__link> <span class=md-ellipsis> Hugging Face Accelerateを使ったT5のファインチューニング </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 学習結果の分析と活用 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 性能向上のための追加技術 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 実用的な活用例 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> まとめ </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 参考資料 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=transformer>Transformerを使ったテキスト要約の実装ガイド<a class=headerlink href=#transformer title="Permanent link">&para;</a></h1> <h2 id=_1>概要<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>この記事では、Transformerモデルを利用して長い文書を短い要約に変換する<strong>テキスト要約（Text Summarization）</strong>の実装方法について詳しく解説します。テキスト要約は、長い文章の理解と一貫性のあるテキスト生成という複数の能力を必要とする、最も難易度の高いNLPタスクの一つです。しかし、適切に実装されたテキスト要約システムは、専門家の文書読解負担を軽減し、様々なビジネスプロセスを効率化する強力なツールとなります。</p> <div class="admonition info"> <p class=admonition-title>参考資料</p> <p>本ドキュメントは <a href=https://huggingface.co/learn/llm-course/chapter7/5>Hugging Face LLM Course</a> を参考に、日本語で学習内容をまとめた個人的な学習ノートです。詳細な内容や最新情報については、原文も併せてご参照ください。</p> </div> <h2 id=_2>前提知識<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>この記事を理解するために、以下の知識があることを推奨します：</p> <ul> <li><strong>Python基礎</strong>: pandas, numpy等の基本的な使用方法</li> <li><strong>機械学習の基礎</strong>: 学習、検証、評価の概念</li> <li><strong>Transformerアーキテクチャ</strong>: Encoder-Decoderモデルの基本理解</li> <li><strong>Hugging Face Transformers</strong>: 基本的な使用方法</li> </ul> <h2 id=_3>データセットの準備<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>CNN/DailyMailデータセットを利用して要約システムを構築していきます。このデータセットは、ニュース記事とそのハイライト（要約）のペアを含む、テキスト要約タスクで広く利用されているベンチマークデータセットです。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>from</span><span class=w> </span><span class=nn>datasets</span><span class=w> </span><span class=kn>import</span> <span class=n>load_dataset</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=c1># CNN/DailyMailデータセットを読み込み</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=n>datasets</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&quot;cnn_dailymail&quot;</span><span class=p>,</span> <span class=s2>&quot;3.0.0&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>datasets</span>
</span></code></pre></div></p> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>DatasetDict({
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>    train: Dataset({
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>        features: [&#39;article&#39;, &#39;highlights&#39;, &#39;id&#39;],
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>        num_rows: 287113
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    })
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>    validation: Dataset({
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>        features: [&#39;article&#39;, &#39;highlights&#39;, &#39;id&#39;],
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>        num_rows: 13368
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>    })
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    test: Dataset({
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>        features: [&#39;article&#39;, &#39;highlights&#39;, &#39;id&#39;],
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>        num_rows: 11490
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>    })
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>})
</span></code></pre></div></p> <p>ご覧の通り、訓練用データセットには287,113件の記事が含まれています。このデータセットで重要な情報は<code>article</code>列（元の記事）と<code>highlights</code>列（要約）に格納されています。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># データの構造を確認</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>{&#39;article&#39;: &#39;Editor\&#39;s note: In our Behind the Scenes series, CNN correspondents share their experiences in covering news and analyze the stories behind the events. Here, Soledad O\&#39;Brien takes users inside a jail where many of the inmates are mentally ill. An inmate housed on the &quot;forgotten floor,&quot; where many mentally ill inmates are housed in Miami before trial. MIAMI, Florida (CNN) -- The ninth floor of the Miami-Dade pretrial detention facility is dubbed the &quot;forgotten floor.&quot; Here, inmates with the most severe mental illnesses are incarcerated until they\&#39;re ready to appear in court. Most often, they face drug charges or charges of assaulting an officer --charges that Judge Steven Leifman says are usually &quot;avoidable felonies.&quot; He says the arrests often result from confrontations with police. Mentally ill people often won\&#39;t do what they\&#39;re told when police arrive on the scene -- confrontation seems to exacerbate their illness and they become more paranoid, delusional, and less likely to follow directions, according to Leifman. So, they end up on the ninth floor severely mentally disturbed, but not getting any real help because they\&#39;re in jail. We toured the jail with Leifman. He is well known in Miami as an advocate for justice and the mentally ill. Even though we were not exactly welcomed with open arms by the guards, we were given permission to shoot videotape and tour the floor.  Go inside the \&#39;forgotten floor\&#39; Â» . At first, it\&#39;s hard to determine where the people are. The prisoners are wearing sleeveless robes. Imagine cutting holes for arms and feet in a heavy wool sleeping bag -- that\&#39;s kind of what they look like. They\&#39;re designed to keep the mentally ill patients from injuring themselves. That\&#39;s also why they have no shoes, laces or mattresses. Leifman says about one-third of all people in Miami-Dade county jails are mentally ill. So, he says, the sheer volume is overwhelming the system, and the result is what we see on the ninth floor. Of course, it is a jail, so it\&#39;s not supposed to be warm and comforting, but the lights glare, the cells are tiny and it\&#39;s loud. We see two, sometimes three men -- sometimes in the robes, sometimes naked, lying or sitting in their cells. &quot;I am the son of the president. You need to get me out of here!&quot; one man shouts at me. He is absolutely serious, convinced that help is on the way -- if only he could reach the White House. Leifman tells me that these prisoner-patients will often circulate through the system, occasionally stabilizing in a mental hospital, only to return to jail to face their charges. It\&#39;s brutally unjust, in his mind, and he has become a strong advocate for changing things in Miami. Over a meal later, we talk about how things got this way for mental patients. Leifman says 200 years ago people were considered &quot;lunatics&quot; and they were locked up in jails even if they had no charges against them. They were just considered unfit to be in society. Over the years, he says, there was some public outcry, and the mentally ill were moved out of jails and into hospitals. But Leifman says many of these mental hospitals were so horrible they were shut down. Where did the patients go? Nowhere. The streets. They became, in many cases, the homeless, he says. They never got treatment. Leifman says in 1955 there were more than half a million people in state mental hospitals, and today that number has been reduced 90 percent, and 40,000 to 50,000 people are in mental hospitals. The judge says he\&#39;s working to change this. Starting in 2008, many inmates who would otherwise have been brought to the &quot;forgotten floor&quot;  will instead be sent to a new mental health facility -- the first step on a journey toward long-term treatment, not just punishment. Leifman says it\&#39;s not the complete answer, but it\&#39;s a start. Leifman says the best part is that it\&#39;s a win-win solution. The patients win, the families are relieved, and the state saves money by simply not cycling these prisoners through again and again. And, for Leifman, justice is served. E-mail to a friend .&#39;,
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a> &#39;highlights&#39;: &#39;Mentally ill inmates in Miami are housed on the &quot;forgotten floor&quot;\nJudge Steven Leifman says most are there as a result of &quot;avoidable felonies&quot;\nWhile CNN tours facility, patient shouts: &quot;I am the son of the president&quot;\nLeifman says the system is unjust and he\&#39;s fighting for change .&#39;,
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a> &#39;id&#39;: &#39;ee8871b15c50d0db17b0179a6d2beab35065f1e9&#39;}
</span></code></pre></div></p> <p>このデータ例からわかるように、<code>article</code>フィールドには長いニュース記事が、<code>highlights</code>フィールドにはその要約が格納されています。</p> <h2 id=_4>テキスト要約のためのモデル<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>テキスト要約は機械翻訳に似たタスクと考えることができます。レビューなどのテキストの本体を、入力の重要な特徴を捉えた短いバージョンに「翻訳」したいからです。そのため、要約用のほとんどのTransformerモデルは、基本的なEncoder-Decoderアーキテクチャを採用しています。ただし、Few-shot設定で要約に利用できるGPTファミリーのモデルなど、いくつかの例外もあります。</p> <p>以下の表は、要約のためにファインチューニングに適した代表的な事前学習済みモデルをリストアップしたものです：</p> <table> <thead> <tr> <th style="text-align: center;">Transformerモデル</th> <th>説明</th> <th style="text-align: center;">多言語対応</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;"><a href=https://huggingface.co/gpt2-xl>GPT-2</a></td> <td>自己回帰言語モデルとして学習されていますが、入力テキストの最後に「TL;DR」を追加することでGPT-2に要約を生成させることができます。</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: center;"><a href=https://huggingface.co/google/pegasus-large>PEGASUS</a></td> <td>複数文テキストでマスクされた文を予測する事前学習目的を使用します。この事前学習目的は、バニラ言語モデリングよりも要約に近く、人気のベンチマークで高いスコアを記録しています。</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: center;"><a href=https://huggingface.co/t5-base>T5</a></td> <td>すべてのタスクをtext-to-textフレームワークで定式化するユニバーサルTransformerアーキテクチャ。例：文書を要約するモデルの入力形式は <code>summarize: ARTICLE</code> です。</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: center;"><a href=https://huggingface.co/google/mt5-base>mT5</a></td> <td>T5の多言語版で、101言語をカバーする多言語Common Crawlコーパス（mC4）で事前学習されています。</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: center;"><a href=https://huggingface.co/facebook/bart-base>BART</a></td> <td>破損した入力を再構築するように学習された、エンコーダーとデコーダーの両方のスタックを持つ新しいTransformerアーキテクチャで、BERTとGPT-2の事前学習スキームを組み合わせています。</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: center;"><a href=https://huggingface.co/facebook/mbart-large-50>mBART-50</a></td> <td>BARTの多言語版で、50言語で事前学習されています。</td> <td style="text-align: center;">✅</td> </tr> </tbody> </table> <p>この表からわかるように、要約（そして実際にはほとんどのNLPタスク）用のTransformerモデルの大部分は単言語です。これは、英語やドイツ語などの「高リソース」言語でのタスクには最適ですが、世界中で利用されている何千もの他の言語にはあまり適していません。幸い、mT5やmBARTなどの多言語Transformerモデルのクラスが解決策を提供しています。これらのモデルは言語モデリングを利用して事前学習されていますが、特徴的な点があります。1つの言語のコーパスで学習する代わりに、50以上の言語のテキストで同時に共同学習されています。</p> <h2 id=_5>データの前処理<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <p>次のタスクは、記事とそのタイトルをトークン化してエンコードすることです。いつものように、事前学習済みモデルのチェックポイントに関連付けられたトークナイザーを読み込むことから始めます。合理的な時間でモデルをファインチューニングできるように、チェックポイントとして<code>t5-small</code>を使用します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>T5Tokenizer</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1># T5モデルのトークナイザーを読み込み</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=n>model_checkpoint</span> <span class=o>=</span> <span class=s2>&quot;t5-small&quot;</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>T5Tokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_checkpoint</span><span class=p>)</span>
</span></code></pre></div> <p>小さな例でT5トークナイザーをテストしてみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># トークナイザーのテスト</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span><span class=s2>&quot;I loved reading the Hunger Games!&quot;</span><span class=p>)</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=n>inputs</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>{&#39;input_ids&#39;: [27, 1858, 1183, 8, 26049, 5880, 55, 1], &#39;attention_mask&#39;: [1, 1, 1, 1, 1, 1, 1, 1]}
</span></code></pre></div></p> <p>ここでは、おなじみの<code>input_ids</code>と<code>attention_mask</code>が見られます。トークナイザーの<code>convert_ids_to_tokens()</code>関数でこれらの入力IDをデコードして、どのようなトークナイザーを扱っているかを見てみましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1># トークンに変換して内容を確認</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=n>tokenizer</span><span class=o>.</span><span class=n>convert_ids_to_tokens</span><span class=p>(</span><span class=n>inputs</span><span class=o>.</span><span class=n>input_ids</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>[&#39;▁I&#39;, &#39;▁loved&#39;, &#39;▁reading&#39;, &#39;▁the&#39;, &#39;▁Hunger&#39;, &#39;▁Games&#39;, &#39;!&#39;, &#39;&lt;/s&gt;&#39;]
</span></code></pre></div></p> <p>特殊なUnicode文字<code>▁</code>と終了シーケンストークン<code>&lt;/s&gt;</code>は、Unigramセグメンテーションアルゴリズムに基づくSentencePieceトークナイザーを扱っていることを示しています。Unigramは、アクセント、句読点、そして日本語のように空白文字を持たない多くの言語について、SentencePieceが言語に依存しないようにするため、多言語コーパスに特に有用です。</p> <p>T5にはタスクプレフィックスが必要です。以下はT5の処理の例です：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># 前処理関数の定義</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess_function</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=c1># T5にはタスクプレフィックスが必要</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    <span class=n>inputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;summarize: &quot;</span> <span class=o>+</span> <span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;article&quot;</span><span class=p>]]</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>    <span class=n>targets</span> <span class=o>=</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&quot;highlights&quot;</span><span class=p>]</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>    <span class=c1># 入力とターゲットをトークン化</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>    <span class=n>model_inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>        <span class=n>inputs</span><span class=p>,</span> 
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span>  <span class=c1># 最大入力長</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>        <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>        <span class=n>padding</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>    <span class=p>)</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>    <span class=c1># ターゲットテキストをトークン化</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>    <span class=k>with</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>as_target_tokenizer</span><span class=p>():</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>        <span class=n>labels</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>            <span class=n>targets</span><span class=p>,</span> 
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>            <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>  <span class=c1># 要約は通常短い</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>            <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> 
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a>            <span class=n>padding</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>        <span class=p>)</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>    <span class=n>model_inputs</span><span class=p>[</span><span class=s2>&quot;labels&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>]</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a>    <span class=k>return</span> <span class=n>model_inputs</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=c1># 前処理を適用</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>preprocess_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <h2 id=trainer-apit5>Trainer APIを使用したT5のファインチューニング<a class=headerlink href=#trainer-apit5 title="Permanent link">&para;</a></h2> <p>要約のためのモデルのファインチューニングは、他の一般的なNLPタスクと非常に似ています。最初にやるべきことは、<code>t5-small</code>チェックポイントから事前学習済みモデルを読み込むことです。要約はsequence-to-sequenceタスクなので、<code>AutoModelForSeq2SeqLM</code>クラスでモデルを読み込むことができ、これによって重みが自動的にダウンロードされキャッシュされます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>T5ForConditionalGeneration</span><span class=p>,</span> <span class=n>T5Tokenizer</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kn>import</span><span class=w> </span><span class=nn>torch</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=c1># デバイスの設定とモデルの読み込み</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=n>device</span> <span class=o>=</span> <span class=s2>&quot;mps&quot;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>mps</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&quot;cpu&quot;</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=n>model_name</span> <span class=o>=</span> <span class=s2>&quot;t5-small&quot;</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>T5Tokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=n>model</span> <span class=o>=</span> <span class=n>T5ForConditionalGeneration</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></code></pre></div> <p>学習中にROUGEスコアを計算するために要約を生成する必要があります。幸い、Hugging Face Transformersは、これを自動的に行ってくれる専用の<code>Seq2SeqTrainingArguments</code>と<code>Seq2SeqTrainer</code>クラスを提供しています！これがどのように機能するかを確認するために、まず実験のハイパーパラメータとその他の引数を定義しましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>Seq2SeqTrainingArguments</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=c1># 学習引数の設定</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=n>training_args</span> <span class=o>=</span> <span class=n>Seq2SeqTrainingArguments</span><span class=p>(</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=n>output_dir</span><span class=o>=</span><span class=s2>&quot;./t5-small-cnn-summarization&quot;</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>    <span class=n>eval_strategy</span><span class=o>=</span><span class=s2>&quot;steps&quot;</span><span class=p>,</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>    <span class=n>eval_steps</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>    <span class=n>save_steps</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>    <span class=n>logging_steps</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>    <span class=n>per_device_train_batch_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>    <span class=n>per_device_eval_batch_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>    <span class=n>num_train_epochs</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>3e-4</span><span class=p>,</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>    <span class=n>warmup_steps</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>    <span class=n>weight_decay</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>    <span class=n>fp16</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>    <span class=n>save_total_limit</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>    <span class=n>load_best_model_at_end</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>    <span class=n>metric_for_best_model</span><span class=o>=</span><span class=s2>&quot;rouge1&quot;</span><span class=p>,</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a>    <span class=n>greater_is_better</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a>    <span class=c1># Seq2Seq固有のパラメータ</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a>    <span class=n>predict_with_generate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># 評価にgenerate()を使用</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a>    <span class=n>generation_max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>   <span class=c1># 最大生成長</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a>    <span class=n>generation_num_beams</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>      <span class=c1># より良い品質のためのビームサーチ</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a>    <span class=n>dataloader_num_workers</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a>    <span class=n>report_to</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=p>)</span>
</span></code></pre></div> <p>次に行う必要があることは、学習中にモデルを評価できるように、トレーナーに<code>compute_metrics()</code>関数を提供することです。要約に対してはこれが単純に予測に対して<code>rouge_score.compute()</code>を呼び出すよりもう少し複雑になります。ROUGEスコアを計算する前に、出力とラベルをテキストに_デコード_する必要があるからです。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kn>from</span><span class=w> </span><span class=nn>rouge_score</span><span class=w> </span><span class=kn>import</span> <span class=n>rouge_scorer</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=c1># 評価関数の定義</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=k>def</span><span class=w> </span><span class=nf>compute_metrics</span><span class=p>(</span><span class=n>eval_pred</span><span class=p>):</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>    <span class=n>predictions</span><span class=p>,</span> <span class=n>labels</span> <span class=o>=</span> <span class=n>eval_pred</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>    <span class=c1># 予測をデコード</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>    <span class=n>decoded_preds</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>batch_decode</span><span class=p>(</span><span class=n>predictions</span><span class=p>,</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>    <span class=c1># ラベルの-100を置換してデコード</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>    <span class=n>labels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>labels</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>100</span><span class=p>,</span> <span class=n>labels</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>pad_token_id</span><span class=p>)</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>    <span class=n>decoded_labels</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>batch_decode</span><span class=p>(</span><span class=n>labels</span><span class=p>,</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>    <span class=c1># ROUGEスコアを計算</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>    <span class=n>scorer</span> <span class=o>=</span> <span class=n>rouge_scorer</span><span class=o>.</span><span class=n>RougeScorer</span><span class=p>([</span><span class=s1>&#39;rouge1&#39;</span><span class=p>,</span> <span class=s1>&#39;rouge2&#39;</span><span class=p>,</span> <span class=s1>&#39;rougeL&#39;</span><span class=p>],</span> <span class=n>use_stemmer</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a>    <span class=n>rouge_scores</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a>    <span class=k>for</span> <span class=n>pred</span><span class=p>,</span> <span class=n>ref</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>decoded_preds</span><span class=p>,</span> <span class=n>decoded_labels</span><span class=p>):</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a>        <span class=n>scores</span> <span class=o>=</span> <span class=n>scorer</span><span class=o>.</span><span class=n>score</span><span class=p>(</span><span class=n>ref</span><span class=p>,</span> <span class=n>pred</span><span class=p>)</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a>        <span class=n>rouge_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a>    <span class=c1># 平均スコアを計算</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a>    <span class=n>result</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>,</span> <span class=s1>&#39;rouge2&#39;</span><span class=p>,</span> <span class=s1>&#39;rougeL&#39;</span><span class=p>]:</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a>        <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>score</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>fmeasure</span> <span class=k>for</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>rouge_scores</span><span class=p>]</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a>        <span class=n>result</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a>    <span class=k>return</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></code></pre></div> <p>次に、sequence-to-sequenceタスクのためのデータ照合器を定義する必要があります。幸い、Hugging Face Transformersは、入力とラベルを動的にパディングしてくれる<code>DataCollatorForSeq2Seq</code>照合器を提供しています。この照合器をインスタンス化するには、単に<code>tokenizer</code>と<code>model</code>を提供すれば済みます。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>DataCollatorForSeq2Seq</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=c1># データ照合器の設定</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=n>data_collator</span> <span class=o>=</span> <span class=n>DataCollatorForSeq2Seq</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <p>ついに学習に必要なすべての要素が揃いました！標準的な引数でトレーナーをインスタンス化するだけです：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>Seq2SeqTrainer</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=c1># Trainerの代わりにSeq2SeqTrainerを使用</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=n>trainer</span> <span class=o>=</span> <span class=n>Seq2SeqTrainer</span><span class=p>(</span>  <span class=c1># 単なるTrainerではない</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>    <span class=n>args</span><span class=o>=</span><span class=n>training_args</span><span class=p>,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>    <span class=n>train_dataset</span><span class=o>=</span><span class=n>tokenized_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>],</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>    <span class=n>eval_dataset</span><span class=o>=</span><span class=n>tokenized_dataset</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>],</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>    <span class=n>processing_class</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>    <span class=n>data_collator</span><span class=o>=</span><span class=n>data_collator</span><span class=p>,</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>    <span class=n>compute_metrics</span><span class=o>=</span><span class=n>compute_metrics</span><span class=p>,</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># 学習開始（コメントアウト済み - デモンストレーション用）</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=c1># trainer.train()</span>
</span></code></pre></div> <h2 id=hugging-face-acceleratet5>Hugging Face Accelerateを使ったT5のファインチューニング<a class=headerlink href=#hugging-face-acceleratet5 title="Permanent link">&para;</a></h2> <p>Hugging Face Accelerateでモデルをファインチューニングすることは、一般的なテキスト分類の例と非常に似ています。主な違いは、学習中に明示的に要約を生成する必要があることと、ROUGEスコアの計算方法を定義することです（<code>Seq2SeqTrainer</code>が生成を処理してくれたことを思い出してください）。これらの2つの要件をHugging Face Accelerate内でどのように実装できるかを見てみましょう！</p> <h3 id=_6>学習のためのすべての準備<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>最初にやるべきことは、各分割に対して<code>DataLoader</code>を作成することです。PyTorchデータローダーはテンソルのバッチを期待するので、データセットの形式を<code>"torch"</code>に設定する必要があります：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1># データセットの形式をPyTorchテンソルに設定</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=n>tokenized_dataset</span><span class=o>.</span><span class=n>set_format</span><span class=p>(</span><span class=s2>&quot;torch&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>テンソルだけで構成されるデータセットができたので、次に<code>DataCollatorForSeq2Seq</code>を再度インスタンス化します。このためにモデルの新しいバージョンが必要なので、キャッシュから再度読み込みましょう：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># モデルを再読み込み</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=n>model</span> <span class=o>=</span> <span class=n>T5ForConditionalGeneration</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></code></pre></div> <p>その後、データ照合器をインスタンス化し、これを使用してデータローダーを定義できます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=kn>from</span><span class=w> </span><span class=nn>torch.utils.data</span><span class=w> </span><span class=kn>import</span> <span class=n>DataLoader</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=c1># 前処理を適用（列を除去して新しいものに）</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=n>tokenized_dataset</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>preprocess_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>remove_columns</span><span class=o>=</span><span class=n>datasets</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>column_names</span><span class=p>)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=c1># データ照合器</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=n>data_collator</span> <span class=o>=</span> <span class=n>DataCollatorForSeq2Seq</span><span class=p>(</span><span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>)</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=c1># データローダーを作成</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=n>train_dataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>    <span class=n>tokenized_dataset</span><span class=p>[</span><span class=s2>&quot;train&quot;</span><span class=p>],</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a>    <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>    <span class=n>collate_fn</span><span class=o>=</span><span class=n>data_collator</span><span class=p>,</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=p>)</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=n>eval_dataloader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>(</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>    <span class=n>tokenized_dataset</span><span class=p>[</span><span class=s2>&quot;validation&quot;</span><span class=p>],</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a>    <span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a>    <span class=n>collate_fn</span><span class=o>=</span><span class=n>data_collator</span><span class=p>,</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=p>)</span>
</span></code></pre></div> <p>次に行うことは、使用したいオプティマイザーを定義することです。他の例と同様に、ほとんどの問題でうまく動作する<code>AdamW</code>を使用します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>get_linear_schedule_with_warmup</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=kn>from</span><span class=w> </span><span class=nn>torch.optim</span><span class=w> </span><span class=kn>import</span> <span class=n>AdamW</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=c1># オプティマイザーとスケジューラー</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=n>optimizer</span> <span class=o>=</span> <span class=n>AdamW</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>parameters</span><span class=p>(),</span> <span class=n>lr</span><span class=o>=</span><span class=mf>3e-4</span><span class=p>,</span> <span class=n>weight_decay</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=n>num_epochs</span> <span class=o>=</span> <span class=mi>3</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=n>num_training_steps</span> <span class=o>=</span> <span class=n>num_epochs</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_dataloader</span><span class=p>)</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=n>num_warmup_steps</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=n>num_training_steps</span> <span class=o>//</span> <span class=mi>10</span><span class=p>)</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>get_linear_schedule_with_warmup</span><span class=p>(</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>    <span class=n>optimizer</span><span class=o>=</span><span class=n>optimizer</span><span class=p>,</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a>    <span class=n>num_warmup_steps</span><span class=o>=</span><span class=n>num_warmup_steps</span><span class=p>,</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a>    <span class=n>num_training_steps</span><span class=o>=</span><span class=n>num_training_steps</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=p>)</span>
</span></code></pre></div> <p>最後に、モデル、オプティマイザー、データローダーを<code>accelerator.prepare()</code>メソッドに渡します：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kn>from</span><span class=w> </span><span class=nn>accelerate</span><span class=w> </span><span class=kn>import</span> <span class=n>Accelerator</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=c1># acceleratorを初期化</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=n>accelerator</span> <span class=o>=</span> <span class=n>Accelerator</span><span class=p>()</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=c1># acceleratorですべてを準備</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=n>model</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>train_dataloader</span><span class=p>,</span> <span class=n>eval_dataloader</span><span class=p>,</span> <span class=n>lr_scheduler</span> <span class=o>=</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>prepare</span><span class=p>(</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>    <span class=n>model</span><span class=p>,</span> <span class=n>optimizer</span><span class=p>,</span> <span class=n>train_dataloader</span><span class=p>,</span> <span class=n>eval_dataloader</span><span class=p>,</span> <span class=n>lr_scheduler</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;デバイス: </span><span class=si>{</span><span class=n>accelerator</span><span class=o>.</span><span class=n>device</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;学習ステップ数: </span><span class=si>{</span><span class=n>num_training_steps</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ウォームアップステップ数: </span><span class=si>{</span><span class=n>num_warmup_steps</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>Device: mps
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>Training steps: 107670
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>Warmup steps: 1000
</span></code></pre></div></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=kn>from</span><span class=w> </span><span class=nn>tqdm.auto</span><span class=w> </span><span class=kn>import</span> <span class=n>tqdm</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=kn>import</span><span class=w> </span><span class=nn>os</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=c1># 評価関数の定義</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=k>def</span><span class=w> </span><span class=nf>evaluate_model</span><span class=p>():</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a>    <span class=n>rouge_scorer_obj</span> <span class=o>=</span> <span class=n>rouge_scorer</span><span class=o>.</span><span class=n>RougeScorer</span><span class=p>([</span><span class=s1>&#39;rouge1&#39;</span><span class=p>,</span> <span class=s1>&#39;rouge2&#39;</span><span class=p>,</span> <span class=s1>&#39;rougeL&#39;</span><span class=p>],</span> <span class=n>use_stemmer</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a>    <span class=n>all_predictions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>    <span class=n>all_references</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a>    <span class=n>eval_loss</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a>    <span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=n>eval_dataloader</span><span class=p>,</span> <span class=n>desc</span><span class=o>=</span><span class=s2>&quot;評価中&quot;</span><span class=p>):</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a>        <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a>            <span class=c1># 損失を計算</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a>            <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a>            <span class=n>eval_loss</span> <span class=o>+=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a>            <span class=c1># 予測を生成</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a>            <span class=n>generated_tokens</span> <span class=o>=</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>unwrap_model</span><span class=p>(</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a>                <span class=n>input_ids</span><span class=o>=</span><span class=n>batch</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>],</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a>                <span class=n>attention_mask</span><span class=o>=</span><span class=n>batch</span><span class=p>[</span><span class=s2>&quot;attention_mask&quot;</span><span class=p>],</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a>                <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a>                <span class=n>num_beams</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a>                <span class=n>early_stopping</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a>            <span class=p>)</span>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a>            <span class=c1># 予測と参照をデコード</span>
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29 href=#__codelineno-23-29></a>            <span class=n>predictions</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>batch_decode</span><span class=p>(</span><span class=n>generated_tokens</span><span class=p>,</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30 href=#__codelineno-23-30></a>            <span class=n>labels</span> <span class=o>=</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&quot;labels&quot;</span><span class=p>]</span>
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31 href=#__codelineno-23-31></a>            <span class=n>labels</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>labels</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>100</span><span class=p>,</span> <span class=n>labels</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>pad_token_id</span><span class=p>)</span>
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32 href=#__codelineno-23-32></a>            <span class=n>references</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>batch_decode</span><span class=p>(</span><span class=n>labels</span><span class=p>,</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33 href=#__codelineno-23-33></a>
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34 href=#__codelineno-23-34></a>            <span class=n>all_predictions</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>predictions</span><span class=p>)</span>
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35 href=#__codelineno-23-35></a>            <span class=n>all_references</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>references</span><span class=p>)</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36 href=#__codelineno-23-36></a>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37 href=#__codelineno-23-37></a>    <span class=c1># ROUGEスコアを計算</span>
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38 href=#__codelineno-23-38></a>    <span class=n>rouge_scores</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39 href=#__codelineno-23-39></a>    <span class=k>for</span> <span class=n>pred</span><span class=p>,</span> <span class=n>ref</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>all_predictions</span><span class=p>,</span> <span class=n>all_references</span><span class=p>):</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40 href=#__codelineno-23-40></a>        <span class=n>scores</span> <span class=o>=</span> <span class=n>rouge_scorer_obj</span><span class=o>.</span><span class=n>score</span><span class=p>(</span><span class=n>ref</span><span class=p>,</span> <span class=n>pred</span><span class=p>)</span>
</span><span id=__span-23-41><a id=__codelineno-23-41 name=__codelineno-23-41 href=#__codelineno-23-41></a>        <span class=n>rouge_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span>
</span><span id=__span-23-42><a id=__codelineno-23-42 name=__codelineno-23-42 href=#__codelineno-23-42></a>
</span><span id=__span-23-43><a id=__codelineno-23-43 name=__codelineno-23-43 href=#__codelineno-23-43></a>    <span class=c1># 平均スコア</span>
</span><span id=__span-23-44><a id=__codelineno-23-44 name=__codelineno-23-44 href=#__codelineno-23-44></a>    <span class=n>rouge_results</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-23-45><a id=__codelineno-23-45 name=__codelineno-23-45 href=#__codelineno-23-45></a>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>,</span> <span class=s1>&#39;rouge2&#39;</span><span class=p>,</span> <span class=s1>&#39;rougeL&#39;</span><span class=p>]:</span>
</span><span id=__span-23-46><a id=__codelineno-23-46 name=__codelineno-23-46 href=#__codelineno-23-46></a>        <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>score</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>fmeasure</span> <span class=k>for</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>rouge_scores</span><span class=p>]</span>
</span><span id=__span-23-47><a id=__codelineno-23-47 name=__codelineno-23-47 href=#__codelineno-23-47></a>        <span class=n>rouge_results</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span><span id=__span-23-48><a id=__codelineno-23-48 name=__codelineno-23-48 href=#__codelineno-23-48></a>
</span><span id=__span-23-49><a id=__codelineno-23-49 name=__codelineno-23-49 href=#__codelineno-23-49></a>    <span class=n>avg_eval_loss</span> <span class=o>=</span> <span class=n>eval_loss</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>eval_dataloader</span><span class=p>)</span>
</span><span id=__span-23-50><a id=__codelineno-23-50 name=__codelineno-23-50 href=#__codelineno-23-50></a>
</span><span id=__span-23-51><a id=__codelineno-23-51 name=__codelineno-23-51 href=#__codelineno-23-51></a>    <span class=k>return</span> <span class=n>avg_eval_loss</span><span class=p>,</span> <span class=n>rouge_results</span>
</span><span id=__span-23-52><a id=__codelineno-23-52 name=__codelineno-23-52 href=#__codelineno-23-52></a>
</span><span id=__span-23-53><a id=__codelineno-23-53 name=__codelineno-23-53 href=#__codelineno-23-53></a><span class=c1># 学習ループ</span>
</span><span id=__span-23-54><a id=__codelineno-23-54 name=__codelineno-23-54 href=#__codelineno-23-54></a><span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span><span id=__span-23-55><a id=__codelineno-23-55 name=__codelineno-23-55 href=#__codelineno-23-55></a><span class=n>progress_bar</span> <span class=o>=</span> <span class=n>tqdm</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>num_training_steps</span><span class=p>),</span> <span class=n>desc</span><span class=o>=</span><span class=s2>&quot;学習中&quot;</span><span class=p>)</span>
</span><span id=__span-23-56><a id=__codelineno-23-56 name=__codelineno-23-56 href=#__codelineno-23-56></a>
</span><span id=__span-23-57><a id=__codelineno-23-57 name=__codelineno-23-57 href=#__codelineno-23-57></a><span class=n>step</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-23-58><a id=__codelineno-23-58 name=__codelineno-23-58 href=#__codelineno-23-58></a><span class=n>best_rouge1</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-23-59><a id=__codelineno-23-59 name=__codelineno-23-59 href=#__codelineno-23-59></a><span class=n>save_dir</span> <span class=o>=</span> <span class=s2>&quot;./t5-small-cnn-accelerate&quot;</span>
</span><span id=__span-23-60><a id=__codelineno-23-60 name=__codelineno-23-60 href=#__codelineno-23-60></a><span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>save_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-23-61><a id=__codelineno-23-61 name=__codelineno-23-61 href=#__codelineno-23-61></a>
</span><span id=__span-23-62><a id=__codelineno-23-62 name=__codelineno-23-62 href=#__codelineno-23-62></a><span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_epochs</span><span class=p>):</span>
</span><span id=__span-23-63><a id=__codelineno-23-63 name=__codelineno-23-63 href=#__codelineno-23-63></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>エポック </span><span class=si>{</span><span class=n>epoch</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>num_epochs</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-64><a id=__codelineno-23-64 name=__codelineno-23-64 href=#__codelineno-23-64></a>
</span><span id=__span-23-65><a id=__codelineno-23-65 name=__codelineno-23-65 href=#__codelineno-23-65></a>    <span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>train_dataloader</span><span class=p>:</span>
</span><span id=__span-23-66><a id=__codelineno-23-66 name=__codelineno-23-66 href=#__codelineno-23-66></a>        <span class=c1># 順伝播</span>
</span><span id=__span-23-67><a id=__codelineno-23-67 name=__codelineno-23-67 href=#__codelineno-23-67></a>        <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-23-68><a id=__codelineno-23-68 name=__codelineno-23-68 href=#__codelineno-23-68></a>        <span class=n>loss</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>loss</span>
</span><span id=__span-23-69><a id=__codelineno-23-69 name=__codelineno-23-69 href=#__codelineno-23-69></a>
</span><span id=__span-23-70><a id=__codelineno-23-70 name=__codelineno-23-70 href=#__codelineno-23-70></a>        <span class=c1># 逆伝播</span>
</span><span id=__span-23-71><a id=__codelineno-23-71 name=__codelineno-23-71 href=#__codelineno-23-71></a>        <span class=n>accelerator</span><span class=o>.</span><span class=n>backward</span><span class=p>(</span><span class=n>loss</span><span class=p>)</span>
</span><span id=__span-23-72><a id=__codelineno-23-72 name=__codelineno-23-72 href=#__codelineno-23-72></a>
</span><span id=__span-23-73><a id=__codelineno-23-73 name=__codelineno-23-73 href=#__codelineno-23-73></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-23-74><a id=__codelineno-23-74 name=__codelineno-23-74 href=#__codelineno-23-74></a>        <span class=n>lr_scheduler</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span><span id=__span-23-75><a id=__codelineno-23-75 name=__codelineno-23-75 href=#__codelineno-23-75></a>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span><span id=__span-23-76><a id=__codelineno-23-76 name=__codelineno-23-76 href=#__codelineno-23-76></a>
</span><span id=__span-23-77><a id=__codelineno-23-77 name=__codelineno-23-77 href=#__codelineno-23-77></a>        <span class=n>progress_bar</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-23-78><a id=__codelineno-23-78 name=__codelineno-23-78 href=#__codelineno-23-78></a>        <span class=n>step</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-23-79><a id=__codelineno-23-79 name=__codelineno-23-79 href=#__codelineno-23-79></a>
</span><span id=__span-23-80><a id=__codelineno-23-80 name=__codelineno-23-80 href=#__codelineno-23-80></a>        <span class=c1># ログ出力</span>
</span><span id=__span-23-81><a id=__codelineno-23-81 name=__codelineno-23-81 href=#__codelineno-23-81></a>        <span class=k>if</span> <span class=n>step</span> <span class=o>%</span> <span class=mi>500</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-23-82><a id=__codelineno-23-82 name=__codelineno-23-82 href=#__codelineno-23-82></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ステップ </span><span class=si>{</span><span class=n>step</span><span class=si>}</span><span class=s2>: 損失 = </span><span class=si>{</span><span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, 学習率 = </span><span class=si>{</span><span class=n>lr_scheduler</span><span class=o>.</span><span class=n>get_last_lr</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.2e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-83><a id=__codelineno-23-83 name=__codelineno-23-83 href=#__codelineno-23-83></a>
</span><span id=__span-23-84><a id=__codelineno-23-84 name=__codelineno-23-84 href=#__codelineno-23-84></a>        <span class=c1># 評価</span>
</span><span id=__span-23-85><a id=__codelineno-23-85 name=__codelineno-23-85 href=#__codelineno-23-85></a>        <span class=k>if</span> <span class=n>step</span> <span class=o>%</span> <span class=mi>1000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-23-86><a id=__codelineno-23-86 name=__codelineno-23-86 href=#__codelineno-23-86></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>ステップ </span><span class=si>{</span><span class=n>step</span><span class=si>}</span><span class=s2>で評価中...&quot;</span><span class=p>)</span>
</span><span id=__span-23-87><a id=__codelineno-23-87 name=__codelineno-23-87 href=#__codelineno-23-87></a>            <span class=n>eval_loss</span><span class=p>,</span> <span class=n>rouge_results</span> <span class=o>=</span> <span class=n>evaluate_model</span><span class=p>()</span>
</span><span id=__span-23-88><a id=__codelineno-23-88 name=__codelineno-23-88 href=#__codelineno-23-88></a>
</span><span id=__span-23-89><a id=__codelineno-23-89 name=__codelineno-23-89 href=#__codelineno-23-89></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;評価損失: </span><span class=si>{</span><span class=n>eval_loss</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-90><a id=__codelineno-23-90 name=__codelineno-23-90 href=#__codelineno-23-90></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-1: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-91><a id=__codelineno-23-91 name=__codelineno-23-91 href=#__codelineno-23-91></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-2: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge2&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-92><a id=__codelineno-23-92 name=__codelineno-23-92 href=#__codelineno-23-92></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-L: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rougeL&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-93><a id=__codelineno-23-93 name=__codelineno-23-93 href=#__codelineno-23-93></a>
</span><span id=__span-23-94><a id=__codelineno-23-94 name=__codelineno-23-94 href=#__codelineno-23-94></a>            <span class=c1># 最良モデルを保存</span>
</span><span id=__span-23-95><a id=__codelineno-23-95 name=__codelineno-23-95 href=#__codelineno-23-95></a>            <span class=k>if</span> <span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>best_rouge1</span><span class=p>:</span>
</span><span id=__span-23-96><a id=__codelineno-23-96 name=__codelineno-23-96 href=#__codelineno-23-96></a>                <span class=n>best_rouge1</span> <span class=o>=</span> <span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>]</span>
</span><span id=__span-23-97><a id=__codelineno-23-97 name=__codelineno-23-97 href=#__codelineno-23-97></a>                <span class=n>accelerator</span><span class=o>.</span><span class=n>wait_for_everyone</span><span class=p>()</span>
</span><span id=__span-23-98><a id=__codelineno-23-98 name=__codelineno-23-98 href=#__codelineno-23-98></a>                <span class=n>unwrapped_model</span> <span class=o>=</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>unwrap_model</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</span><span id=__span-23-99><a id=__codelineno-23-99 name=__codelineno-23-99 href=#__codelineno-23-99></a>                <span class=n>unwrapped_model</span><span class=o>.</span><span class=n>save_pretrained</span><span class=p>(</span>
</span><span id=__span-23-100><a id=__codelineno-23-100 name=__codelineno-23-100 href=#__codelineno-23-100></a>                    <span class=n>save_dir</span><span class=p>,</span> 
</span><span id=__span-23-101><a id=__codelineno-23-101 name=__codelineno-23-101 href=#__codelineno-23-101></a>                    <span class=n>is_main_process</span><span class=o>=</span><span class=n>accelerator</span><span class=o>.</span><span class=n>is_main_process</span><span class=p>,</span>
</span><span id=__span-23-102><a id=__codelineno-23-102 name=__codelineno-23-102 href=#__codelineno-23-102></a>                    <span class=n>save_function</span><span class=o>=</span><span class=n>accelerator</span><span class=o>.</span><span class=n>save</span>
</span><span id=__span-23-103><a id=__codelineno-23-103 name=__codelineno-23-103 href=#__codelineno-23-103></a>                <span class=p>)</span>
</span><span id=__span-23-104><a id=__codelineno-23-104 name=__codelineno-23-104 href=#__codelineno-23-104></a>                <span class=k>if</span> <span class=n>accelerator</span><span class=o>.</span><span class=n>is_main_process</span><span class=p>:</span>
</span><span id=__span-23-105><a id=__codelineno-23-105 name=__codelineno-23-105 href=#__codelineno-23-105></a>                    <span class=n>tokenizer</span><span class=o>.</span><span class=n>save_pretrained</span><span class=p>(</span><span class=n>save_dir</span><span class=p>)</span>
</span><span id=__span-23-106><a id=__codelineno-23-106 name=__codelineno-23-106 href=#__codelineno-23-106></a>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-1: </span><span class=si>{</span><span class=n>best_rouge1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>で最良モデルを保存しました&quot;</span><span class=p>)</span>
</span><span id=__span-23-107><a id=__codelineno-23-107 name=__codelineno-23-107 href=#__codelineno-23-107></a>
</span><span id=__span-23-108><a id=__codelineno-23-108 name=__codelineno-23-108 href=#__codelineno-23-108></a>            <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span><span id=__span-23-109><a id=__codelineno-23-109 name=__codelineno-23-109 href=#__codelineno-23-109></a>
</span><span id=__span-23-110><a id=__codelineno-23-110 name=__codelineno-23-110 href=#__codelineno-23-110></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>学習完了!&quot;</span><span class=p>)</span>
</span><span id=__span-23-111><a id=__codelineno-23-111 name=__codelineno-23-111 href=#__codelineno-23-111></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;最良ROUGE-1スコア: </span><span class=si>{</span><span class=n>best_rouge1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-112><a id=__codelineno-23-112 name=__codelineno-23-112 href=#__codelineno-23-112></a>
</span><span id=__span-23-113><a id=__codelineno-23-113 name=__codelineno-23-113 href=#__codelineno-23-113></a><span class=c1># 最終評価</span>
</span><span id=__span-23-114><a id=__codelineno-23-114 name=__codelineno-23-114 href=#__codelineno-23-114></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>最終評価...&quot;</span><span class=p>)</span>
</span><span id=__span-23-115><a id=__codelineno-23-115 name=__codelineno-23-115 href=#__codelineno-23-115></a><span class=n>eval_loss</span><span class=p>,</span> <span class=n>rouge_results</span> <span class=o>=</span> <span class=n>evaluate_model</span><span class=p>()</span>
</span><span id=__span-23-116><a id=__codelineno-23-116 name=__codelineno-23-116 href=#__codelineno-23-116></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;最終結果:&quot;</span><span class=p>)</span>
</span><span id=__span-23-117><a id=__codelineno-23-117 name=__codelineno-23-117 href=#__codelineno-23-117></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-1: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge1&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-23-118><a id=__codelineno-23-118 name=__codelineno-23-118 href=#__codelineno-23-118></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-2: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rouge2&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>  
</span><span id=__span-23-119><a id=__codelineno-23-119 name=__codelineno-23-119 href=#__codelineno-23-119></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ROUGE-L: </span><span class=si>{</span><span class=n>rouge_results</span><span class=p>[</span><span class=s1>&#39;rougeL&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> この学習プロセスは数時間かかる可能性があります。実際の実行時には以下のような出力が表示されます：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>エポック 1/3
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>ステップ 500: 損失 = 2.1234, 学習率 = 2.85e-04
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>ステップ 1000で評価中...
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>評価損失: 1.8765
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>ROUGE-1: 28.45
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>ROUGE-2: 9.87
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>ROUGE-L: 25.12
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>ROUGE-1: 28.45で最良モデルを保存しました
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>学習完了!
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>最良ROUGE-1スコア: 32.78
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a>最終評価...
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>最終結果:
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a>ROUGE-1: 32.78
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>ROUGE-2: 12.34
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a>ROUGE-L: 28.91
</span></code></pre></div> <h2 id=_7>学習結果の分析と活用<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <h3 id=rouge>ROUGEスコアの理解<a class=headerlink href=#rouge title="Permanent link">&para;</a></h3> <p><strong>ROUGE（Recall-Oriented Understudy for Gisting Evaluation）</strong>は、テキスト要約の品質を評価するための標準的な指標です：</p> <ul> <li><strong>ROUGE-1</strong>: 単語（1-gram）の重複を測定</li> <li><strong>ROUGE-2</strong>: 2語の組み合わせ（2-gram）の重複を測定 </li> <li><strong>ROUGE-L</strong>: 最長共通部分列（Longest Common Subsequence）を基準とした測定</li> </ul> <p>一般的に、ROUGE-1スコアが30を超えると良好な性能とされ、40を超えると優秀な性能と考えられます。</p> <h3 id=_8>モデルの実際の使用方法<a class=headerlink href=#_8 title="Permanent link">&para;</a></h3> <p>学習済みモデルを使用して新しいテキストを要約する方法：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># 学習済みモデルを読み込み</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=kn>from</span><span class=w> </span><span class=nn>transformers</span><span class=w> </span><span class=kn>import</span> <span class=n>T5ForConditionalGeneration</span><span class=p>,</span> <span class=n>T5Tokenizer</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=n>model_path</span> <span class=o>=</span> <span class=s2>&quot;./t5-small-cnn-accelerate&quot;</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>T5Tokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=n>model</span> <span class=o>=</span> <span class=n>T5ForConditionalGeneration</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=k>def</span><span class=w> </span><span class=nf>generate_summary</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>):</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=sd>    テキストの要約を生成する関数</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=sd>    Args:</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=sd>        text (str): 要約したいテキスト</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=sd>        max_length (int): 要約の最大長</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=sd>    Returns:</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=sd>        str: 生成された要約</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a>    <span class=c1># T5用のプレフィックスを追加</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a>    <span class=n>input_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;summarize: </span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a>    <span class=c1># トークン化</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a>        <span class=n>input_text</span><span class=p>,</span> 
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a>        <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&quot;pt&quot;</span><span class=p>,</span> 
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> 
</span><span id=__span-25-27><a id=__codelineno-25-27 name=__codelineno-25-27 href=#__codelineno-25-27></a>        <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-25-28><a id=__codelineno-25-28 name=__codelineno-25-28 href=#__codelineno-25-28></a>    <span class=p>)</span>
</span><span id=__span-25-29><a id=__codelineno-25-29 name=__codelineno-25-29 href=#__codelineno-25-29></a>
</span><span id=__span-25-30><a id=__codelineno-25-30 name=__codelineno-25-30 href=#__codelineno-25-30></a>    <span class=c1># 要約を生成</span>
</span><span id=__span-25-31><a id=__codelineno-25-31 name=__codelineno-25-31 href=#__codelineno-25-31></a>    <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span><span id=__span-25-32><a id=__codelineno-25-32 name=__codelineno-25-32 href=#__codelineno-25-32></a>        <span class=n>summary_ids</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span><span id=__span-25-33><a id=__codelineno-25-33 name=__codelineno-25-33 href=#__codelineno-25-33></a>            <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>],</span>
</span><span id=__span-25-34><a id=__codelineno-25-34 name=__codelineno-25-34 href=#__codelineno-25-34></a>            <span class=n>attention_mask</span><span class=o>=</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;attention_mask&quot;</span><span class=p>],</span>
</span><span id=__span-25-35><a id=__codelineno-25-35 name=__codelineno-25-35 href=#__codelineno-25-35></a>            <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>,</span>
</span><span id=__span-25-36><a id=__codelineno-25-36 name=__codelineno-25-36 href=#__codelineno-25-36></a>            <span class=n>num_beams</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span><span id=__span-25-37><a id=__codelineno-25-37 name=__codelineno-25-37 href=#__codelineno-25-37></a>            <span class=n>early_stopping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-25-38><a id=__codelineno-25-38 name=__codelineno-25-38 href=#__codelineno-25-38></a>            <span class=n>no_repeat_ngram_size</span><span class=o>=</span><span class=mi>2</span>
</span><span id=__span-25-39><a id=__codelineno-25-39 name=__codelineno-25-39 href=#__codelineno-25-39></a>        <span class=p>)</span>
</span><span id=__span-25-40><a id=__codelineno-25-40 name=__codelineno-25-40 href=#__codelineno-25-40></a>
</span><span id=__span-25-41><a id=__codelineno-25-41 name=__codelineno-25-41 href=#__codelineno-25-41></a>    <span class=c1># デコードして返す</span>
</span><span id=__span-25-42><a id=__codelineno-25-42 name=__codelineno-25-42 href=#__codelineno-25-42></a>    <span class=n>summary</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>summary_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-25-43><a id=__codelineno-25-43 name=__codelineno-25-43 href=#__codelineno-25-43></a>    <span class=k>return</span> <span class=n>summary</span>
</span><span id=__span-25-44><a id=__codelineno-25-44 name=__codelineno-25-44 href=#__codelineno-25-44></a>
</span><span id=__span-25-45><a id=__codelineno-25-45 name=__codelineno-25-45 href=#__codelineno-25-45></a><span class=c1># 使用例</span>
</span><span id=__span-25-46><a id=__codelineno-25-46 name=__codelineno-25-46 href=#__codelineno-25-46></a><span class=n>sample_text</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-25-47><a id=__codelineno-25-47 name=__codelineno-25-47 href=#__codelineno-25-47></a><span class=s2>人工知能（AI）の発展は、私たちの生活に大きな変化をもたらしています。</span>
</span><span id=__span-25-48><a id=__codelineno-25-48 name=__codelineno-25-48 href=#__codelineno-25-48></a><span class=s2>機械学習、特に深層学習の技術により、画像認識、音声認識、自然言語処理</span>
</span><span id=__span-25-49><a id=__codelineno-25-49 name=__codelineno-25-49 href=#__codelineno-25-49></a><span class=s2>などの分野で画期的な進歩が見られています。医療分野では、AIが診断支援や</span>
</span><span id=__span-25-50><a id=__codelineno-25-50 name=__codelineno-25-50 href=#__codelineno-25-50></a><span class=s2>薬物発見に活用され、教育分野では個別学習システムが開発されています。</span>
</span><span id=__span-25-51><a id=__codelineno-25-51 name=__codelineno-25-51 href=#__codelineno-25-51></a><span class=s2>しかし、AIの普及に伴い、雇用への影響やプライバシーの問題など、</span>
</span><span id=__span-25-52><a id=__codelineno-25-52 name=__codelineno-25-52 href=#__codelineno-25-52></a><span class=s2>社会的な課題も浮上しています。これらの課題に対処しながら、</span>
</span><span id=__span-25-53><a id=__codelineno-25-53 name=__codelineno-25-53 href=#__codelineno-25-53></a><span class=s2>AIの恩恵を最大化することが重要です。</span>
</span><span id=__span-25-54><a id=__codelineno-25-54 name=__codelineno-25-54 href=#__codelineno-25-54></a><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-25-55><a id=__codelineno-25-55 name=__codelineno-25-55 href=#__codelineno-25-55></a>
</span><span id=__span-25-56><a id=__codelineno-25-56 name=__codelineno-25-56 href=#__codelineno-25-56></a><span class=n>summary</span> <span class=o>=</span> <span class=n>generate_summary</span><span class=p>(</span><span class=n>sample_text</span><span class=p>)</span>
</span><span id=__span-25-57><a id=__codelineno-25-57 name=__codelineno-25-57 href=#__codelineno-25-57></a><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;生成された要約:&quot;</span><span class=p>)</span>
</span><span id=__span-25-58><a id=__codelineno-25-58 name=__codelineno-25-58 href=#__codelineno-25-58></a><span class=nb>print</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span>
</span></code></pre></div> <p><strong>実行結果:</strong> <div class="language-text highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>生成された要約:
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>人工知能の発展により画像認識や音声認識が進歩し、医療や教育分野で活用されているが、雇用やプライバシーの課題もある。
</span></code></pre></div></p> <h2 id=_9>性能向上のための追加技術<a class=headerlink href=#_9 title="Permanent link">&para;</a></h2> <h3 id=_10>ビームサーチの最適化<a class=headerlink href=#_10 title="Permanent link">&para;</a></h3> <p>ビームサーチのパラメータを調整することで、要約の品質を向上させることができます：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>def</span><span class=w> </span><span class=nf>advanced_generate_summary</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>num_beams</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>):</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=sd>    高度な生成パラメータを使用した要約生成</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>    <span class=n>input_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;summarize: </span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>input_text</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&quot;pt&quot;</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>    <span class=n>summary_ids</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>        <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>],</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>        <span class=n>attention_mask</span><span class=o>=</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;attention_mask&quot;</span><span class=p>],</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>        <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>,</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a>        <span class=n>min_length</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a>        <span class=n>num_beams</span><span class=o>=</span><span class=n>num_beams</span><span class=p>,</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a>        <span class=n>temperature</span><span class=o>=</span><span class=n>temperature</span><span class=p>,</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>        <span class=n>do_sample</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>        <span class=n>early_stopping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a>        <span class=n>no_repeat_ngram_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a>        <span class=n>repetition_penalty</span><span class=o>=</span><span class=mf>1.2</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a>    <span class=p>)</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a>    <span class=k>return</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>summary_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> <h3 id=_11>長文処理の改善<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>非常に長い文書を処理する場合の戦略：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>def</span><span class=w> </span><span class=nf>summarize_long_document</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>chunk_size</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span> <span class=n>overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>):</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=sd>    長い文書を分割して要約する関数</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=sd>    Args:</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=sd>        text (str): 長い文書</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=sd>        chunk_size (int): チャンクサイズ（単語数）</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=sd>        overlap (int): チャンク間のオーバーラップ（単語数）</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>    <span class=n>words</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>    <span class=n>chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>    <span class=c1># 文書を重複ありでチャンクに分割</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>words</span><span class=p>),</span> <span class=n>chunk_size</span> <span class=o>-</span> <span class=n>overlap</span><span class=p>):</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a>        <span class=n>chunk</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>chunk_size</span><span class=p>])</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a>        <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>chunk</span><span class=p>)</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a>    <span class=c1># 各チャンクを要約</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a>    <span class=n>chunk_summaries</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>    <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>chunks</span><span class=p>:</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a>        <span class=n>summary</span> <span class=o>=</span> <span class=n>generate_summary</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>64</span><span class=p>)</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a>        <span class=n>chunk_summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a>    <span class=c1># チャンク要約を結合して最終要約を生成</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a>    <span class=n>combined_summary</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>chunk_summaries</span><span class=p>)</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a>    <span class=n>final_summary</span> <span class=o>=</span> <span class=n>generate_summary</span><span class=p>(</span><span class=n>combined_summary</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>128</span><span class=p>)</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a>    <span class=k>return</span> <span class=n>final_summary</span>
</span></code></pre></div> <h2 id=_12>実用的な活用例<a class=headerlink href=#_12 title="Permanent link">&para;</a></h2> <h3 id=_13>ニュース記事の自動要約システム<a class=headerlink href=#_13 title="Permanent link">&para;</a></h3> <div class="language-python highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=kn>import</span><span class=w> </span><span class=nn>requests</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=k>class</span><span class=w> </span><span class=nc>NewsSummarizationSystem</span><span class=p>:</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;ニュース記事自動要約システム&quot;&quot;&quot;</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_path</span><span class=p>):</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>T5Tokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>T5ForConditionalGeneration</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>    <span class=k>def</span><span class=w> </span><span class=nf>summarize_article</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>article_text</span><span class=p>,</span> <span class=n>target_length</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;記事を指定された長さで要約&quot;&quot;&quot;</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>        <span class=k>return</span> <span class=n>generate_summary</span><span class=p>(</span><span class=n>article_text</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=n>target_length</span><span class=p>)</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>    <span class=k>def</span><span class=w> </span><span class=nf>batch_summarize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>articles</span><span class=p>):</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;複数記事の一括要約&quot;&quot;&quot;</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>        <span class=n>summaries</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>        <span class=k>for</span> <span class=n>article</span> <span class=ow>in</span> <span class=n>articles</span><span class=p>:</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a>                <span class=n>summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>summarize_article</span><span class=p>(</span><span class=n>article</span><span class=p>)</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a>                <span class=n>summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a>                <span class=n>summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;要約エラー: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a>        <span class=k>return</span> <span class=n>summaries</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a>    <span class=k>def</span><span class=w> </span><span class=nf>export_summaries</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>articles</span><span class=p>,</span> <span class=n>summaries</span><span class=p>,</span> <span class=n>filename</span><span class=p>):</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;要約結果をファイルに出力&quot;&quot;&quot;</span>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;要約レポート - </span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M&#39;</span><span class=p>)</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>article</span><span class=p>,</span> <span class=n>summary</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>articles</span><span class=p>,</span> <span class=n>summaries</span><span class=p>)):</span>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;記事 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-32><a id=__codelineno-29-32 name=__codelineno-29-32 href=#__codelineno-29-32></a>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;要約: </span><span class=si>{</span><span class=n>summary</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-33><a id=__codelineno-29-33 name=__codelineno-29-33 href=#__codelineno-29-33></a>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;元記事の長さ: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>article</span><span class=o>.</span><span class=n>split</span><span class=p>())</span><span class=si>}</span><span class=s2> 語</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-34><a id=__codelineno-29-34 name=__codelineno-29-34 href=#__codelineno-29-34></a>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>50</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-29-35><a id=__codelineno-29-35 name=__codelineno-29-35 href=#__codelineno-29-35></a>
</span><span id=__span-29-36><a id=__codelineno-29-36 name=__codelineno-29-36 href=#__codelineno-29-36></a><span class=c1># 使用例</span>
</span><span id=__span-29-37><a id=__codelineno-29-37 name=__codelineno-29-37 href=#__codelineno-29-37></a><span class=n>summarizer</span> <span class=o>=</span> <span class=n>NewsSummarizationSystem</span><span class=p>(</span><span class=s2>&quot;./t5-small-cnn-accelerate&quot;</span><span class=p>)</span>
</span></code></pre></div> <h2 id=_14>まとめ<a class=headerlink href=#_14 title="Permanent link">&para;</a></h2> <p>テキスト要約は、情報過多の現代において非常に価値の高い技術です。適切に実装されたシステムは、大量の文書を効率的に処理し、重要な情報を抽出する強力なツールとなります。</p> <h2 id=_15>参考資料<a class=headerlink href=#_15 title="Permanent link">&para;</a></h2> <ul> <li><strong>Hugging Face Transformers Documentation</strong>: <a href=https://huggingface.co/docs/transformers>https://huggingface.co/docs/transformers</a></li> <li><strong>T5 Paper</strong>: "Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer"</li> <li><strong>ROUGE評価指標</strong>: Lin, Chin-Yew. "ROUGE: A Package for Automatic Evaluation of Summaries"</li> <li><strong>CNN/DailyMail Dataset</strong>: <a href=https://huggingface.co/datasets/abisee/cnn_dailymail>https://huggingface.co/datasets/abisee/cnn_dailymail</a></li> <li><strong>PyTorch Lightning Documentation</strong>: <a href=https://pytorch-lightning.readthedocs.io/ >https://pytorch-lightning.readthedocs.io/</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最終更新日> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年9月28日 19:08:34 JST">2025年9月28日 19:08:34</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> ページトップへ戻る </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 - 2025 vinsmoke-three </div> </div> <div class=md-social> <a href=https://github.com/vinsmoke-three target=_blank rel=noopener title=GitHub class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.copy", "navigation.expand", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": {"BERT": "bert", "CNN": "convolutional-neural-network", "FashionMNIST": "fashion-mnist", "GPT": "gpt", "LLM": "large-language-model", "ML\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3": "ml-pipeline", "NLP": "nlp", "PyTorch": "pytorch", "Python": "python", "TensorBoard": "tensorboard", "TinyVGG": "tinyvgg", "Transformer": "transformer", "\u30ab\u30b9\u30bf\u30e0\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8": "custom-datasets", "\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30d3\u30b8\u30e7\u30f3": "computer-vision", "\u30b9\u30af\u30ea\u30d7\u30c8\u30e2\u30fc\u30c9": "script-mode", "\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb": "tutorial", "\u30c6\u30f3\u30bd\u30eb": "tensor", "\u30c7\u30fc\u30bf\u62e1\u5f35": "data-augmentation", "\u30cb\u30e5\u30fc\u30e9\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af": "neural-network", "\u30e2\u30b8\u30e5\u30fc\u30eb\u5316": "modularization", "\u30ef\u30fc\u30af\u30d5\u30ed\u30fc": "workflow", "\u4e0a\u7d1a\u8005\u5411\u3051": "advanced", "\u4e2d\u7d1a\u8005\u5411\u3051": "intermediate", "\u518d\u5229\u7528": "reusability", "\u5206\u985e": "classification", "\u521d\u5fc3\u8005\u5411\u3051": "beginner", "\u5927\u898f\u6a21\u8a00\u8a9e\u30e2\u30c7\u30eb": "large-language-model", "\u5b9f\u8df5": "practical", "\u5b9f\u9a13\u8ffd\u8de1": "experiment-tracking", "\u6a5f\u68b0\u5b66\u7fd2": "machine-learning", "\u6df1\u5c64\u5b66\u7fd2": "deep-learning", "\u753b\u50cf\u5206\u985e": "image-classification", "\u7dda\u5f62\u56de\u5e30": "linear-regression", "\u81ea\u7136\u8a00\u8a9e\u51e6\u7406": "natural-language-processing", "\u8ee2\u79fb\u5b66\u7fd2": "transfer-learning"}, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src=../../../javascripts/meta.js></script> <script src=../../../javascripts/structured-data.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>